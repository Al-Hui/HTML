<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>AI Running Coach</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background-color: #f3f4f6; 
            /* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ "—á–µ–ª–∫–∏" –∞–π—Ñ–æ–Ω–∞ */
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .tab-content { display: none; opacity: 0; transition: opacity 0.2s; }
        .tab-content.active { display: block; opacity: 1; }
        .nav-item.active { color: #2563eb; transform: scale(1.05); }
        .nav-item { transition: all 0.2s; }
        
        /* –ê–Ω–∏–º–∞—Ü–∏—è —Ç–æ—á–µ–∫ –ø—Ä–∏ –Ω–∞–±–æ—Ä–µ —Ç–µ–∫—Å—Ç–∞ */
        .typing-dot { animation: typing 1.4s infinite ease-in-out both; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden bg-gray-50">

    <header class="bg-white shadow-sm px-4 py-3 text-center z-10 flex justify-between items-center shrink-0">
        <div class="w-6"></div> <h1 class="text-lg font-bold text-gray-800 tracking-tight">üèÉ‚Äç‚ôÇÔ∏è AI Coach</h1>
        <div class="w-6 text-xs text-gray-400" id="status-indicator">‚óè</div>
    </header>

    <main class="flex-1 overflow-y-auto no-scrollbar p-4 pb-28 relative w-full max-w-md mx-auto" id="main-container">
        
        <div id="tab-chat" class="tab-content active h-full flex flex-col">
            <div id="chat-messages" class="flex-1 space-y-4 mb-2">
                <div class="flex items-start">
                    <div class="bg-white text-gray-800 p-3 rounded-2xl rounded-tl-none border border-gray-100 shadow-sm max-w-[85%] text-sm">
                        –ü—Ä–∏–≤–µ—Ç! –Ø —Ç–≤–æ–π —Ç—Ä–µ–Ω–µ—Ä –Ω–∞ –±–∞–∑–µ DeepSeek. –ì–æ—Ç–æ–≤ —Ä–∞–∑–æ–±—Ä–∞—Ç—å —Ç–≤–æ—é —Ç–µ—Ö–Ω–∏–∫—É –∏–ª–∏ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ. –í–≤–µ–¥–∏ —Å–≤–æ–π API –∫–ª—é—á –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö, –∏ –ø–æ–≥–Ω–∞–ª–∏! üöÄ
                    </div>
                </div>
            </div>
        </div>

        <div id="tab-log" class="tab-content space-y-4">
            <div class="bg-white p-5 rounded-2xl shadow-sm">
                <h2 class="font-bold mb-4 text-gray-800 text-lg">–ó–∞–ø–∏—Å–∞—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É</h2>
                <div class="space-y-3">
                    <div class="flex gap-3">
                        <div class="w-1/2">
                            <label class="text-xs text-gray-500 ml-1">–î–∞—Ç–∞</label>
                            <input type="date" id="run-date" class="bg-gray-50 border-0 text-gray-800 p-3 rounded-xl w-full focus:ring-2 ring-blue-500 outline-none">
                        </div>
                        <div class="w-1/2">
                            <label class="text-xs text-gray-500 ml-1">–î–∏—Å—Ç–∞–Ω—Ü–∏—è (–∫–º)</label>
                            <input type="number" id="run-dist" placeholder="0.0" step="0.1" class="bg-gray-50 border-0 text-gray-800 p-3 rounded-xl w-full focus:ring-2 ring-blue-500 outline-none">
                        </div>
                    </div>
                    <div class="flex gap-3">
                        <div class="w-1/2">
                            <label class="text-xs text-gray-500 ml-1">–í—Ä–µ–º—è</label>
                            <input type="text" id="run-time" placeholder="–º–º:—Å—Å" class="bg-gray-50 border-0 text-gray-800 p-3 rounded-xl w-full focus:ring-2 ring-blue-500 outline-none">
                        </div>
                        <div class="w-1/2">
                            <label class="text-xs text-gray-500 ml-1">–ü—É–ª—å—Å</label>
                            <input type="number" id="run-hr" placeholder="—É–¥/–º–∏–Ω" class="bg-gray-50 border-0 text-gray-800 p-3 rounded-xl w-full focus:ring-2 ring-blue-500 outline-none">
                        </div>
                    </div>
                    <button onclick="saveRun()" class="w-full bg-blue-600 active:bg-blue-700 text-white py-3.5 rounded-xl font-bold text-sm shadow-md shadow-blue-200 transition-all mt-2">
                        –î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å
                    </button>
                </div>
            </div>

            <h3 class="font-bold text-gray-400 text-xs uppercase ml-1">–ò—Å—Ç–æ—Ä–∏—è</h3>
            <div id="run-history" class="space-y-2 pb-4">
                </div>
        </div>

        <div id="tab-stats" class="tab-content space-y-4">
            <div class="grid grid-cols-2 gap-3">
                <div class="bg-white p-4 rounded-2xl shadow-sm">
                    <h3 class="text-gray-400 text-[10px] uppercase font-bold tracking-wider">–í—Å–µ–≥–æ –ø—Ä–æ–±–µ–∂–∞–ª</h3>
                    <p class="text-2xl font-black text-gray-800 mt-1"><span id="total-km">0</span> <span class="text-sm font-normal text-gray-500">–∫–º</span></p>
                </div>
                <div class="bg-white p-4 rounded-2xl shadow-sm">
                    <h3 class="text-gray-400 text-[10px] uppercase font-bold tracking-wider">–¢—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</h3>
                    <p class="text-2xl font-black text-gray-800 mt-1" id="total-runs">0</p>
                </div>
            </div>
            
            <div class="bg-white p-4 rounded-2xl shadow-sm h-64">
                <canvas id="distanceChart"></canvas>
            </div>

            <button onclick="askCoachAboutStats()" class="w-full bg-gradient-to-r from-emerald-500 to-teal-600 text-white py-4 rounded-xl font-bold shadow-lg shadow-emerald-100 flex items-center justify-center gap-2 active:scale-95 transition-transform">
                <i class="fas fa-magic"></i> –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ (AI)
            </button>
        </div>

        <div id="tab-settings" class="tab-content space-y-4">
            <div class="bg-white p-5 rounded-2xl shadow-sm">
                <h2 class="font-bold mb-2 text-gray-800">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ DeepSeek</h2>
                <p class="text-xs text-gray-500 mb-3 leading-relaxed">
                    –ö–ª—é—á API –Ω—É–∂–µ–Ω –¥–ª—è –æ–±—â–µ–Ω–∏—è —Å —Ç—Ä–µ–Ω–µ—Ä–æ–º. –ü–æ–ª—É—á–∏—Ç–µ –µ–≥–æ –Ω–∞ platform.deepseek.com.
                    –ö–ª—é—á —Ö—Ä–∞–Ω–∏—Ç—Å—è <strong>—Ç–æ–ª—å–∫–æ</strong> –Ω–∞ —ç—Ç–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ.
                </p>
                <input type="password" id="api-key" placeholder="sk-..." class="bg-gray-50 border border-gray-200 text-gray-800 p-3 rounded-xl w-full focus:border-blue-500 outline-none mb-4 transition-colors">
                
                <button onclick="saveApiKey()" class="w-full bg-gray-900 text-white py-3 rounded-xl font-medium text-sm">
                    –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–ª—é—á
                </button>
            </div>
            
            <div class="px-4">
                <button onclick="clearData()" class="text-red-500 text-xs w-full text-center py-4">
                    –°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ
                </button>
            </div>
        </div>

    </main>

    <div id="input-area" class="fixed bottom-[80px] left-0 right-0 px-3 z-20 max-w-md mx-auto hidden">
        <div class="bg-white/90 backdrop-blur-md p-2 rounded-[2rem] shadow-[0_4px_20px_rgba(0,0,0,0.1)] border border-gray-100 flex gap-2 items-center pl-4 pr-2">
            <input type="text" id="user-input" placeholder="–°–ø—Ä–æ—Å–∏ —Ç—Ä–µ–Ω–µ—Ä–∞..." class="flex-1 bg-transparent text-gray-800 placeholder-gray-400 focus:outline-none py-3 text-base">
            <button onclick="sendMessage()" class="bg-blue-600 hover:bg-blue-700 text-white w-10 h-10 rounded-full flex items-center justify-center shadow-md transition-colors shrink-0">
                <i class="fas fa-arrow-up text-sm"></i>
            </button>
        </div>
    </div>

    <nav class="fixed bottom-0 left-0 right-0 bg-white/95 backdrop-blur-md border-t border-gray-100 pb-safe pt-1 px-2 h-[80px] flex justify-around items-start z-30">
        <button onclick="switchTab('chat')" class="nav-item active w-16 py-2 flex flex-col items-center gap-1 text-gray-400">
            <i class="fas fa-comment-dots text-xl"></i>
            <span class="text-[10px] font-medium">–ß–∞—Ç</span>
        </button>
        <button onclick="switchTab('log')" class="nav-item w-16 py-2 flex flex-col items-center gap-1 text-gray-400">
            <i class="fas fa-clipboard-list text-xl"></i>
            <span class="text-[10px] font-medium">–î–Ω–µ–≤–Ω–∏–∫</span>
        </button>
        <button onclick="switchTab('stats')" class="nav-item w-16 py-2 flex flex-col items-center gap-1 text-gray-400">
            <i class="fas fa-chart-pie text-xl"></i>
            <span class="text-[10px] font-medium">–ò–Ω—Ñ–æ</span>
        </button>
        <button onclick="switchTab('settings')" class="nav-item w-16 py-2 flex flex-col items-center gap-1 text-gray-400">
            <i class="fas fa-sliders-h text-xl"></i>
            <span class="text-[10px] font-medium">–ö–ª—é—á</span>
        </button>
    </nav>

    <script>
        // --- –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ---
        // –ò–°–ü–û–õ–¨–ó–£–ï–ú –ü–†–û–ö–°–ò –î–õ–Ø –û–ë–•–û–î–ê –ë–õ–û–ö–ò–†–û–í–ö–ò CORS
        const PROXY = 'https://corsproxy.io/?'; 
        const API_ENDPOINT = 'https://api.deepseek.com/chat/completions';
        
        let apiKey = localStorage.getItem('deepseek_key') || '';
        let runs = JSON.parse(localStorage.getItem('run_history')) || [];
        // –°—Ç–∞—Ä—Ç–æ–≤—ã–π –ø—Ä–æ–º–ø—Ç
        const SYSTEM_PROMPT = "–¢—ã –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ç—Ä–µ–Ω–µ—Ä –ø–æ –±–µ–≥—É. –¢—ã –∫—Ä–∞—Ç–∫–æ, –Ω–æ –µ–º–∫–æ –æ—Ç–≤–µ—á–∞–µ—à—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –ª—é–±–∏—Ç–µ–ª–µ–π. –¢—ã –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—à—å –∏—Ö –¥–∞–Ω–Ω—ã–µ. –¢–≤–æ–π —Ç–æ–Ω: –ø–æ–∑–∏—Ç–∏–≤–Ω—ã–π, –º–æ—Ç–∏–≤–∏—Ä—É—é—â–∏–π. –ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏.";
        
        let messages = JSON.parse(localStorage.getItem('chat_history')) || [
            {role: "system", content: SYSTEM_PROMPT}
        ];

        // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ---
        document.getElementById('api-key').value = apiKey;
        document.getElementById('run-date').valueAsDate = new Date();
        renderRuns();
        if(messages.length > 1) renderMessages(true);
        switchTab('chat');
        updateStatus();

        // --- –§–£–ù–ö–¶–ò–ò –ò–ù–¢–ï–†–§–ï–ô–°–ê ---
        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById('tab-' + tabId).classList.add('active');
            
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            // –ù–∞–π—Ç–∏ –∫–Ω–æ–ø–∫—É, –∫–æ—Ç–æ—Ä–∞—è –≤—ã–∑–≤–∞–ª–∞ —Ñ—É–Ω–∫—Ü–∏—é, –∏–ª–∏ –ø–æ–¥—Å–≤–µ—Ç–∏—Ç—å –ø–æ ID
            // –£–ø—Ä–æ—â–µ–Ω–∏–µ: –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∞ –∫–ª–∞—Å—Å–æ–≤ –ø–æ –∏–Ω–¥–µ–∫—Å—É –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ —Ö–∞—Ä–¥–∫–æ–¥ –ª–æ–≥–∏–∫–∏ –≤—ã—à–µ –Ω–µ –Ω—É–∂–µ–Ω, –µ—Å–ª–∏ –∫–ª–∏–∫–∞–µ–º
            const btn = document.querySelector(`button[onclick="switchTab('${tabId}')"]`);
            if(btn) btn.classList.add('active');

            const inputArea = document.getElementById('input-area');
            if(tabId === 'chat') {
                inputArea.classList.remove('hidden');
                setTimeout(scrollToBottom, 100);
            } else {
                inputArea.classList.add('hidden');
                if(tabId === 'stats') renderChart();
            }
        }

        function updateStatus() {
            const ind = document.getElementById('status-indicator');
            ind.style.color = apiKey ? '#10b981' : '#ef4444'; // –ó–µ–ª–µ–Ω—ã–π –µ—Å–ª–∏ –µ—Å—Ç—å –∫–ª—é—á, –∫—Ä–∞—Å–Ω—ã–π –µ—Å–ª–∏ –Ω–µ—Ç
        }

        // --- –ß–ê–¢ (–° –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ú API –ó–ê–ü–†–û–°–û–ú) ---
        function renderMessages(isHistory = false) {
            const container = document.getElementById('chat-messages');
            if(!isHistory) container.innerHTML = '';
            
            messages.forEach(msg => {
                if(msg.role === 'system') return;
                appendMessageUI(msg.role, msg.content, false);
            });
            scrollToBottom();
        }

        function appendMessageUI(role, text, animate = true) {
            const container = document.getElementById('chat-messages');
            const wrapper = document.createElement('div');
            wrapper.className = `flex ${role === 'user' ? 'justify-end' : 'items-start'} animate-fade-in`;
            
            const bubble = document.createElement('div');
            const baseClass = "p-3.5 px-4 rounded-2xl text-[15px] shadow-sm max-w-[85%] leading-relaxed ";
            
            if (role === 'user') {
                bubble.className = baseClass + "bg-blue-600 text-white rounded-br-sm";
            } else if (role === 'error') {
                bubble.className = baseClass + "bg-red-50 text-red-800 border border-red-200 rounded-bl-sm";
            } else {
                bubble.className = baseClass + "bg-white text-gray-800 border border-gray-100 rounded-bl-sm";
            }
            
            // Markdown-style simple formatting
            let formattedText = text.replace(/\n/g, '<br>');
            formattedText = formattedText.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>'); // Bold support
            
            bubble.innerHTML = formattedText;
            wrapper.appendChild(bubble);
            container.appendChild(wrapper);
            
            if(animate) scrollToBottom();
        }

        function scrollToBottom() {
            const main = document.getElementById('main-container');
            main.scrollTo({ top: main.scrollHeight, behavior: 'smooth' });
        }

        async function sendMessage() {
            if (!apiKey) { 
                alert('üîë –°–Ω–∞—á–∞–ª–∞ –≤–≤–µ–¥–∏—Ç–µ API Key –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö!'); 
                switchTab('settings'); 
                return; 
            }
            
            const input = document.getElementById('user-input');
            const text = input.value.trim();
            if (!text) return;

            // 1. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            appendMessageUI('user', text);
            input.value = '';
            messages.push({role: "user", content: text});

            // 2. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –∑–∞–≥—Ä—É–∑–∫–∏
            const loadingId = 'loading-' + Date.now();
            const loadingDiv = document.createElement('div');
            loadingDiv.id = loadingId;
            loadingDiv.className = 'flex items-start';
            loadingDiv.innerHTML = `<div class="bg-white p-4 rounded-2xl rounded-bl-sm border border-gray-100 shadow-sm flex gap-1.5"><div class="w-2 h-2 bg-gray-400 rounded-full typing-dot"></div><div class="w-2 h-2 bg-gray-400 rounded-full typing-dot"></div><div class="w-2 h-2 bg-gray-400 rounded-full typing-dot"></div></div>`;
            document.getElementById('chat-messages').appendChild(loadingDiv);
            scrollToBottom();

            // 3. –û–¢–ü–†–ê–í–ö–ê –ó–ê–ü–†–û–°–ê (–ß–ï–†–ï–ó –ü–†–û–ö–°–ò)
            try {
                // –ö–æ–¥–∏—Ä—É–µ–º URL DeepSeek –¥–ª—è –ø—Ä–æ–∫—Å–∏
                const targetUrl = encodeURIComponent(API_ENDPOINT);
                const finalUrl = PROXY + targetUrl;

                const response = await fetch(finalUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`,
                        // –í–∞–∂–Ω—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ –¥–ª—è –ø—Ä–æ–∫—Å–∏, –∏–Ω–æ–≥–¥–∞ —Ç—Ä–µ–±—É—é—Ç—Å—è
                        'x-requested-with': 'XMLHttpRequest' 
                    },
                    body: JSON.stringify({
                        model: "deepseek-chat", // V3
                        messages: messages,
                        temperature: 0.7,
                        max_tokens: 1000
                    })
                });

                document.getElementById(loadingId).remove();

                const data = await response.json();

                // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ API (–Ω–∞–ø—Ä–∏–º–µ—Ä, –Ω–µ–≤–µ—Ä–Ω—ã–π –∫–ª—é—á –∏–ª–∏ –±–∞–ª–∞–Ω—Å)
                if (data.error) {
                    throw new Error(`–û—à–∏–±–∫–∞ API (${data.error.code}): ${data.error.message}`);
                }

                if (!data.choices || data.choices.length === 0) {
                    throw new Error('–ü—Ä–∏—à–µ–ª –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞.');
                }

                const aiText = data.choices[0].message.content;
                appendMessageUI('assistant', aiText);
                messages.push({role: "assistant", content: aiText});
                localStorage.setItem('chat_history', JSON.stringify(messages));

            } catch (error) {
                if(document.getElementById(loadingId)) document.getElementById(loadingId).remove();
                
                console.error(error);
                const errorMsg = `‚ö†Ô∏è <strong>–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç:</strong><br>${error.message}<br><br>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –±–∞–ª–∞–Ω—Å –∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –∫–ª—é—á–∞.`;
                appendMessageUI('error', errorMsg);
            }
        }

        // --- –î–ù–ï–í–ù–ò–ö –ò –ê–ù–ê–õ–ò–¢–ò–ö–ê ---
        function saveRun() {
            const date = document.getElementById('run-date').value;
            const dist = parseFloat(document.getElementById('run-dist').value);
            const time = document.getElementById('run-time').value;
            const hr = document.getElementById('run-hr').value;
            
            if(!date || !dist) { alert('–£–∫–∞–∂–∏—Ç–µ —Ö–æ—Ç—è –±—ã –¥–∞—Ç—É –∏ –∫–∏–ª–æ–º–µ—Ç—Ä–∞–∂'); return; }

            const newRun = { id: Date.now(), date, dist, time, hr };
            runs.unshift(newRun); 
            localStorage.setItem('run_history', JSON.stringify(runs));
            
            // –°–±—Ä–æ—Å –ø–æ–ª–µ–π
            document.getElementById('run-dist').value = '';
            document.getElementById('run-time').value = '';
            document.getElementById('run-hr').value = '';
            
            renderRuns();
            switchTab('log'); // –ü–µ—Ä–µ–π—Ç–∏ –∫ —Å–ø–∏—Å–∫—É
        }

        function renderRuns() {
            const container = document.getElementById('run-history');
            container.innerHTML = '';
            let total = 0;

            if(runs.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-400 py-10 text-sm">–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π. –î–æ–±–∞–≤—å –ø–µ—Ä–≤—É—é –ø—Ä–æ–±–µ–∂–∫—É!</div>';
            }

            runs.forEach(run => {
                total += run.dist;
                const div = document.createElement('div');
                div.className = 'bg-white p-4 rounded-xl shadow-sm flex justify-between items-center border border-gray-100';
                
                // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ç—ã
                const d = new Date(run.date);
                const dateStr = d.toLocaleDateString('ru-RU', {day:'numeric', month:'long'});
                
                div.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="bg-blue-100 text-blue-600 w-10 h-10 rounded-full flex items-center justify-center">
                            <i class="fas fa-running"></i>
                        </div>
                        <div>
                            <div class="font-bold text-gray-800 text-sm">${dateStr}</div>
                            <div class="text-xs text-gray-400 flex gap-2">
                                ${run.time ? `<span>‚è± ${run.time}</span>` : ''}
                                ${run.hr ? `<span>‚ù§Ô∏è ${run.hr}</span>` : ''}
                            </div>
                        </div>
                    </div>
                    <div class="text-lg font-black text-gray-800">${run.dist}<span class="text-xs font-normal text-gray-400 ml-1">–∫–º</span></div>
                `;
                container.appendChild(div);
            });
            
            document.getElementById('total-km').innerText = total.toFixed(1);
            document.getElementById('total-runs').innerText = runs.length;
        }

        // --- –ì–†–ê–§–ò–ö–ò ---
        let chartInstance = null;

        function renderChart() {
            const ctx = document.getElementById('distanceChart').getContext('2d');
            
            // –ë–µ—Ä–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –ø—Ä–æ–±–µ–∂–µ–∫ –∏ —Å–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –¥–∞—Ç–µ (–ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é)
            const sortedRuns = [...runs].sort((a,b) => new Date(a.date) - new Date(b.date)).slice(-7);
            
            const labels = sortedRuns.map(r => {
                const d = new Date(r.date);
                return `${d.getDate()}.${d.getMonth()+1}`;
            });
            const data = sortedRuns.map(r => r.dist);

            if(chartInstance) chartInstance.destroy();

            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '–ö–º',
                        data: data,
                        backgroundColor: '#3b82f6',
                        borderRadius: 6,
                        barThickness: 20
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, grid: { color: '#f3f4f6' } },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        function askCoachAboutStats() {
            switchTab('chat');
            const total = document.getElementById('total-km').innerText;
            const recent = runs.slice(0, 5).map(r => `${r.date}: ${r.dist}–∫–º (—Ç–µ–º–ø/–≤—Ä–µ–º—è: ${r.time || '-'})`).join('; ');
            
            const prompt = `–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –º–æ–∏ –±–µ–≥–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ. –í—Å–µ–≥–æ —è –ø—Ä–æ–±–µ–∂–∞–ª ${total} –∫–º. –í–æ—Ç –º–æ–∏ –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–ø–∏—Å–∏: [${recent}]. –û—Ü–µ–Ω–∏ –Ω–∞–≥—Ä—É–∑–∫—É –∏ –¥–∞–π —Å–æ–≤–µ—Ç –Ω–∞ —Å–ª–µ–¥—É—é—â—É—é –Ω–µ–¥–µ–ª—é.`;
            
            // –í—Å—Ç–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç, –Ω–æ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å—Ä–∞–∑—É, —á—Ç–æ–±—ã —é–∑–µ—Ä –º–æ–≥ –ø–æ–ø—Ä–∞–≤–∏—Ç—å
            document.getElementById('user-input').value = prompt;
            // –ò–ª–∏ –º–æ–∂–Ω–æ —Å—Ä–∞–∑—É –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å:
            // sendMessage(); 
        }

        // --- –ù–ê–°–¢–†–û–ô–ö–ò ---
        function saveApiKey() {
            const key = document.getElementById('api-key').value.trim();
            if(key) {
                localStorage.setItem('deepseek_key', key);
                apiKey = key;
                alert('‚úÖ –ö–ª—é—á —Å–æ—Ö—Ä–∞–Ω–µ–Ω! –ú–æ–∂–Ω–æ –æ–±—â–∞—Ç—å—Å—è.');
                updateStatus();
                switchTab('chat');
            }
        }

        function clearData() {
            if(confirm('–¢–æ—á–Ω–æ —É–¥–∞–ª–∏—Ç—å –≤—Å–µ –ø—Ä–æ–±–µ–∂–∫–∏ –∏ –ø–µ—Ä–µ–ø–∏—Å–∫—É?')) {
                localStorage.removeItem('run_history');
                localStorage.removeItem('chat_history');
                location.reload();
            }
        }
    </script>
</body>
</html>