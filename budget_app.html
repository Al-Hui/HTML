<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —Ä–µ–≥—É–ª—è—Ä–Ω—ã—Ö —Ä–∞—Å—Ö–æ–¥–æ–≤</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg: #020617;
      --bg-elevated: #020617;
      --card: #020617;
      --text: #f9fafb;
      --muted: #9ca3af;
      --accent-blue: #38bdf8;
      --accent-orange: #fb923c;
      --accent-soft: rgba(56,189,248,0.12);
      --accent-soft-orange: rgba(251,146,60,0.12);
      --border: #1f2937;
      --danger: #f97373;
      --radius-lg: 18px;
      --radius-md: 12px;
      --shadow-soft: 0 18px 40px rgba(15, 23, 42, 0.8);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      min-height: 100vh;
      display: flex;
      justify-content: center;
      padding: 16px;
      background:
        radial-gradient(circle at top, #0b1120 0, #020617 45%, #020617 100%);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
      color: var(--text);
    }

    .app {
      width: 100%;
      max-width: 1120px;
      background:
        radial-gradient(circle at top left, rgba(56,189,248,0.12), transparent 55%),
        radial-gradient(circle at top right, rgba(251,146,60,0.15), transparent 60%),
        var(--bg-elevated);
      border-radius: 24px;
      border: 1px solid rgba(148,163,184,0.5);
      box-shadow: var(--shadow-soft);
      padding: 18px 18px 20px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .header {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
    }
    .title {
      font-size: 20px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .title span.icon { font-size: 22px; }
    .subtitle {
      font-size: 13px;
      color: var(--muted);
      margin-top: 4px;
      line-height: 1.4;
    }
    .chip-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 6px;
    }
    .chip {
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.6);
      background: rgba(15,23,42,0.92);
      padding: 3px 9px;
      font-size: 11px;
      color: var(--muted);
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .chip b {
      color: var(--accent-blue);
      font-weight: 600;
    }

    .btn {
      border-radius: 999px;
      border: none;
      padding: 7px 12px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 5px;
      white-space: nowrap;
    }
    .btn-primary {
      background: linear-gradient(90deg,var(--accent-blue),var(--accent-orange));
      color: #f9fafb;
      box-shadow: 0 14px 30px rgba(37,99,235,0.7);
    }
    .btn-secondary {
      background: rgba(15,23,42,0.9);
      color: var(--muted);
      border: 1px solid rgba(148,163,184,0.7);
    }
    .btn-soft {
      background: rgba(15,23,42,0.72);
      color: var(--muted);
      border: 1px solid rgba(55,65,81,0.9);
    }
    .btn-danger {
      background: rgba(127,29,29,0.92);
      color: #fecaca;
      border: 1px solid rgba(248,113,113,0.85);
    }
    .btn:active {
      transform: translateY(1px);
      box-shadow: none;
    }
    .btn-xs {
      padding: 3px 7px;
      font-size: 11px;
    }

    .tabs {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 6px;
      border-bottom: 1px solid rgba(31,41,55,0.95);
      padding-bottom: 4px;
    }
    .tab-btn {
      border: none;
      background: transparent;
      color: var(--muted);
      padding: 6px 10px;
      font-size: 12px;
      border-radius: 999px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .tab-btn.active {
      background: var(--accent-soft);
      color: var(--accent-blue);
      border: 1px solid rgba(56,189,248,0.65);
    }
    .tab-icon { font-size: 13px; }
    .tab-content { display: none; margin-top: 8px; }
    .tab-content.active { display: block; }

    .section {
      border-radius: var(--radius-lg);
      border: 1px solid rgba(31,41,55,0.95);
      padding: 10px 12px 12px;
      background: radial-gradient(circle at top, rgba(15,23,42,0.96), #020617);
      margin-bottom: 10px;
    }
    .section-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .section-title span.icon { font-size: 15px; }
    .section-sub {
      font-size: 11px;
      color: var(--muted);
      margin-bottom: 6px;
      line-height: 1.35;
    }

    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      margin-bottom: 6px;
    }
    label {
      font-size: 11px;
      color: var(--muted);
      display: flex;
      flex-direction: column;
      gap: 3px;
    }
    input[type="text"],
    input[type="number"],
    input[type="date"],
    input[type="month"],
    select,
    textarea {
      padding: 5px 7px;
      border-radius: 8px;
      border: 1px solid rgba(31,41,55,0.95);
      font-size: 12px;
      background: rgba(15,23,42,0.96);
      color: var(--text);
      min-width: 70px;
    }
    input[type="number"] { width: 90px; }
    input[type="date"] { width: 140px; }
    input[type="month"] { width: 145px; }
    textarea {
      min-height: 60px;
      resize: vertical;
    }

    .small {
      font-size: 11px;
      color: var(--muted);
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 9px;
      border-radius: 999px;
      border: 1px solid rgba(55,65,81,0.9);
      background: rgba(15,23,42,0.9);
      font-size: 11px;
      color: var(--muted);
    }
    .pill b { color: var(--accent-orange); }

    .table-wrap {
      margin-top: 6px;
      border-radius: var(--radius-lg);
      border: 1px solid rgba(31,41,55,0.95);
      overflow: auto;
      max-height: 340px;
      background: rgba(15,23,42,0.96);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11.5px;
    }
    thead {
      background: rgba(15,23,42,0.98);
      position: sticky;
      top: 0;
      z-index: 1;
    }
    th, td {
      padding: 5px 6px;
      border-bottom: 1px solid rgba(31,41,55,0.95);
      text-align: left;
      white-space: nowrap;
    }
    th {
      font-weight: 600;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--muted);
    }
    tbody tr:nth-child(even) td { background: rgba(15,23,42,0.9); }
    tbody tr:nth-child(odd) td { background: rgba(15,23,42,0.86); }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
      gap: 8px;
      margin-top: 6px;
    }
    .stat-card {
      border-radius: var(--radius-md);
      border: 1px solid rgba(31,41,55,0.95);
      padding: 6px 8px;
      background: rgba(15,23,42,0.97);
    }
    .stat-label {
      font-size: 11px;
      color: var(--muted);
      margin-bottom: 2px;
    }
    .stat-value {
      font-size: 15px;
      font-weight: 600;
    }
    .stat-note {
      font-size: 10px;
      color: var(--muted);
      margin-top: 2px;
    }

    .charts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 10px;
      margin-top: 6px;
    }
    .chart-box {
      border-radius: var(--radius-lg);
      border: 1px solid rgba(31,41,55,0.95);
      padding: 8px 10px 10px;
      background: rgba(15,23,42,0.97);
    }
    .chart-title {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 4px;
    }
    canvas {
      width: 100%;
      height: 210px;
    }

    .ai-box {
      margin-top: 6px;
      border-radius: var(--radius-md);
      border: 1px solid rgba(251,146,60,0.8);
      padding: 6px 8px;
      background: rgba(30,64,175,0.65);
      font-size: 12px;
    }
    .ai-title {
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 3px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .ai-title .icon { font-size: 14px; }
    .ai-text {
      font-size: 11.5px;
      color: #fefce8;
      line-height: 1.5;
    }

    .error {
      font-size: 11px;
      color: var(--danger);
      min-height: 14px;
    }

    @media (max-width: 768px) {
      .app { padding: 14px 10px 14px; border-radius: 18px; }
      .header { flex-direction: column; align-items: flex-start; }
    }
  </style>
</head>
<body>
<div class="app">
  <div class="header">
    <div>
      <div class="title">
        <span class="icon">üí∏</span>
        –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —Ä–µ–≥—É–ª—è—Ä–Ω—ã—Ö —Ä–∞—Å—Ö–æ–¥–æ–≤
      </div>
      <div class="subtitle">
        –ü–ª–∞–Ω–∏—Ä—É–µ—à—å –±—é–¥–∂–µ—Ç –Ω–∞ –º–µ—Å—è—Ü, –ø–æ–ª—É—á–∞–µ—à—å –¥–Ω–µ–≤–Ω–æ–π –ª–∏–º–∏—Ç, –≤–Ω–æ—Å–∏—à—å —Ä–µ–∞–ª—å–Ω—ã–µ —Ç—Ä–∞—Ç—ã ‚Äî –≤ –∫–æ–Ω—Ü–µ –º–µ—Å—è—Ü–∞ –≤–∏–¥–∏—à—å –∞–Ω–∞–ª–∏—Ç–∏–∫—É –∏ –≥—Ä–∞—Ñ–∏–∫–∏.
      </div>
      <div class="chip-row">
        <div class="chip">–•—Ä–∞–Ω–µ–Ω–∏–µ: <b>LocalStorage</b></div>
        <div class="chip">–§–æ–∫—É—Å: <b>–µ–∂–µ–º–µ—Å—è—á–Ω—ã–π –±—é–¥–∂–µ—Ç</b></div>
        <div class="chip">–ì—Ä–∞—Ñ–∏–∫–∏: <b>Chart.js</b></div>
      </div>
    </div>
    <div style="display:flex;flex-direction:column;gap:6px;align-items:flex-end;">
      <label class="small">–ê–∫—Ç–∏–≤–Ω—ã–π –º–µ—Å—è—Ü</label>
      <div style="display:flex;gap:6px;align-items:center;">
        <input type="month" id="monthSelector">
        <button class="btn btn-soft" id="btnSetCurrentMonth" type="button">–¢–µ–∫—É—â–∏–π</button>
      </div>
    </div>
  </div>

  <div class="tabs">
    <button class="tab-btn active" data-tab="tab-plan">
      <span class="tab-icon">üìÖ</span>–ü–ª–∞–Ω –±—é–¥–∂–µ—Ç–∞
    </button>
    <button class="tab-btn" data-tab="tab-expenses">
      <span class="tab-icon">üßæ</span>–¢—Ä–∞—Ç—ã
    </button>
    <button class="tab-btn" data-tab="tab-analytics">
      <span class="tab-icon">üìä</span>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞
    </button>
    <button class="tab-btn" data-tab="tab-export">
      <span class="tab-icon">üì§</span>–≠–∫—Å–ø–æ—Ä—Ç / –ò–º–ø–æ—Ä—Ç
    </button>
  </div>

  <!-- –ü–ª–∞–Ω –±—é–¥–∂–µ—Ç–∞ -->
  <div class="tab-content active" id="tab-plan">
    <div class="section">
      <div class="section-title"><span class="icon">üìÖ</span>–ü–ª–∞–Ω –±—é–¥–∂–µ—Ç–∞ –Ω–∞ –º–µ—Å—è—Ü</div>
      <div class="section-sub">
        –í—ã–±–µ—Ä–∏ –º–µ—Å—è—Ü —Å–≤–µ—Ä—Ö—É. –£–∫–∞–∂–∏ –æ–±—â–∏–π –±—é–¥–∂–µ—Ç –∏ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã (–∞—Ä–µ–Ω–¥–∞, –ø–æ–¥–ø–∏—Å–∫–∏, –∫—Ä–µ–¥–∏—Ç—ã). –ü—Ä–æ–≥—Ä–∞–º–º–∞ –ø–æ—Å—á–∏—Ç–∞–µ—Ç, —Å–∫–æ–ª—å–∫–æ –º–æ–∂–Ω–æ —Ç—Ä–∞—Ç–∏—Ç—å –≤ –¥–µ–Ω—å.
      </div>

      <div class="row">
        <label>–ë—é–¥–∂–µ—Ç –Ω–∞ –º–µ—Å—è—Ü, ‚ÇΩ
          <input type="number" id="planBudgetInput" min="0" step="1000" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, 120000">
        </label>
        <button class="btn btn-primary" id="btnSaveBudget" type="button">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –±—é–¥–∂–µ—Ç</button>
        <span class="small" id="planMonthLabel"></span>
      </div>

      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-label">–ë—é–¥–∂–µ—Ç –º–µ—Å—è—Ü–∞</div>
          <div class="stat-value" id="statPlanBudget">‚Äî</div>
          <div class="stat-note">–û–±—â–∞—è —Å—É–º–º–∞, –∫–æ—Ç–æ—Ä—É—é –ø–ª–∞–Ω–∏—Ä—É–µ—à—å –ø–æ—Ç—Ä–∞—Ç–∏—Ç—å.</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">–§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã</div>
          <div class="stat-value" id="statPlanFixed">‚Äî</div>
          <div class="stat-note">–ê—Ä–µ–Ω–¥–∞, –ø–æ–¥–ø–∏—Å–∫–∏, –∫—Ä–µ–¥–∏—Ç—ã –∏ —Ç.–ø.</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">–î–æ—Å—Ç—É–ø–Ω–æ –Ω–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Ç—Ä–∞—Ç—ã</div>
          <div class="stat-value" id="statPlanVariable">‚Äî</div>
          <div class="stat-note">–ë—é–¥–∂–µ—Ç –Ω–∞ ¬´–ø–æ–≤—Å–µ–¥–Ω–µ–≤–Ω—ã–µ¬ª —Ä–∞—Å—Ö–æ–¥—ã (–µ–¥–∞, –∫–∞—Ñ–µ, —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç‚Ä¶).</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π –¥–Ω–µ–≤–Ω–æ–π –ª–∏–º–∏—Ç</div>
          <div class="stat-value" id="statDailyLimit">‚Äî</div>
          <div class="stat-note">–†–∞–≤–Ω–æ–º–µ—Ä–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –±—é–¥–∂–µ—Ç–∞ –ø–æ –¥–Ω—è–º –º–µ—Å—è—Ü–∞.</div>
        </div>
      </div>
    </div>

    <div class="section">
      <div class="section-title"><span class="icon">üîÅ</span>–§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –µ–∂–µ–º–µ—Å—è—á–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã</div>
      <div class="section-sub">
        –î–æ–±–∞–≤—å —Å—é–¥–∞ —Ä–µ–≥—É–ª—è—Ä–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã, –∫–æ—Ç–æ—Ä—ã–µ –ø–ª–∞—Ç–∏—à—å –∫–∞–∂–¥—ã–π –º–µ—Å—è—Ü. –û–Ω–∏ –±—É–¥—É—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã—á–∏—Ç–∞—Ç—å—Å—è –∏–∑ –±—é–¥–∂–µ—Ç–∞ –º–µ—Å—è—Ü–∞.
      </div>

      <div class="row">
        <label>–ù–∞–∑–≤–∞–Ω–∏–µ
          <input type="text" id="fixedNameInput" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, –∞—Ä–µ–Ω–¥–∞, Spotify, –∏–Ω—Ç–µ—Ä–Ω–µ—Ç">
        </label>
        <label>–°—É–º–º–∞, ‚ÇΩ
          <input type="number" id="fixedAmountInput" min="0" step="100">
        </label>
        <button class="btn btn-secondary" id="btnAddFixed" type="button">–î–æ–±–∞–≤–∏—Ç—å —Ñ–∏–∫—Å. —Ä–∞—Å—Ö–æ–¥</button>
      </div>

      <div class="table-wrap">
        <table>
          <thead>
          <tr>
            <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
            <th>–°—É–º–º–∞, ‚ÇΩ</th>
            <th></th>
          </tr>
          </thead>
          <tbody id="fixedTableBody">
          <tr><td colspan="3">–ù–µ—Ç —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ä–∞—Å—Ö–æ–¥–æ–≤ –¥–ª—è —ç—Ç–æ–≥–æ –º–µ—Å—è—Ü–∞.</td></tr>
          </tbody>
        </table>
      </div>

      <div class="error" id="planError"></div>
    </div>
  </div>

  <!-- –¢—Ä–∞—Ç—ã -->
  <div class="tab-content" id="tab-expenses">
    <div class="section">
      <div class="section-title"><span class="icon">‚ûï</span>–î–æ–±–∞–≤–∏—Ç—å —Ç—Ä–∞—Ç—É</div>
      <div class="section-sub">
        –í–Ω–æ—Å–∏ –∫–∞–∂–¥—É—é —Ç—Ä–∞—Ç—É: –¥–∞—Ç—É, —Å—É–º–º—É, –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π. –ü–æ –º–µ—Å—è—Ü—É —Å–≤–µ—Ä—Ö—É –±—É–¥–µ—Ç —Å—á–∏—Ç–∞—Ç—å—Å—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞.
      </div>

      <div class="row">
        <label>–î–∞—Ç–∞
          <input type="date" id="expenseDateInput">
        </label>
        <button class="btn btn-soft" id="btnTodayExpense" type="button">–°–µ–≥–æ–¥–Ω—è</button>
      </div>

      <div class="row">
        <label>–°—É–º–º–∞, ‚ÇΩ
          <input type="number" id="expenseAmountInput" min="0" step="10">
        </label>
        <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è
          <select id="expenseCategoryInput">
          </select>
        </label>
      </div>

      <div class="row">
        <label style="flex:1;">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
          <input type="text" id="expenseCommentInput" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å—É–ø–µ—Ä–º–∞—Ä–∫–µ—Ç, —Ç–∞–∫—Å–∏, –æ–±–µ–¥ –≤ –∫–∞—Ñ–µ">
        </label>
      </div>

      <div class="row">
        <button class="btn btn-primary" id="btnAddExpense" type="button">–î–æ–±–∞–≤–∏—Ç—å —Ç—Ä–∞—Ç—É</button>
        <button class="btn btn-soft" id="btnClearExpenseForm" type="button">–û—á–∏—Å—Ç–∏—Ç—å —Ñ–æ—Ä–º—É</button>
      </div>

      <div class="error" id="expenseError"></div>
    </div>

    <div class="section">
      <div class="section-title"><span class="icon">üìã</span>–¢—Ä–∞—Ç—ã –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –º–µ—Å—è—Ü</div>
      <div class="section-sub">
        –§–∏–ª—å—Ç—Ä—É–µ—Ç—Å—è –ø–æ –∞–∫—Ç–∏–≤–Ω–æ–º—É –º–µ—Å—è—Ü—É. –ú–æ–∂–Ω–æ –∏—Å–∫–∞—Ç—å –ø–æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—é –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏.
      </div>

      <div class="row">
        <label>–§–∏–ª—å—Ç—Ä –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
          <select id="filterExpenseCategory">
            <option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
          </select>
        </label>
        <label>–ü–æ–∏—Å–∫ –ø–æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—é
          <input type="text" id="filterExpenseSearch" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, '–∫–∞—Ñ–µ' –∏–ª–∏ '—Ç–∞–∫—Å–∏'">
        </label>
        <button class="btn btn-soft" id="btnClearExpenseFilters" type="button">–°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã</button>
      </div>

      <div class="table-wrap">
        <table>
          <thead>
          <tr>
            <th>–î–∞—Ç–∞</th>
            <th>–°—É–º–º–∞, ‚ÇΩ</th>
            <th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
            <th>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
            <th></th>
          </tr>
          </thead>
          <tbody id="expenseTableBody">
          <tr><td colspan="5">–ü–æ–∫–∞ –Ω–µ—Ç —Ç—Ä–∞—Ç –∑–∞ —ç—Ç–æ—Ç –º–µ—Å—è—Ü.</td></tr>
          </tbody>
        </table>
      </div>

      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-label">–°—É–º–º–∞ —Ç—Ä–∞—Ç –∑–∞ –º–µ—Å—è—Ü</div>
          <div class="stat-value" id="statSpentMonth">‚Äî</div>
          <div class="stat-note">–°—É–º–º–∞ –≤—Å–µ—Ö —Ç—Ä–∞—Ç, –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã—Ö –∫ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É –º–µ—Å—è—Ü—É.</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">–û—Å—Ç–∞—Ç–æ–∫ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –±—é–¥–∂–µ—Ç–∞</div>
          <div class="stat-value" id="statVariableLeft">‚Äî</div>
          <div class="stat-note">–°–∫–æ–ª—å–∫–æ –µ—â—ë –º–æ–∂–Ω–æ –ø–æ—Ç—Ä–∞—Ç–∏—Ç—å, —á—Ç–æ–±—ã —É–ª–æ–∂–∏—Ç—å—Å—è –≤ –ø–ª–∞–Ω.</div>
        </div>
      </div>
    </div>
  </div>

  <!-- –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ -->
  <div class="tab-content" id="tab-analytics">
    <div class="section">
      <div class="section-title"><span class="icon">üìä</span>–ì—Ä–∞—Ñ–∏–∫–∏ —Ä–∞—Å—Ö–æ–¥–æ–≤</div>
      <div class="section-sub">
        –õ–∏–Ω–∏—è –ø–æ –¥–Ω—è–º –º–µ—Å—è—Ü–∞ –∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º –ø–æ–º–æ–≥–∞—é—Ç —É–≤–∏–¥–µ—Ç—å, ¬´—Å—ä–µ–¥–∞–µ—Ç—Å—è¬ª –ª–∏ –±—é–¥–∂–µ—Ç —Å–ª–∏—à–∫–æ–º –±—ã—Å—Ç—Ä–æ.
      </div>

      <div class="charts-grid">
        <div class="chart-box">
          <div class="chart-title">–†–∞—Å—Ö–æ–¥—ã –ø–æ –¥–Ω—è–º –º–µ—Å—è—Ü–∞</div>
          <canvas id="chartDaily"></canvas>
        </div>
        <div class="chart-box">
          <div class="chart-title">–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</div>
          <canvas id="chartCategory"></canvas>
        </div>
      </div>
    </div>

    <div class="section">
      <div class="section-title"><span class="icon">üìà</span>–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –æ–±–∑–æ—Ä –º–µ—Å—è—Ü–∞</div>
      <div class="section-sub">
        –ö—Ä–∞—Ç–∫–∏–π —Ä–∞–∑–±–æ—Ä: –Ω–∞—Å–∫–æ–ª—å–∫–æ —Ç—Ä–∞—Ç—ã —Å–æ–æ—Ç–Ω–æ—Å—è—Ç—Å—è —Å –±—é–¥–∂–µ—Ç–æ–º, —Ö–≤–∞—Ç–∏—Ç –ª–∏ –¥–µ–Ω–µ–≥ –¥–æ –∫–æ–Ω—Ü–∞ –º–µ—Å—è—Ü–∞ –∏ –≥–¥–µ –æ—Å–Ω–æ–≤–Ω—ã–µ ¬´–ø–æ–∂–∏—Ä–∞—Ç–µ–ª–∏¬ª –±—é–¥–∂–µ—Ç–∞.
      </div>

      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-label">–ü–ª–∞–Ω / –§–∞–∫—Ç</div>
          <div class="stat-value" id="statPlanVsFact">‚Äî</div>
          <div class="stat-note">–ë—é–¥–∂–µ—Ç –º–∏–Ω—É—Å —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Ä–∞—Å—Ö–æ–¥—ã (—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ + –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ).</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">–°—Ä–µ–¥–Ω–∏–π —Ä–∞—Å—Ö–æ–¥ –≤ –¥–µ–Ω—å</div>
          <div class="stat-value" id="statAvgPerDay">‚Äî</div>
          <div class="stat-note">–°—É–º–º–∞ —Ç—Ä–∞—Ç / –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ—à–µ–¥—à–∏—Ö –¥–Ω–µ–π –º–µ—Å—è—Ü–∞.</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">–ü—Ä–æ–≥–Ω–æ–∑ –∫–æ–Ω—Ü–∞ –º–µ—Å—è—Ü–∞</div>
          <div class="stat-value" id="statForecast">‚Äî</div>
          <div class="stat-note">–û—Ü–µ–Ω–∫–∞, —Å–∫–æ–ª—å–∫–æ –±—É–¥–µ—Ç –ø–æ—Ç—Ä–∞—á–µ–Ω–æ –∫ –∫–æ–Ω—Ü—É –º–µ—Å—è—Ü–∞ –ø—Ä–∏ —Ç–µ–∫—É—â–µ–º —Ç–µ–º–ø–µ.</div>
        </div>
      </div>

      <div class="ai-box">
        <div class="ai-title">
          <span class="icon">üß†</span>
          –ú–∏–Ω–∏-–∞–Ω–∞–ª–∏–∑ –ø–æ –º–µ—Å—è—Ü—É
        </div>
        <div class="ai-text" id="aiSummaryText">
          –ö–∞–∫ —Ç–æ–ª—å–∫–æ —É —Ç–µ–±—è –ø–æ—è–≤—è—Ç—Å—è –¥–∞–Ω–Ω—ã–µ –ø–æ –±—é–¥–∂–µ—Ç—É –∏ —Ö–æ—Ç—è –±—ã –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ç—Ä–∞—Ç, –∑–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è —Ä–∞–∑–±–æ—Ä: —É–∫–ª–∞–¥—ã–≤–∞–µ—à—å—Å—è –ª–∏ —Ç—ã –≤ –ø–ª–∞–Ω, ¬´–≥–æ—Ä—è—á–∏–µ¬ª –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ä–∞—Å—Ö–æ–¥–æ–≤ –∏ –ø—Ä–∏–º–µ—Ä–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏.
        </div>
      </div>
    </div>
  </div>

  <!-- –≠–∫—Å–ø–æ—Ä—Ç / –∏–º–ø–æ—Ä—Ç -->
  <div class="tab-content" id="tab-export">
    <div class="section">
      <div class="section-title"><span class="icon">üì§</span>–≠–∫—Å–ø–æ—Ä—Ç / –ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</div>
      <div class="section-sub">
        –ú–æ–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é –≤—Å–µ—Ö –ø–ª–∞–Ω–æ–≤ –∏ —Ç—Ä–∞—Ç –≤ JSON-—Ñ–∞–π–ª –∏ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–ª–∏ –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ –Ω–∞ –¥—Ä—É–≥–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ.
      </div>

      <div class="row">
        <button class="btn btn-secondary" id="btnExportJson" type="button">‚¨á –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å JSON</button>
        <label class="btn btn-soft" style="cursor:pointer;">
          üì• –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å JSON
          <input type="file" id="importFileInput" accept=".json" style="display:none;">
        </label>
      </div>

      <div class="small">
        –ü—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ –º–æ–∂–Ω–æ –æ–±—ä–µ–¥–∏–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Å —Ç–µ–∫—É—â–∏–º–∏ –∏–ª–∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–º–µ–Ω–∏—Ç—å ‚Äî –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å–ø—Ä–æ—Å–∏—Ç, —á—Ç–æ —Ç—ã —Ö–æ—á–µ—à—å —Å–¥–µ–ª–∞—Ç—å.
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const STORAGE_KEY = 'regular_expenses_v1';

  let state = {
    categories: [
      '–ï–¥–∞',
      '–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç',
      '–ñ–∏–ª—å—ë',
      '–ü–æ–¥–ø–∏—Å–∫–∏',
      '–†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è',
      '–ü–æ–∫—É–ø–∫–∏',
      '–ó–¥–æ—Ä–æ–≤—å–µ',
      '–î—Ä—É–≥–æ–µ'
    ],
    plans: {
      // '2025-11': { monthKey:'2025-11', budget: 120000, fixed: [ {id,name,amount} ] }
    },
    expenses: [
      // {id, date:'YYYY-MM-DD', amount, category, comment}
    ]
  };

  let chartDaily = null;
  let chartCategory = null;

  // –≠–ª–µ–º–µ–Ω—Ç—ã
  const tabButtons = document.querySelectorAll('.tab-btn');
  const tabContents = document.querySelectorAll('.tab-content');

  const monthSelector = document.getElementById('monthSelector');
  const btnSetCurrentMonth = document.getElementById('btnSetCurrentMonth');

  // –ü–ª–∞–Ω
  const planBudgetInput = document.getElementById('planBudgetInput');
  const btnSaveBudget = document.getElementById('btnSaveBudget');
  const planMonthLabel = document.getElementById('planMonthLabel');
  const fixedNameInput = document.getElementById('fixedNameInput');
  const fixedAmountInput = document.getElementById('fixedAmountInput');
  const btnAddFixed = document.getElementById('btnAddFixed');
  const fixedTableBody = document.getElementById('fixedTableBody');
  const planError = document.getElementById('planError');

  const statPlanBudget = document.getElementById('statPlanBudget');
  const statPlanFixed = document.getElementById('statPlanFixed');
  const statPlanVariable = document.getElementById('statPlanVariable');
  const statDailyLimit = document.getElementById('statDailyLimit');

  // –¢—Ä–∞—Ç—ã
  const expenseDateInput = document.getElementById('expenseDateInput');
  const btnTodayExpense = document.getElementById('btnTodayExpense');
  const expenseAmountInput = document.getElementById('expenseAmountInput');
  const expenseCategoryInput = document.getElementById('expenseCategoryInput');
  const expenseCommentInput = document.getElementById('expenseCommentInput');
  const btnAddExpense = document.getElementById('btnAddExpense');
  const btnClearExpenseForm = document.getElementById('btnClearExpenseForm');
  const expenseError = document.getElementById('expenseError');

  const filterExpenseCategory = document.getElementById('filterExpenseCategory');
  const filterExpenseSearch = document.getElementById('filterExpenseSearch');
  const btnClearExpenseFilters = document.getElementById('btnClearExpenseFilters');
  const expenseTableBody = document.getElementById('expenseTableBody');

  const statSpentMonth = document.getElementById('statSpentMonth');
  const statVariableLeft = document.getElementById('statVariableLeft');

  // –ê–Ω–∞–ª–∏—Ç–∏–∫–∞
  const chartDailyEl = document.getElementById('chartDaily');
  const chartCategoryEl = document.getElementById('chartCategory');

  const statPlanVsFact = document.getElementById('statPlanVsFact');
  const statAvgPerDay = document.getElementById('statAvgPerDay');
  const statForecast = document.getElementById('statForecast');
  const aiSummaryText = document.getElementById('aiSummaryText');

  // –≠–∫—Å–ø–æ—Ä—Ç / –∏–º–ø–æ—Ä—Ç
  const btnExportJson = document.getElementById('btnExportJson');
  const importFileInput = document.getElementById('importFileInput');

  // –¢–∞–±—ã
  tabButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      tabButtons.forEach(b => b.classList.remove('active'));
      tabContents.forEach(c => c.classList.remove('active'));
      btn.classList.add('active');
      const id = btn.getAttribute('data-tab');
      document.getElementById(id).classList.add('active');
    });
  });

  function setCurrentMonthValue() {
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, '0');
    monthSelector.value = `${y}-${m}`;
  }

  btnSetCurrentMonth.addEventListener('click', () => {
    setCurrentMonthValue();
    onMonthChange();
  });

  monthSelector.addEventListener('change', () => {
    onMonthChange();
  });

  function getActiveMonthKey() {
    if (!monthSelector.value) {
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, '0');
      return `${y}-${m}`;
    }
    return monthSelector.value;
  }

  function daysInMonth(monthKey) {
    const [yearStr, monthStr] = monthKey.split('-');
    const year = parseInt(yearStr, 10);
    const month = parseInt(monthStr, 10);
    return new Date(year, month, 0).getDate();
  }

  function loadState() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return;
      const data = JSON.parse(raw);
      if (Array.isArray(data.categories)) {
        state.categories = data.categories;
      }
      if (data.plans && typeof data.plans === 'object') {
        state.plans = data.plans;
      }
      if (Array.isArray(data.expenses)) {
        state.expenses = data.expenses;
      }
    } catch (e) {
      console.error('loadState error', e);
    }
  }

  function saveState() {
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    } catch (e) {
      console.error('saveState error', e);
    }
  }

  function getCurrentPlan(monthKey) {
    return state.plans[monthKey] || {
      monthKey,
      budget: 0,
      fixed: []
    };
  }

  function setCurrentPlan(plan) {
    state.plans[plan.monthKey] = plan;
  }

  function calcPlanStats(monthKey) {
    const plan = getCurrentPlan(monthKey);
    const budget = plan.budget || 0;
    const fixedSum = (plan.fixed || []).reduce((s, f) => s + (f.amount || 0), 0);
    const days = daysInMonth(monthKey);
    const variable = Math.max(budget - fixedSum, 0);
    const dailyLimit = days > 0 ? variable / days : 0;
    return { plan, budget, fixedSum, variable, days, dailyLimit };
  }

  function formatMoney(v) {
    if (v == null || isNaN(v)) return '‚Äî';
    return v.toLocaleString('ru-RU', { maximumFractionDigits: 0 }) + ' ‚ÇΩ';
  }

  function formatMoneyWithSign(v) {
    if (v == null || isNaN(v)) return '‚Äî';
    const sign = v >= 0 ? '+' : '‚àí';
    const abs = Math.abs(v);
    return sign + abs.toLocaleString('ru-RU', { maximumFractionDigits: 0 }) + ' ‚ÇΩ';
  }

  function onMonthChange() {
    const monthKey = getActiveMonthKey();
    const plan = getCurrentPlan(monthKey);
    planBudgetInput.value = plan.budget ? plan.budget : '';
    const [y, m] = monthKey.split('-');
    planMonthLabel.textContent = `–¢–µ–∫—É—â–∏–π –º–µ—Å—è—Ü: ${m}.${y}`;

    renderFixedExpenses();
    renderPlanStats();
    renderExpensesTable();
    renderExpenseStats();
    renderCharts();
    renderAnalytics();
  }

  // –†–µ–Ω–¥–µ—Ä –∫–∞—Ç–µ–≥–æ—Ä–∏–π
  function renderCategorySelects() {
    expenseCategoryInput.innerHTML = '';
    filterExpenseCategory.innerHTML = '<option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>';
    state.categories.forEach(cat => {
      const opt = document.createElement('option');
      opt.value = cat;
      opt.textContent = cat;
      expenseCategoryInput.appendChild(opt);

      const opt2 = document.createElement('option');
      opt2.value = cat;
      opt2.textContent = cat;
      filterExpenseCategory.appendChild(opt2);
    });
  }

  // –ü–ª–∞–Ω ‚Äî —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –±—é–¥–∂–µ—Ç
  btnSaveBudget.addEventListener('click', () => {
    const monthKey = getActiveMonthKey();
    let plan = getCurrentPlan(monthKey);
    const v = parseFloat(planBudgetInput.value);
    if (isNaN(v) || v < 0) {
      planError.textContent = '–£–∫–∞–∂–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –±—é–¥–∂–µ—Ç –Ω–∞ –º–µ—Å—è—Ü.';
      return;
    }
    planError.textContent = '';
    plan.budget = v;
    plan.monthKey = monthKey;
    setCurrentPlan(plan);
    saveState();
    renderPlanStats();
    renderExpenseStats();
    renderanalyticsAndChartsAfterPlanChange();
  });

  function renderanalyticsAndChartsAfterPlanChange() {
    renderCharts();
    renderAnalytics();
  }

  // –ü–ª–∞–Ω ‚Äî —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã
  btnAddFixed.addEventListener('click', () => {
    const name = fixedNameInput.value.trim();
    const amount = parseFloat(fixedAmountInput.value);
    if (!name) {
      planError.textContent = '–£–∫–∞–∂–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ä–∞—Å—Ö–æ–¥–∞.';
      return;
    }
    if (isNaN(amount) || amount < 0) {
      planError.textContent = '–£–∫–∞–∂–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ä–∞—Å—Ö–æ–¥–∞.';
      return;
    }
    planError.textContent = '';
    const monthKey = getActiveMonthKey();
    const plan = getCurrentPlan(monthKey);
    if (!Array.isArray(plan.fixed)) plan.fixed = [];
    plan.fixed.push({
      id: Date.now() + '_' + Math.random().toString(16).slice(2),
      name,
      amount
    });
    setCurrentPlan(plan);
    saveState();
    fixedNameInput.value = '';
    fixedAmountInput.value = '';
    renderFixedExpenses();
    renderPlanStats();
    renderExpenseStats();
    renderanalyticsAndChartsAfterPlanChange();
  });

  function renderFixedExpenses() {
    const monthKey = getActiveMonthKey();
    const plan = getCurrentPlan(monthKey);
    const fixed = plan.fixed || [];
    if (!fixed.length) {
      fixedTableBody.innerHTML = '<tr><td colspan="3">–ù–µ—Ç —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ä–∞—Å—Ö–æ–¥–æ–≤ –¥–ª—è —ç—Ç–æ–≥–æ –º–µ—Å—è—Ü–∞.</td></tr>';
      return;
    }
    fixedTableBody.innerHTML = '';
    fixed.forEach(f => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${escapeHtml(f.name || '')}</td>
        <td>${(f.amount || 0).toLocaleString('ru-RU', { maximumFractionDigits: 0 })}</td>
        <td><button class="btn btn-danger btn-xs" data-id="${f.id}">‚úï</button></td>
      `;
      fixedTableBody.appendChild(tr);
    });
    fixedTableBody.querySelectorAll('button').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = btn.getAttribute('data-id');
        const monthKey = getActiveMonthKey();
        const plan = getCurrentPlan(monthKey);
        plan.fixed = (plan.fixed || []).filter(f => String(f.id) !== String(id));
        setCurrentPlan(plan);
        saveState();
        renderFixedExpenses();
        renderPlanStats();
        renderExpenseStats();
        renderanalyticsAndChartsAfterPlanChange();
      });
    });
  }

  function renderPlanStats() {
    const monthKey = getActiveMonthKey();
    const stats = calcPlanStats(monthKey);
    statPlanBudget.textContent = stats.budget ? formatMoney(stats.budget) : '‚Äî';
    statPlanFixed.textContent = formatMoney(stats.fixedSum);
    statPlanVariable.textContent = formatMoney(stats.variable);
    statDailyLimit.textContent = stats.dailyLimit ? formatMoney(stats.dailyLimit) : '‚Äî';
  }

  // –¢—Ä–∞—Ç—ã ‚Äî —Ñ–æ—Ä–º–∞
  function setExpenseDateToday() {
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, '0');
    const day = String(d.getDate()).padStart(2, '0');
    expenseDateInput.value = `${y}-${m}-${day}`;
  }

  btnTodayExpense.addEventListener('click', setExpenseDateToday);

  btnAddExpense.addEventListener('click', () => {
    const date = expenseDateInput.value;
    const amount = parseFloat(expenseAmountInput.value);
    const category = expenseCategoryInput.value;
    const comment = expenseCommentInput.value.trim();

    if (!date) {
      expenseError.textContent = '–£–∫–∞–∂–∏ –¥–∞—Ç—É —Ç—Ä–∞—Ç—ã.';
      return;
    }
    if (isNaN(amount) || amount <= 0) {
      expenseError.textContent = '–£–∫–∞–∂–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É —Ç—Ä–∞—Ç—ã.';
      return;
    }
    if (!category) {
      expenseError.textContent = '–í—ã–±–µ—Ä–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—é.';
      return;
    }
    expenseError.textContent = '';

    state.expenses.push({
      id: Date.now() + '_' + Math.random().toString(16).slice(2),
      date,
      amount,
      category,
      comment
    });
    saveState();
    expenseAmountInput.value = '';
    expenseCommentInput.value = '';
    renderExpensesTable();
    renderExpenseStats();
    renderCharts();
    renderAnalytics();
  });

  btnClearExpenseForm.addEventListener('click', () => {
    expenseDateInput.value = '';
    expenseAmountInput.value = '';
    expenseCategoryInput.value = state.categories[0] || '';
    expenseCommentInput.value = '';
    expenseError.textContent = '';
  });

  // –¢–∞–±–ª–∏—Ü–∞ —Ç—Ä–∞—Ç
  filterExpenseCategory.addEventListener('change', renderExpensesTable);
  filterExpenseSearch.addEventListener('input', renderExpensesTable);
  btnClearExpenseFilters.addEventListener('click', () => {
    filterExpenseCategory.value = '';
    filterExpenseSearch.value = '';
    renderExpensesTable();
  });

  function renderExpensesTable() {
    const monthKey = getActiveMonthKey();
    const catFilter = filterExpenseCategory.value;
    const search = (filterExpenseSearch.value || '').trim().toLowerCase();

    const expenses = state.expenses.filter(e => {
      if (!e.date || typeof e.date !== 'string') return false;
      if (!e.date.startsWith(monthKey)) return false;
      if (catFilter && e.category !== catFilter) return false;
      if (search) {
        const comment = (e.comment || '').toLowerCase();
        if (!comment.includes(search)) return false;
      }
      return true;
    });

    if (!expenses.length) {
      expenseTableBody.innerHTML = '<tr><td colspan="5">–ü–æ–∫–∞ –Ω–µ—Ç —Ç—Ä–∞—Ç –∑–∞ —ç—Ç–æ—Ç –º–µ—Å—è—Ü.</td></tr>';
      return;
    }

    expenseTableBody.innerHTML = '';
    expenses.sort((a, b) => a.date.localeCompare(b.date));
    expenses.forEach(e => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${escapeHtml(e.date)}</td>
        <td>${e.amount.toLocaleString('ru-RU', { maximumFractionDigits: 0 })}</td>
        <td>${escapeHtml(e.category)}</td>
        <td>${escapeHtml(e.comment || '')}</td>
        <td><button class="btn btn-danger btn-xs" data-id="${e.id}">‚úï</button></td>
      `;
      expenseTableBody.appendChild(tr);
    });

    expenseTableBody.querySelectorAll('button').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = btn.getAttribute('data-id');
        if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É —Ç—Ä–∞—Ç—É?')) return;
        state.expenses = state.expenses.filter(e => String(e.id) !== String(id));
        saveState();
        renderExpensesTable();
        renderExpenseStats();
        renderCharts();
        renderAnalytics();
      });
    });
  }

  function renderExpenseStats() {
    const monthKey = getActiveMonthKey();
    const stats = calcPlanStats(monthKey);
    const expensesMonth = state.expenses.filter(e => e.date && e.date.startsWith(monthKey));
    const spent = expensesMonth.reduce((s, e) => s + (e.amount || 0), 0);
    const variableLeft = Math.max(stats.variable - spent, -Infinity);

    statSpentMonth.textContent = formatMoney(spent);
    statVariableLeft.textContent = stats.variable ? formatMoney(variableLeft) : '‚Äî';
  }

  // –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ ‚Äî –≥—Ä–∞—Ñ–∏–∫–∏
  function renderCharts() {
    const monthKey = getActiveMonthKey();
    const stats = calcPlanStats(monthKey);
    const expensesMonth = state.expenses.filter(e => e.date && e.date.startsWith(monthKey));
    const daysCount = stats.days;

    if (chartDaily) chartDaily.destroy();
    if (chartCategory) chartCategory.destroy();

    if (!daysCount || !expensesMonth.length) {
      chartDaily = new Chart(chartDailyEl, {
        type: 'line',
        data: { labels: [], datasets: [] },
        options: { plugins: { legend: { display: false } }, scales: {x:{},y:{}} }
      });
      chartCategory = new Chart(chartCategoryEl, {
        type: 'doughnut',
        data: { labels: [], datasets: [] },
        options: { plugins: { legend: { display: false } } }
      });
      return;
    }

    const dailySum = new Array(daysCount).fill(0);
    expensesMonth.forEach(e => {
      const day = parseInt(e.date.slice(8,10), 10);
      if (!isNaN(day) && day >= 1 && day <= daysCount) {
        dailySum[day-1] += e.amount || 0;
      }
    });

    const labels = Array.from({length:daysCount}, (_,i)=>String(i+1));
    const cumulative = [];
    let acc = 0;
    for (let i=0; i<daysCount; i++) {
      acc += dailySum[i];
      cumulative.push(acc);
    }
    const dailyLimit = stats.dailyLimit;
    const dailyLimitSeries = dailyLimit ? Array.from({length:daysCount}, (_,i)=>dailyLimit*(i+1)) : [];

    chartDaily = new Chart(chartDailyEl, {
      type: 'line',
      data: {
        labels,
        datasets: [
          {
            label: '–¢—Ä–∞—Ç—ã –∑–∞ –¥–µ–Ω—å',
            data: dailySum,
            borderColor: '#38bdf8',
            backgroundColor: 'rgba(56,189,248,0.25)',
            borderWidth: 2,
            tension: 0.2,
            pointRadius: 2
          },
          {
            label: '–ù–∞–∫–æ–ø–ª–µ–Ω–Ω—ã–µ —Ç—Ä–∞—Ç—ã',
            data: cumulative,
            borderColor: '#fb923c',
            backgroundColor: 'rgba(251,146,60,0.25)',
            borderWidth: 2,
            tension: 0.2,
            pointRadius: 0
          },
          dailyLimit ? {
            label: '–õ–∏–Ω–∏—è –ø–ª–∞–Ω–∞ (–Ω–∞–∫–æ–ø.)',
            data: dailyLimitSeries,
            borderColor: '#64748b',
            borderWidth: 1.5,
            borderDash: [5,3],
            tension: 0,
            pointRadius: 0
          } : null
        ].filter(Boolean)
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display: true, labels: { font: { size: 10 } } }
        },
        scales: {
          x: { ticks: { font: { size: 9 } } },
          y: { ticks: { font: { size: 9 } } }
        }
      }
    });

    const categoryMap = {};
    expensesMonth.forEach(e => {
      const cat = e.category || '–î—Ä—É–≥–æ–µ';
      if (!categoryMap[cat]) categoryMap[cat] = 0;
      categoryMap[cat] += e.amount || 0;
    });
    const catLabels = Object.keys(categoryMap);
    const catValues = catLabels.map(l => categoryMap[l]);
    const colors = [
      'rgba(56,189,248,0.7)',
      'rgba(251,146,60,0.8)',
      'rgba(52,211,153,0.8)',
      'rgba(248,113,113,0.85)',
      'rgba(196,181,253,0.85)',
      'rgba(248,250,252,0.75)',
      'rgba(96,165,250,0.75)',
      'rgba(251,191,36,0.8)'
    ];

    chartCategory = new Chart(chartCategoryEl, {
      type: 'doughnut',
      data: {
        labels: catLabels,
        datasets: [{
          data: catValues,
          backgroundColor: catLabels.map((_,i)=>colors[i % colors.length]),
          borderWidth: 1,
          borderColor: '#020617'
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display: true, labels: { font: { size: 10 } } }
        }
      }
    });
  }

  // –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ ‚Äî —Ü–∏—Ñ—Ä—ã + —Ç–µ–∫—Å—Ç
  function renderAnalytics() {
    const monthKey = getActiveMonthKey();
    const stats = calcPlanStats(monthKey);
    const expensesMonth = state.expenses.filter(e => e.date && e.date.startsWith(monthKey));
    if (!stats.budget && !expensesMonth.length) {
      statPlanVsFact.textContent = '‚Äî';
      statAvgPerDay.textContent = '‚Äî';
      statForecast.textContent = '‚Äî';
      aiSummaryText.textContent = '–£–∫–∞–∂–∏ –±—é–¥–∂–µ—Ç –∏ –¥–æ–±–∞–≤—å —Ö–æ—Ç—è –±—ã –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ç—Ä–∞—Ç –∑–∞ –º–µ—Å—è—Ü ‚Äî —Ç–æ–≥–¥–∞ –∑–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è —Ä–∞–∑–±–æ—Ä –ø–æ –±—é–¥–∂–µ—Ç—É –∏ –¥–∏–Ω–∞–º–∏–∫–µ —Ä–∞—Å—Ö–æ–¥–æ–≤.';
      return;
    }

    const spentVariable = expensesMonth.reduce((s,e)=>s+(e.amount||0),0);
    const totalSpent = spentVariable + stats.fixedSum;
    const delta = stats.budget ? stats.budget - totalSpent : null;
    statPlanVsFact.textContent = stats.budget ? formatMoneyWithSign(delta) : '‚Äî';

    const days = stats.days;
    if (days <= 0) {
      statAvgPerDay.textContent = '‚Äî';
      statForecast.textContent = '‚Äî';
      aiSummaryText.textContent = '–ü–æ—Ö–æ–∂–µ, —á—Ç–æ –≤—ã–±—Ä–∞–Ω –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –º–µ—Å—è—Ü. –ü–æ–ø—Ä–æ–±—É–π –≤—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥–æ–π –º–µ—Å—è—Ü.';
      return;
    }

    const [yearStr, monthStr] = monthKey.split('-');
    const now = new Date();
    let daysPassed;
    if (now.getFullYear() === parseInt(yearStr,10) && (now.getMonth()+1) === parseInt(monthStr,10)) {
      daysPassed = now.getDate();
      if (daysPassed > days) daysPassed = days;
    } else {
      // –µ—Å–ª–∏ –º–µ—Å—è—Ü –≤ –ø—Ä–æ—à–ª–æ–º –∏–ª–∏ –±—É–¥—É—â–µ–º ‚Äî —Å—á–∏—Ç–∞–µ–º, —á—Ç–æ –ø—Ä–æ—à—ë–ª –≤–µ—Å—å –º–µ—Å—è—Ü
      daysPassed = days;
    }

    const avgPerDay = daysPassed > 0 ? spentVariable / daysPassed : 0;
    const forecastVariable = avgPerDay * days;
    const forecastTotal = forecastVariable + stats.fixedSum;

    statAvgPerDay.textContent = spentVariable ? formatMoney(avgPerDay) : '‚Äî';
    statForecast.textContent = stats.budget ? formatMoney(forecastTotal) : formatMoney(forecastTotal);

    // –¢–µ–∫—Å—Ç–æ–≤—ã–π "–ò–ò"-—Ä–∞–∑–±–æ—Ä
    let text = '';
    text += `–í—ã–±—Ä–∞–Ω –º–µ—Å—è—Ü ${monthKey}. –ü–ª–∞–Ω–æ–≤—ã–π –±—é–¥–∂–µ—Ç: ${stats.budget ? formatMoney(stats.budget) : '–Ω–µ –∑–∞–¥–∞–Ω'}.\n\n`;

    if (stats.budget) {
      text += `–§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã: ${formatMoney(stats.fixedSum)}. –ù–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Ç—Ä–∞—Ç—ã –æ—Å—Ç–∞—ë—Ç—Å—è –ø—Ä–∏–º–µ—Ä–Ω–æ ${formatMoney(stats.variable)}.\n`;
      text += `–†–∞–≤–Ω–æ–º–µ—Ä–Ω—ã–π –¥–Ω–µ–≤–Ω–æ–π –ª–∏–º–∏—Ç: ${stats.dailyLimit ? formatMoney(stats.dailyLimit) : '‚Äî'}.\n\n`;
    }

    if (expensesMonth.length) {
      text += `–ó–∞ —ç—Ç–æ—Ç –º–µ—Å—è—Ü —É–∂–µ –ø–æ—Ç—Ä–∞—á–µ–Ω–æ –Ω–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã: ${formatMoney(spentVariable)} (–±–µ–∑ —É—á—ë—Ç–∞ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö).\n`;
      text += `–°—Ä–µ–¥–Ω–∏–π —Ä–∞—Å—Ö–æ–¥ –≤ –¥–µ–Ω—å: ${avgPerDay ? formatMoney(avgPerDay) : '‚Äî'}.\n`;
      text += `–ï—Å–ª–∏ –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å –≤ —Ç–æ–º –∂–µ —Ç–µ–º–ø–µ, –∫ –∫–æ–Ω—Ü—É –º–µ—Å—è—Ü–∞ –±—É–¥–µ—Ç –ø–æ—Ç—Ä–∞—á–µ–Ω–æ –ø—Ä–∏–º–µ—Ä–Ω–æ ${formatMoney(forecastTotal)} (–≤–∫–ª—é—á–∞—è —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ).\n\n`;

      if (stats.budget) {
        if (forecastTotal > stats.budget * 1.05) {
          text += '‚ùó –ü—Ä–∏ —Ç–µ–∫—É—â–µ–º —Ç–µ–º–ø–µ —Ä–∞—Å—Ö–æ–¥–æ–≤ –µ—Å—Ç—å –≤—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫ –≤—ã–π—Ç–∏ –∑–∞ —Ä–∞–º–∫–∏ –±—é–¥–∂–µ—Ç–∞. –ú–æ–∂–Ω–æ –ª–∏–±–æ —Å–Ω–∏–∑–∏—Ç—å –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–π –ª–∏–º–∏—Ç, –ª–∏–±–æ –ø–µ—Ä–µ—Å–º–æ—Ç—Ä–µ—Ç—å –∫—Ä—É–ø–Ω—ã–µ –ø–æ–∫—É–ø–∫–∏.\n';
        } else if (forecastTotal < stats.budget * 0.9) {
          text += '‚úÖ –ü—Ä–∏ —Ç–µ–∫—É—â–µ–º —Ç–µ–º–ø–µ —Ç—ã, –≤–µ—Ä–æ—è—Ç–Ω–æ, —É–ª–æ–∂–∏—à—å—Å—è –≤ –±—é–¥–∂–µ—Ç —Å –∑–∞–ø–∞—Å–æ–º. –≠—Ç–æ —Ö–æ—Ä–æ—à–∏–π –∑–Ω–∞–∫: –º–æ–∂–Ω–æ –ª–∏–±–æ –Ω–µ–º–Ω–æ–≥–æ —É–≤–µ–ª–∏—á–∏—Ç—å –∫–æ–º—Ñ–æ—Ä—Ç, –ª–∏–±–æ —É—Å–∫–æ—Ä–∏—Ç—å –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è.\n';
        } else {
          text += '‚ÑπÔ∏è –¢—Ä–∞—Ç—ã –ø—Ä–∏–º–µ—Ä–Ω–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç –ø–ª–∞–Ω—É. –í–∞–∂–Ω–æ –ª–∏—à—å –Ω–µ —É–≤–µ–ª–∏—á–∏–≤–∞—Ç—å —Ç–µ–º–ø –±–ª–∏–∂–µ –∫ –∫–æ–Ω—Ü—É –º–µ—Å—è—Ü–∞.\n';
        }

        const categoryMap = {};
        expensesMonth.forEach(e => {
          const cat = e.category || '–î—Ä—É–≥–æ–µ';
          if (!categoryMap[cat]) categoryMap[cat] = 0;
          categoryMap[cat] += e.amount || 0;
        });
        const sortedCats = Object.entries(categoryMap).sort((a,b)=>b[1]-a[1]);
        if (sortedCats.length) {
          const topCats = sortedCats.slice(0,3).map(([cat,val])=>`${cat} (${formatMoney(val)})`).join(', ');
          text += `\n–¢–æ–ø –∫–∞—Ç–µ–≥–æ—Ä–∏–π –ø–æ —Ä–∞—Å—Ö–æ–¥–∞–º: ${topCats}. –ò–º–µ–Ω–Ω–æ —Ç—É–¥–∞ —É—Ç–µ–∫–∞–µ—Ç –æ—Å–Ω–æ–≤–Ω–æ–π –æ–±—ä—ë–º –±—é–¥–∂–µ—Ç–∞.`;
        }
      }
    } else {
      text += '–ó–∞ —ç—Ç–æ—Ç –º–µ—Å—è—Ü –µ—â—ë –Ω–µ—Ç —Ç—Ä–∞—Ç. –ö–∞–∫ —Ç–æ–ª—å–∫–æ —Ç—ã –Ω–∞—á–Ω—ë—à—å –≤–Ω–æ—Å–∏—Ç—å —Ä–∞—Å—Ö–æ–¥—ã, –∑–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è –¥–∏–Ω–∞–º–∏–∫–∞ –∏ –ø—Ä–æ–≥–Ω–æ–∑.';
    }

    aiSummaryText.textContent = text;
  }

  // –≠–∫—Å–ø–æ—Ä—Ç / –∏–º–ø–æ—Ä—Ç
  btnExportJson.addEventListener('click', () => {
    const blob = new Blob([JSON.stringify(state, null, 2)], { type: 'application/json;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'regular_expenses_backup.json';
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  });

  importFileInput.addEventListener('change', () => {
    const file = importFileInput.files && importFileInput.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = () => {
      try {
        const data = JSON.parse(reader.result);
        if (!data || typeof data !== 'object') throw new Error('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π JSON.');
        if (!Array.isArray(data.expenses)) throw new Error('–ù–µ –Ω–∞–π–¥–µ–Ω –º–∞—Å—Å–∏–≤ expenses.');
        let merge = false;
        if (state.expenses.length || Object.keys(state.plans).length) {
          merge = confirm('–£ —Ç–µ–±—è —É–∂–µ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ. OK ‚Äî –æ–±—ä–µ–¥–∏–Ω–∏—Ç—å —Å –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º—ã–º–∏, Cancel ‚Äî –∑–∞–º–µ–Ω–∏—Ç—å.');
        }
        if (!merge) {
          state = {
            categories: state.categories.slice(),
            plans: {},
            expenses: []
          };
        }
        if (Array.isArray(data.categories)) {
          data.categories.forEach(c => {
            if (!state.categories.includes(c)) state.categories.push(c);
          });
        }
        if (data.plans && typeof data.plans === 'object') {
          Object.entries(data.plans).forEach(([k,v]) => {
            state.plans[k] = v;
          });
        }
        data.expenses.forEach(e => {
          if (!e.id) e.id = Date.now() + '_' + Math.random().toString(16).slice(2);
          state.expenses.push(e);
        });
        saveState();
        renderAll();
        alert('–ò–º–ø–æ—Ä—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à—ë–Ω.');
      } catch (e) {
        console.error(e);
        alert('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ JSON: ' + e.message);
      } finally {
        importFileInput.value = '';
      }
    };
    reader.readAsText(file);
  });

  function escapeHtml(str) {
    return String(str)
      .replace(/&/g,'&amp;')
      .replace(/</g,'&lt;')
      .replace(/>/g,'&gt;')
      .replace(/"/g,'&quot;')
      .replace(/'/g,'&#39;');
  }

  function renderAll() {
    renderCategorySelects();
    onMonthChange();
  }

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
  loadState();
  setCurrentMonthValue();
  setExpenseDateToday();
  renderAll();
</script>
</body>
</html>