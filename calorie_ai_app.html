<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ö–∫–∞–ª-–∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —Å AI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- –ò–∫–æ–Ω–∫–∞ –¥–ª—è iPhone / –∏–∫–æ–Ω–∫–∞ —Å–∞–π—Ç–∞ -->
  <link rel="apple-touch-icon" href="icon.png">
  <link rel="icon" href="icon.png">
  <meta name="apple-mobile-web-app-title" content="–ö–∫–∞–ªAI">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <style>
    :root {
      --bg: #020617;
      --bg-card: #020617;
      --text: #f9fafb;
      --muted: #9ca3af;
      --blue: #38bdf8;
      --blue-soft: rgba(56,189,248,0.15);
      --orange: #fb923c;
      --orange-soft: rgba(251,146,60,0.18);
      --border: #1f2937;
      --danger: #f97373;
      --radius-lg: 20px;
      --radius-md: 14px;
      --shadow: 0 18px 40px rgba(15,23,42,0.9);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      min-height: 100vh;
      display: flex;
      justify-content: center;
      padding: 16px;
      background:
        radial-gradient(circle at top, #0b1120 0, #020617 45%, #020617 100%);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
      color: var(--text);
    }

    .app {
      width: 100%;
      max-width: 1000px;
      background:
        radial-gradient(circle at top left, rgba(56,189,248,0.16), transparent 55%),
        radial-gradient(circle at top right, rgba(251,146,60,0.16), transparent 60%),
        var(--bg-card);
      border-radius: 26px;
      border: 1px solid rgba(148,163,184,0.6);
      box-shadow: var(--shadow);
      padding: 18px 18px 22px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .header {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
    }
    .title {
      font-size: 22px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .title span.icon {
      font-size: 26px;
    }
    .subtitle {
      font-size: 13px;
      color: var(--muted);
      margin-top: 4px;
      line-height: 1.4;
    }

    .pill-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 6px;
    }
    .pill {
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.7);
      padding: 3px 8px;
      font-size: 11px;
      color: var(--muted);
      background: rgba(15,23,42,0.92);
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .pill b { color: var(--blue); }

    .btn {
      border-radius: 999px;
      border: none;
      padding: 7px 12px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 5px;
      white-space: nowrap;
    }
    .btn-primary {
      background: linear-gradient(90deg,var(--blue),var(--orange));
      color: #f9fafb;
      box-shadow: 0 14px 30px rgba(37,99,235,0.7);
      border: none;
    }
    .btn-secondary {
      background: rgba(15,23,42,0.9);
      color: var(--muted);
      border: 1px solid rgba(148,163,184,0.7);
    }
    .btn-soft {
      background: rgba(15,23,42,0.7);
      color: var(--muted);
      border: 1px solid rgba(55,65,81,0.9);
    }
    .btn-danger {
      background: rgba(127,29,29,0.9);
      color: #fecaca;
      border: 1px solid rgba(248,113,113,0.8);
    }
    .btn-xs {
      padding: 3px 6px;
      font-size: 11px;
    }
    .btn:active {
      transform: translateY(1px);
      box-shadow: none;
    }

    .tabs {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 8px;
      border-bottom: 1px solid rgba(31,41,55,0.95);
      padding-bottom: 4px;
    }
    .tab-btn {
      border: none;
      background: transparent;
      color: var(--muted);
      padding: 7px 12px;
      font-size: 13px;
      border-radius: 999px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .tab-btn.active {
      background: var(--blue-soft);
      color: var(--blue);
      border: 1px solid rgba(56,189,248,0.7);
    }
    .tab-icon {
      font-size: 15px;
    }

    .tab-content {
      display: none;
      margin-top: 10px;
    }
    .tab-content.active {
      display: block;
    }

    .section {
      border-radius: var(--radius-lg);
      border: 1px solid rgba(31,41,55,0.95);
      padding: 12px 12px 14px;
      background: radial-gradient(circle at top, rgba(15,23,42,0.97), #020617);
      margin-bottom: 10px;
    }
    .section-title {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .section-title .icon {
      font-size: 16px;
    }
    .section-sub {
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 6px;
      line-height: 1.4;
    }

    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      margin-bottom: 6px;
    }
    label {
      font-size: 11px;
      color: var(--muted);
      display: flex;
      flex-direction: column;
      gap: 3px;
    }
    input[type="text"],
    input[type="number"],
    input[type="date"],
    input[type="password"],
    textarea {
      padding: 6px 8px;
      border-radius: 10px;
      border: 1px solid rgba(31,41,55,0.95);
      font-size: 13px;
      background: rgba(15,23,42,0.95);
      color: var(--text);
      min-width: 70px;
    }
    input[type="number"] {
      width: 110px;
    }
    textarea {
      min-height: 60px;
      resize: vertical;
    }

    .small {
      font-size: 11px;
      color: var(--muted);
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 8px;
      margin-top: 6px;
    }
    .stat-card {
      border-radius: var(--radius-md);
      border: 1px solid rgba(31,41,55,0.95);
      padding: 7px 9px;
      background: rgba(15,23,42,0.96);
    }
    .stat-label {
      font-size: 11px;
      color: var(--muted);
      margin-bottom: 2px;
    }
    .stat-value {
      font-size: 15px;
      font-weight: 600;
    }
    .stat-note {
      font-size: 10px;
      color: var(--muted);
      margin-top: 2px;
    }

    .capture-layout {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.1fr);
      gap: 10px;
    }

    .image-box {
      border-radius: var(--radius-lg);
      border: 1px solid rgba(31,41,55,0.95);
      padding: 10px;
      background:
        radial-gradient(circle at top, rgba(56,189,248,0.18), transparent 60%),
        rgba(15,23,42,0.98);
    }
    .image-preview {
      width: 100%;
      max-height: 260px;
      object-fit: cover;
      border-radius: 14px;
      border: 1px solid rgba(148,163,184,0.6);
      margin-top: 8px;
    }

    .recent-list {
      border-radius: var(--radius-lg);
      border: 1px solid rgba(31,41,55,0.95);
      padding: 8px 9px;
      background: rgba(15,23,42,0.98);
      max-height: 260px;
      overflow: auto;
      font-size: 12px;
    }
    .recent-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 5px 0;
      border-bottom: 1px solid rgba(31,41,55,0.9);
    }
    .recent-item:last-child {
      border-bottom: none;
    }
    .recent-main {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .recent-name {
      font-weight: 600;
      font-size: 13px;
    }
    .recent-meta {
      font-size: 11px;
      color: var(--muted);
    }

    .error {
      font-size: 11px;
      color: var(--danger);
      min-height: 14px;
      margin-top: 4px;
    }

    .table-wrap {
      margin-top: 6px;
      border-radius: var(--radius-lg);
      border: 1px solid rgba(31,41,55,0.95);
      overflow: auto;
      max-height: 360px;
      background: rgba(15,23,42,0.96);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11.5px;
    }
    thead {
      background: rgba(15,23,42,0.98);
      position: sticky;
      top: 0;
      z-index: 1;
    }
    th, td {
      padding: 5px 6px;
      border-bottom: 1px solid rgba(31,41,55,0.95);
      text-align: left;
      white-space: nowrap;
    }
    th {
      font-weight: 600;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--muted);
    }
    tbody tr:nth-child(even) td { background: rgba(15,23,42,0.9); }
    tbody tr:nth-child(odd) td { background: rgba(15,23,42,0.86); }

    .charts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 10px;
      margin-top: 6px;
    }
    .chart-box {
      border-radius: var(--radius-lg);
      border: 1px solid rgba(31,41,55,0.95);
      padding: 8px 10px 10px;
      background: rgba(15,23,42,0.98);
    }
    .chart-title {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 4px;
    }
    canvas {
      width: 100%;
      height: 220px;
    }

    .ai-box {
      margin-top: 6px;
      border-radius: var(--radius-md);
      border: 1px solid rgba(251,146,60,0.8);
      padding: 6px 8px;
      background: rgba(30,64,175,0.75);
      font-size: 12px;
    }
    .ai-title {
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 3px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .ai-title .icon {
      font-size: 14px;
    }
    .ai-text {
      font-size: 11.5px;
      color: #fefce8;
      line-height: 1.5;
    }

    /* –ë–∞–∑–∞ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ */
    .product-search-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 6px;
      align-items: center;
    }
    .product-list {
      border-radius: var(--radius-lg);
      border: 1px solid rgba(31,41,55,0.95);
      max-height: 300px;
      overflow: auto;
      background: rgba(15,23,42,0.98);
      padding: 6px 6px 6px;
      font-size: 12px;
    }
    .product-item {
      padding: 4px 4px;
      border-radius: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
    }
    .product-item:hover {
      background: rgba(15,23,42,0.9);
    }
    .product-name {
      font-size: 12px;
    }
    .product-kcal {
      font-size: 11px;
      color: var(--muted);
    }

    @media (max-width: 768px) {
      .app {
        padding: 14px 10px 16px;
        border-radius: 20px;
      }
      .capture-layout {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
<div class="app">
  <div class="header">
    <div>
      <div class="title">
        <span class="icon">üç±</span>
        –ö–∫–∞–ª-–∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —Å AI
      </div>
      <div class="subtitle">
        –§–æ—Ç–∫–∞–µ—à—å –µ–¥—É –∏–ª–∏ –≤—ã–±–∏—Ä–∞–µ—à—å –∏–∑ –±–∞–∑—ã ‚Üí —Å—á–∏—Ç–∞–µ–º –∫–∫–∞–ª –ø–æ –≥—Ä–∞–º–º–∞–º ‚Üí –¥–Ω–µ–≤–Ω–∏–∫ ‚Üí –≥—Ä–∞—Ñ–∏–∫–∏ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞. –í—Å—ë —Ö—Ä–∞–Ω–∏—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ.
      </div>
      <div class="pill-row">
        <div class="pill">–†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ: <b>OpenAI Vision</b></div>
        <div class="pill">–ë–∞–∑–∞: <b>–æ—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã + —Ç–≤–æ–∏</b></div>
        <div class="pill">–•—Ä–∞–Ω–µ–Ω–∏–µ: <b>localStorage</b></div>
      </div>
    </div>
    <div style="display:flex;flex-direction:column;align-items:flex-end;gap:4px;">
      <span class="small">–ê–∫—Ç–∏–≤–Ω—ã–π –º–µ—Å—è—Ü</span>
      <div style="display:flex;gap:6px;align-items:center;">
        <input type="month" id="monthSelector">
        <button class="btn-soft btn-xs" type="button" id="btnSetCurrentMonth">–°–µ–π—á–∞—Å</button>
      </div>
    </div>
  </div>

  <div class="tabs">
    <button class="tab-btn active" data-tab="tab-diary">
      <span class="tab-icon">üì∏</span>–î–Ω–µ–≤–Ω–∏–∫
    </button>
    <button class="tab-btn" data-tab="tab-products">
      <span class="tab-icon">üìö</span>–ë–∞–∑–∞ –ø—Ä–æ–¥—É–∫—Ç–æ–≤
    </button>
    <button class="tab-btn" data-tab="tab-analytics">
      <span class="tab-icon">üìä</span>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞
    </button>
    <button class="tab-btn" data-tab="tab-settings">
      <span class="tab-icon">‚öôÔ∏è</span>API / –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
    </button>
  </div>

  <!-- –î–ù–ï–í–ù–ò–ö -->
  <div class="tab-content active" id="tab-diary">
    <div class="section">
      <div class="section-title">
        <span class="icon">üì∏</span>
        –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –µ–¥—ã (—Ñ–æ—Ç–æ + –±–∞–∑–∞ + –≤—Ä—É—á–Ω—É—é)
      </div>
      <div class="section-sub">
        1) –°—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—Ä—É–π –∏–ª–∏ –≤—ã–±–µ—Ä–∏ —Ñ–æ—Ç–æ <br>
        2) –ù–∞–∂–º–∏ ¬´–†–∞—Å–ø–æ–∑–Ω–∞—Ç—å —Å AI¬ª –∏–ª–∏ –≤—ã–±–µ—Ä–∏ –∏–∑ –±–∞–∑—ã –ø—Ä–æ–¥—É–∫—Ç–æ–≤ <br>
        3) –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –ø–æ–ø—Ä–∞–≤—å –≥—Ä–∞–º–º—ã/–∫–∫–∞–ª –∏ –¥–æ–±–∞–≤—å –≤ –¥–Ω–µ–≤–Ω–∏–∫.
      </div>

      <div class="capture-layout">
        <!-- –§–æ—Ç–æ -->
        <div class="image-box">
          <div class="row">
            <label style="flex:1;">
              –§–æ—Ç–æ –±–ª—é–¥–∞
              <input type="file" id="fileInput" accept="image/*" capture="environment">
            </label>
          </div>
          <img id="imagePreview" class="image-preview" alt="–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä" style="display:none;">

          <div class="row" style="margin-top:8px;">
            <label>
              –î–∞—Ç–∞
              <input type="date" id="entryDate">
            </label>
            <label>
              –í—Ä–µ–º—è
              <input type="text" id="entryTime" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, 08:30">
            </label>
          </div>

          <button class="btn-primary" type="button" id="btnAnalyzeImage">
            ü§ñ –†–∞—Å–ø–æ–∑–Ω–∞—Ç—å —Å AI
          </button>

          <div class="error" id="aiError"></div>

          <div class="small" style="margin-top:4px;">
            –î–ª—è AI-—Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è –Ω—É–∂–µ–Ω OpenAI API key (–≤–∫–ª–∞–¥–∫–∞ ¬´API / –Ω–∞—Å—Ç—Ä–æ–π–∫–∏¬ª).
          </div>
        </div>

        <!-- –ü–æ–ª—è + —Ä–∞—Å—á—ë—Ç -->
        <div class="section" style="margin-bottom:0;">
          <div class="section-title">
            <span class="icon">üßÆ</span>
            –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±–ª—é–¥–µ
          </div>
          <div class="row">
            <label style="flex:1;">
              –ù–∞–∑–≤–∞–Ω–∏–µ –±–ª—é–¥–∞
              <input type="text" id="foodName" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –∫–∞–ø—É—á–∏–Ω–æ, –ø–æ–∫–µ —Å –∫—É—Ä–∏—Ü–µ–π">
            </label>
          </div>

          <div class="row">
            <label>
              –ö–∫–∞–ª –Ω–∞ 100 –≥
              <input type="number" id="kcalPer100" min="0" step="1" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, 150">
            </label>
            <label>
              –ú–∞—Å—Å–∞, –≥
              <input type="number" id="weightGrams" min="0" step="10" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, 250">
            </label>
            <label>
              –ò—Ç–æ–≥–æ –∫–∫–∞–ª
              <input type="number" id="calories" min="0" step="1" placeholder="—Ä–∞—Å—Å—á–∏—Ç–∞–µ–º">
            </label>
          </div>

          <div class="row">
            <label>
              –¢–∏–ø –ø—Ä–∏—ë–º–∞ –ø–∏—â–∏
              <input type="text" id="mealType" placeholder="–∑–∞–≤—Ç—Ä–∞–∫ / –æ–±–µ–¥ / —É–∂–∏–Ω / –ø–µ—Ä–µ–∫—É—Å">
            </label>
            <label style="flex:1;">
              –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π / –∫–∞—Ç–µ–≥–æ—Ä–∏—è
              <input type="text" id="note" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, —Ñ–∞—Å—Ç—Ñ—É–¥, –∫–∞—Ñ–µ, –¥–æ–º">
            </label>
          </div>

          <div class="row">
            <button class="btn-soft btn-xs" type="button" id="btnCalcFrom100">–†–∞—Å—Å—á–∏—Ç–∞—Ç—å –∫–∫–∞–ª –ø–æ 100 –≥</button>
            <button class="btn-soft btn-xs" type="button" id="btnCopyToProducts">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞–∫ —Å–≤–æ–π –ø—Ä–æ–¥—É–∫—Ç</button>
          </div>

          <button class="btn-primary" type="button" id="btnAddEntry" style="width:100%;justify-content:center;margin-top:4px;">
            ‚úÖ –î–æ–±–∞–≤–∏—Ç—å –≤ –¥–Ω–µ–≤–Ω–∏–∫
          </button>

          <div class="error" id="entryError"></div>

          <div class="stats-grid" style="margin-top:8px;">
            <div class="stat-card">
              <div class="stat-label">–°—ä–µ–¥–µ–Ω–æ —Å–µ–≥–æ–¥–Ω—è</div>
              <div class="stat-value" id="statToday">‚Äî</div>
              <div class="stat-note">–°—É–º–º–∞ –∫–∫–∞–ª –ø–æ —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–π –¥–∞—Ç–µ.</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">–°—ä–µ–¥–µ–Ω–æ –∑–∞ –º–µ—Å—è—Ü</div>
              <div class="stat-value" id="statMonthShort">‚Äî</div>
              <div class="stat-note">–í—Å–µ –∑–∞–ø–∏—Å–∏ —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—è—Ü–∞.</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">–¶–µ–ª—å –Ω–∞ –¥–µ–Ω—å</div>
              <div class="stat-value" id="statTargetDay">‚Äî</div>
              <div class="stat-note">–ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –≤–æ –≤–∫–ª–∞–¥–∫–µ ¬´–ê–Ω–∞–ª–∏—Ç–∏–∫–∞¬ª.</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- –ë—ã—Å—Ç—Ä—ã–π –≤—ã–±–æ—Ä –∏–∑ –±–∞–∑—ã -->
    <div class="section">
      <div class="section-title">
        <span class="icon">üìö</span>
        –ë—ã—Å—Ç—Ä—ã–π –≤—ã–±–æ—Ä –∏–∑ –±–∞–∑—ã –ø—Ä–æ–¥—É–∫—Ç–æ–≤
      </div>
      <div class="section-sub">
        –ù–∞–π–¥–∏ –ø—Ä–æ–¥—É–∫—Ç, –Ω–∞–∂–º–∏ ‚Äî –∏ –º—ã –ø–æ–¥—Å—Ç–∞–≤–∏–º –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ –∫–∫–∞–ª –Ω–∞ 100 –≥ –≤ —Ñ–æ—Ä–º—É –≤—ã—à–µ.
      </div>
      <div class="product-search-row">
        <label style="flex:1;">
          –ü–æ–∏—Å–∫ –ø–æ –±–∞–∑–µ
          <input type="text" id="quickProductSearch" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, –∫–∞–ø—É—á–∏–Ω–æ, –ø–æ–∫–µ, —Ä–æ–ª–ª...">
        </label>
        <button class="btn-soft btn-xs" type="button" id="btnClearQuickSearch">–°–±—Ä–æ—Å–∏—Ç—å</button>
      </div>
      <div class="product-list" id="quickProductList"></div>
    </div>

    <!-- –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–ø–∏—Å–∏ -->
    <div class="section">
      <div class="section-title">
        <span class="icon">üçΩÔ∏è</span>
        –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–ø–∏—Å–∏
      </div>
      <div class="recent-list" id="recentList"></div>
    </div>
  </div>

  <!-- –ë–ê–ó–ê –ü–†–û–î–£–ö–¢–û–í -->
  <div class="tab-content" id="tab-products">
    <div class="section">
      <div class="section-title">
        <span class="icon">üìö</span>
        –ë–∞–∑–∞ –æ—Å–Ω–æ–≤–Ω—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤
      </div>
      <div class="section-sub">
        –ó–¥–µ—Å—å –≥–æ—Ç–æ–≤–∞—è –±–∞–∑–∞ + —Ç–≤–æ–∏ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã. –ó–Ω–∞—á–µ–Ω–∏—è –∫–∫–∞–ª –Ω–∞ 100 –≥, –¥–∞–ª—å—à–µ —Å—á–∏—Ç–∞–µ–º –ø–æ –º–∞—Å—Å–µ.
      </div>

      <div class="product-search-row">
        <label style="flex:1;">
          –ü–æ–∏—Å–∫
          <input type="text" id="productSearchInput" placeholder="–∫–∞–ø—É—á–∏–Ω–æ, —Ä–∏—Å, –∫—É—Ä–∏—Ü–∞...">
        </label>
        <label>
          –ò—Å—Ç–æ—á–Ω–∏–∫
          <select id="productSourceFilter">
            <option value="">–í—Å–µ</option>
            <option value="base">–í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ</option>
            <option value="custom">–ú–æ–∏</option>
          </select>
        </label>
      </div>

      <div class="product-list" id="productList"></div>
    </div>

    <div class="section">
      <div class="section-title">
        <span class="icon">‚ûï</span>
        –î–æ–±–∞–≤–∏—Ç—å —Å–≤–æ–π –ø—Ä–æ–¥—É–∫—Ç
      </div>
      <div class="row">
        <label style="flex:1;">
          –ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞
          <input type="text" id="customProdName" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –¥–æ–º–∞—à–Ω–∏–π –ø–∏—Ä–æ–≥">
        </label>
        <label>
          –ö–∫–∞–ª –Ω–∞ 100 –≥
          <input type="number" id="customProdKcal" min="0" step="1">
        </label>
      </div>
      <button class="btn-primary" type="button" id="btnAddCustomProduct">–î–æ–±–∞–≤–∏—Ç—å –≤ –±–∞–∑—É</button>
      <div class="error" id="productError"></div>
    </div>
  </div>

  <!-- –ê–ù–ê–õ–ò–¢–ò–ö–ê -->
  <div class="tab-content" id="tab-analytics">
    <div class="section">
      <div class="section-title">
        <span class="icon">üéØ</span>
        –¶–µ–ª—å –∏ —Å–≤–æ–¥–∫–∞
      </div>
      <div class="section-sub">
        –£–∫–∞–∂–∏ –∂–µ–ª–∞–µ–º—É—é –¥–Ω–µ–≤–Ω—É—é –Ω–æ—Ä–º—É ‚Äî –º—ã –ø–æ–∫–∞–∂–µ–º, –Ω–∞—Å–∫–æ–ª—å–∫–æ —Ç—ã –≤—ã—à–µ/–Ω–∏–∂–µ —Ü–µ–ª–∏.
      </div>

      <div class="row">
        <label>
          –¶–µ–ª—å –∫–∫–∞–ª –≤ –¥–µ–Ω—å
          <input type="number" id="targetKcalInput" min="0" step="50" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, 2200">
        </label>
        <button class="btn-primary" type="button" id="btnSaveTarget">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ü–µ–ª—å</button>
      </div>

      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-label">–í—Å–µ–≥–æ –∑–∞ –º–µ—Å—è—Ü</div>
          <div class="stat-value" id="statTotalMonth">‚Äî</div>
          <div class="stat-note">–°—É–º–º–∞ –≤—Å–µ—Ö –∫–∫–∞–ª –∑–∞ –∞–∫—Ç–∏–≤–Ω—ã–π –º–µ—Å—è—Ü.</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">–°—Ä–µ–¥–Ω–∏–π –¥–µ–Ω—å</div>
          <div class="stat-value" id="statAvgPerDay">‚Äî</div>
          <div class="stat-note">–°—Ä–µ–¥–Ω–µ–µ –ø–æ –¥–Ω—è–º —Å –∑–∞–ø–∏—Å—è–º–∏.</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –¥–µ–Ω—å</div>
          <div class="stat-value" id="statMaxDay">‚Äî</div>
          <div class="stat-note">–î–µ–Ω—å, –∫–æ–≥–¥–∞ –±—ã–ª–æ –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ –∫–∫–∞–ª.</div>
        </div>
      </div>
    </div>

    <div class="section">
      <div class="section-title">
        <span class="icon">üìä</span>
        –ì—Ä–∞—Ñ–∏–∫–∏ –ø–æ –º–µ—Å—è—Ü—É
      </div>
      <div class="section-sub">
        –°–ª–µ–≤–∞ ‚Äî —Å—É–º–º–∞—Ä–Ω—ã–µ –∫–∫–∞–ª –ø–æ –¥–Ω—è–º –º–µ—Å—è—Ü–∞, —Å–ø—Ä–∞–≤–∞ ‚Äî —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ ¬´–∫–∞—Ç–µ–≥–æ—Ä–∏—è–º¬ª –∏–∑ –ø–æ–ª—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è.
      </div>

      <div class="charts-grid">
        <div class="chart-box">
          <div class="chart-title">–ö–∫–∞–ª –ø–æ –¥–Ω—è–º –º–µ—Å—è—Ü–∞</div>
          <canvas id="chartDaily"></canvas>
        </div>
        <div class="chart-box">
          <div class="chart-title">–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</div>
          <canvas id="chartCategory"></canvas>
        </div>
      </div>
    </div>

    <div class="section">
      <div class="section-title">
        <span class="icon">üß†</span>
        –¢–µ–∫—Å—Ç–æ–≤—ã–π —Ä–∞–∑–±–æ—Ä
      </div>
      <div class="ai-box">
        <div class="ai-title">
          <span class="icon">üß†</span>
          –ú–∏–Ω–∏-–∞–Ω–∞–ª–∏–∑ –º–µ—Å—è—á–Ω–æ–≥–æ –ø–∏—Ç–∞–Ω–∏—è
        </div>
        <div class="ai-text" id="aiSummaryText">
          –ö–∞–∫ —Ç–æ–ª—å–∫–æ –Ω–∞–∫–æ–ø–∏—Ç—Å—è –Ω–µ—Å–∫–æ–ª—å–∫–æ –¥–Ω–µ–π —Å –∑–∞–ø–∏—Å—è–º–∏, –∑–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è —Ä–∞–∑–±–æ—Ä: —É—Ä–æ–≤–µ–Ω—å –∫–∞–ª–æ—Ä–∏–π, ¬´—Ç—è–∂—ë–ª—ã–µ¬ª –¥–Ω–∏ –∏ –æ—Å–Ω–æ–≤–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏.
        </div>
      </div>
    </div>
  </div>

  <!-- –ù–ê–°–¢–†–û–ô–ö–ò -->
  <div class="tab-content" id="tab-settings">
    <div class="section">
      <div class="section-title">
        <span class="icon">‚öôÔ∏è</span>
        API / –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
      </div>
      <div class="section-sub">
        –í–≤–µ–¥–∏ OpenAI API key –∏ –º–æ–¥–µ–ª—å (vision-–ø–æ–¥–¥–µ—Ä–∂–∫–∞). <br>
        –ö–ª—é—á —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ (localStorage). –î–ª—è –ª–∏—á–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –æ–∫, –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞ –ª—É—á—à–µ backend.
      </div>

      <div class="row">
        <label style="flex:1;">
          OpenAI API key
          <input type="password" id="apiKeyInput" placeholder="sk-...">
        </label>
      </div>
      <div class="row">
        <label style="flex:1;">
          –ú–æ–¥–µ–ª—å
          <input type="text" id="modelInput" value="gpt-4.1-mini">
        </label>
      </div>

      <div class="row">
        <button class="btn-primary" type="button" id="btnSaveApi">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å API –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
        <button class="btn-soft btn-xs" type="button" id="btnClearApi">–û—á–∏—Å—Ç–∏—Ç—å</button>
      </div>

      <div class="small">
        –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–∞–∫ data URL –≤ Chat Completions API –∏ –ø—Ä–æ—Å–∏—Ç –º–æ–¥–µ–ª—å –≤–µ—Ä–Ω—É—Ç—å —á–∏—Å—Ç—ã–π JSON —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º –±–ª—é–¥–∞, –∫–∫–∞–ª –∏ –≤–µ—Å–æ–º.
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const STORAGE_KEY = 'calorie_ai_app_v1';
  const API_KEY_STORAGE = 'calorie_ai_api_key';
  const MODEL_STORAGE = 'calorie_ai_model';
  const TARGET_STORAGE = 'calorie_ai_target';

  // –í—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è –±–∞–∑–∞ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ (–∫–∫–∞–ª –Ω–∞ 100 –≥)
  const BASE_PRODUCTS = [
    { name: '–ö–∞–ø—É—á–∏–Ω–æ 250 –º–ª', kcalPer100: 55, source: 'base' },
    { name: '–ö–∞–ø—É—á–∏–Ω–æ 350 –º–ª', kcalPer100: 55, source: 'base' },
    { name: '–ê–º–µ—Ä–∏–∫–∞–Ω–æ –±–µ–∑ —Å–∞—Ö–∞—Ä–∞', kcalPer100: 2, source: 'base' },
    { name: '–õ–∞—Ç—Ç–µ 300 –º–ª', kcalPer100: 60, source: 'base' },

    { name: '–ü–æ–∫–µ —Å –∫—É—Ä–∏—Ü–µ–π', kcalPer100: 130, source: 'base' },
    { name: '–ü–æ–∫–µ —Å –ª–æ—Å–æ—Å–µ–º', kcalPer100: 160, source: 'base' },

    { name: '–†–æ–ª–ª –§–∏–ª–∞–¥–µ–ª—å—Ñ–∏—è', kcalPer100: 220, source: 'base' },
    { name: '–°—É—à–∏ —Å –ª–æ—Å–æ—Å–µ–º', kcalPer100: 190, source: 'base' },

    { name: '–°—É–ø –¢–æ–º –Ø–º', kcalPer100: 90, source: 'base' },
    { name: '–°—ã—Ä–Ω—ã–π –ø–∏—Ä–æ–≥', kcalPer100: 280, source: 'base' },

    { name: '–ö—É—Ä–∏–Ω–∞—è –≥—Ä—É–¥–∫–∞ (–≤–∞—Ä—ë–Ω–∞—è)', kcalPer100: 165, source: 'base' },
    { name: '–ö—É—Ä–∏–Ω–æ–µ —Ñ–∏–ª–µ (–∂–∞—Ä–µ–Ω–æ–µ)', kcalPer100: 210, source: 'base' },
    { name: '–ì–æ–≤—è–¥–∏–Ω–∞ –æ—Ç–≤–∞—Ä–Ω–∞—è', kcalPer100: 190, source: 'base' },
    { name: '–†–∏—Å –æ—Ç–≤–∞—Ä–Ω–æ–π', kcalPer100: 110, source: 'base' },
    { name: '–ì—Ä–µ—á–∫–∞ –æ—Ç–≤–∞—Ä–Ω–∞—è', kcalPer100: 110, source: 'base' },
    { name: '–ú–∞–∫–∞—Ä–æ–Ω—ã –æ—Ç–≤–∞—Ä–Ω—ã–µ', kcalPer100: 130, source: 'base' },
    { name: '–ö–∞—Ä—Ç–æ—Ñ–µ–ª—å –æ—Ç–≤–∞—Ä–Ω–æ–π', kcalPer100: 80, source: 'base' },
    { name: '–ö–∞—Ä—Ç–æ—Ñ–µ–ª—å —Ñ—Ä–∏', kcalPer100: 320, source: 'base' },
    { name: '–Ø–π—Ü–æ –∫—É—Ä–∏–Ω–æ–µ –≤–∞—Ä—ë–Ω–æ–µ', kcalPer100: 155, source: 'base' },
    { name: '–û–º–ª–µ—Ç', kcalPer100: 190, source: 'base' },

    { name: '–Ø–±–ª–æ–∫–æ', kcalPer100: 50, source: 'base' },
    { name: '–ë–∞–Ω–∞–Ω', kcalPer100: 90, source: 'base' },
    { name: '–ê–ø–µ–ª—å—Å–∏–Ω', kcalPer100: 45, source: 'base' },
    { name: '–ì—Ä—É—à–∞', kcalPer100: 57, source: 'base' },

    { name: '–°–∞–ª–∞—Ç –¶–µ–∑–∞—Ä—å', kcalPer100: 180, source: 'base' },
    { name: '–ë—É—Ä–≥–µ—Ä –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π', kcalPer100: 250, source: 'base' },
    { name: '–ü–∏—Ü—Ü–∞ –ú–∞—Ä–≥–∞—Ä–∏—Ç–∞', kcalPer100: 220, source: 'base' },
    { name: '–®–æ–∫–æ–ª–∞–¥ –º–æ–ª–æ—á–Ω—ã–π', kcalPer100: 550, source: 'base' },
    { name: '–ú–æ—Ä–æ–∂–µ–Ω–æ–µ –ø–ª–æ–º–±–∏—Ä', kcalPer100: 220, source: 'base' }
  ];

  let state = {
    entries: [],       // {id,date,time,name,calories,weightGrams,kcalPer100,mealType,note}
    customProducts: [] // {name,kcalPer100,source:'custom'}
  };

  let chartDaily = null;
  let chartCategory = null;

  // –≠–õ–ï–ú–ï–ù–¢–´
  const tabButtons = document.querySelectorAll('.tab-btn');
  const tabContents = document.querySelectorAll('.tab-content');

  const monthSelector = document.getElementById('monthSelector');
  const btnSetCurrentMonth = document.getElementById('btnSetCurrentMonth');

  // Diary
  const fileInput = document.getElementById('fileInput');
  const imagePreview = document.getElementById('imagePreview');
  const entryDate = document.getElementById('entryDate');
  const entryTime = document.getElementById('entryTime');
  const foodName = document.getElementById('foodName');
  const kcalPer100Input = document.getElementById('kcalPer100');
  const weightGramsInput = document.getElementById('weightGrams');
  const caloriesInput = document.getElementById('calories');
  const mealTypeInput = document.getElementById('mealType');
  const noteInput = document.getElementById('note');
  const btnAnalyzeImage = document.getElementById('btnAnalyzeImage');
  const btnAddEntry = document.getElementById('btnAddEntry');
  const btnCalcFrom100 = document.getElementById('btnCalcFrom100');
  const btnCopyToProducts = document.getElementById('btnCopyToProducts');
  const aiError = document.getElementById('aiError');
  const entryError = document.getElementById('entryError');
  const recentList = document.getElementById('recentList');
  const statToday = document.getElementById('statToday');
  const statMonthShort = document.getElementById('statMonthShort');
  const statTargetDay = document.getElementById('statTargetDay');

  const quickProductSearch = document.getElementById('quickProductSearch');
  const btnClearQuickSearch = document.getElementById('btnClearQuickSearch');
  const quickProductList = document.getElementById('quickProductList');

  // Products
  const productSearchInput = document.getElementById('productSearchInput');
  const productSourceFilter = document.getElementById('productSourceFilter');
  const productList = document.getElementById('productList');
  const customProdName = document.getElementById('customProdName');
  const customProdKcal = document.getElementById('customProdKcal');
  const btnAddCustomProduct = document.getElementById('btnAddCustomProduct');
  const productError = document.getElementById('productError');

  // Analytics
  const targetKcalInput = document.getElementById('targetKcalInput');
  const btnSaveTarget = document.getElementById('btnSaveTarget');
  const chartDailyEl = document.getElementById('chartDaily');
  const chartCategoryEl = document.getElementById('chartCategory');
  const statTotalMonth = document.getElementById('statTotalMonth');
  const statAvgPerDay = document.getElementById('statAvgPerDay');
  const statMaxDay = document.getElementById('statMaxDay');
  const aiSummaryText = document.getElementById('aiSummaryText');

  // Settings
  const apiKeyInput = document.getElementById('apiKeyInput');
  const modelInput = document.getElementById('modelInput');
  const btnSaveApi = document.getElementById('btnSaveApi');
  const btnClearApi = document.getElementById('btnClearApi');

  // –¢–∞–±—ã
  tabButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      tabButtons.forEach(b => b.classList.remove('active'));
      tabContents.forEach(c => c.classList.remove('active'));
      btn.classList.add('active');
      const id = btn.getAttribute('data-tab');
      document.getElementById(id).classList.add('active');
      if (id === 'tab-analytics') {
        renderCharts();
        renderAnalytics();
      }
    });
  });

  // –ú–µ—Å—è—Ü
  function setCurrentMonthValue() {
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, '0');
    monthSelector.value = `${y}-${m}`;
  }
  btnSetCurrentMonth.addEventListener('click', () => {
    setCurrentMonthValue();
    onMonthChange();
  });
  monthSelector.addEventListener('change', onMonthChange);

  function getActiveMonthKey() {
    if (!monthSelector.value) {
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, '0');
      return `${y}-${m}`;
    }
    return monthSelector.value;
  }

  function daysInMonth(monthKey) {
    const [yearStr, monthStr] = monthKey.split('-');
    const year = parseInt(yearStr, 10);
    const month = parseInt(monthStr, 10);
    return new Date(year, month, 0).getDate();
  }

  // LocalStorage
  function loadState() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (raw) {
        const data = JSON.parse(raw);
        if (Array.isArray(data.entries)) state.entries = data.entries;
        if (Array.isArray(data.customProducts)) state.customProducts = data.customProducts;
      }
      const apiKey = localStorage.getItem(API_KEY_STORAGE) || '';
      if (apiKey) apiKeyInput.value = apiKey;
      const model = localStorage.getItem(MODEL_STORAGE) || '';
      if (model) modelInput.value = model;
      const target = localStorage.getItem(TARGET_STORAGE) || '';
      if (target) targetKcalInput.value = target;
    } catch(e) {
      console.error('loadState error', e);
    }
  }

  function saveState() {
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    } catch(e) {
      console.error('saveState error', e);
    }
  }

  function formatNumber(v) {
    if (v == null || isNaN(v)) return '‚Äî';
    return v.toLocaleString('ru-RU', { maximumFractionDigits: 0 });
  }

  // –î–∞—Ç–∞/–≤—Ä–µ–º—è
  function setTodayDateTime() {
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, '0');
    const day = String(d.getDate()).padStart(2, '0');
    entryDate.value = `${y}-${m}-${day}`;
    const hh = String(d.getHours()).padStart(2, '0');
    const mm = String(d.getMinutes()).padStart(2, '0');
    entryTime.value = `${hh}:${mm}`;
  }

  // –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
  fileInput.addEventListener('change', () => {
    const file = fileInput.files && fileInput.files[0];
    if (!file) {
      imagePreview.style.display = 'none';
      imagePreview.src = '';
      return;
    }
    const reader = new FileReader();
    reader.onload = (e) => {
      imagePreview.src = e.target.result;
      imagePreview.style.display = 'block';
    };
    reader.readAsDataURL(file);
  });

  // API –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
  btnSaveApi.addEventListener('click', () => {
    const key = apiKeyInput.value.trim();
    const model = modelInput.value.trim();
    localStorage.setItem(API_KEY_STORAGE, key);
    localStorage.setItem(MODEL_STORAGE, model || 'gpt-4.1-mini');
    alert('API –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã.');
  });
  btnClearApi.addEventListener('click', () => {
    apiKeyInput.value = '';
    modelInput.value = 'gpt-4.1-mini';
    localStorage.removeItem(API_KEY_STORAGE);
    localStorage.removeItem(MODEL_STORAGE);
  });

  function getApiKey() {
    return apiKeyInput.value.trim();
  }
  function getModelName() {
    return (modelInput.value || 'gpt-4.1-mini').trim();
  }

  // –¶–µ–ª—å
  btnSaveTarget.addEventListener('click', () => {
    const v = targetKcalInput.value.trim();
    localStorage.setItem(TARGET_STORAGE, v || '');
    renderTodayAndMonthStats();
    renderAnalytics();
    alert('–¶–µ–ª—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞.');
  });

  // AI —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
  btnAnalyzeImage.addEventListener('click', async () => {
    aiError.textContent = '';
    const apiKey = getApiKey();
    const model = getModelName();

    if (!apiKey) {
      aiError.textContent = '–°–Ω–∞—á–∞–ª–∞ –≤–≤–µ–¥–∏ API key –≤–æ –≤–∫–ª–∞–¥–∫–µ ¬´API / –Ω–∞—Å—Ç—Ä–æ–π–∫–∏¬ª.';
      return;
    }
    const file = fileInput.files && fileInput.files[0];
    if (!file) {
      aiError.textContent = '–í—ã–±–µ—Ä–∏ –∏–ª–∏ —Å–¥–µ–ª–∞–π —Ñ–æ—Ç–æ –±–ª—é–¥–∞.';
      return;
    }

    try {
      btnAnalyzeImage.disabled = true;
      btnAnalyzeImage.textContent = '–†–∞—Å–ø–æ–∑–Ω–∞—é...';

      const base64 = await fileToBase64(file); // data:...

      const payload = {
        model,
        messages: [
          {
            role: "user",
            content: [
              {
                type: "text",
                text:
`–¢—ã –Ω—É—Ç—Ä–∏—Ü–∏–æ–Ω–∏—Å—Ç. –ü–æ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –æ—Ü–µ–Ω–∫–∏:
- –∫—Ä–∞—Ç–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –±–ª—é–¥–∞ (–Ω–∞ —Ä—É—Å—Å–∫–æ–º),
- –ø—Ä–∏–º–µ—Ä–Ω–∞—è –∫–∞–ª–æ—Ä–∏–π–Ω–æ—Å—Ç—å (–∫–∫–∞–ª) –≤—Å–µ–≥–æ –±–ª—é–¥–∞,
- –ø—Ä–∏–º–µ—Ä–Ω–∞—è –º–∞—Å—Å–∞ –±–ª—é–¥–∞ (–≥—Ä–∞–º–º—ã),
- –∫–∞—Ç–µ–≥–æ—Ä–∏—è/—Ç–∏–ø (–Ω–∞–ø—Ä–∏–º–µ—Ä: –∫–æ—Ñ–µ, –¥–µ—Å–µ—Ä—Ç, –æ—Å–Ω–æ–≤–Ω–æ–µ, —Ñ–∞—Å—Ç—Ñ—É–¥, —Å–∞–ª–∞—Ç, –Ω–∞–ø–∏—Ç–æ–∫).

–û—Ç–≤–µ—Ç—å —Å—Ç—Ä–æ–≥–æ –≤ JSON –±–µ–∑ –ø–æ—è—Å–Ω–µ–Ω–∏–π:
{"name":"...","calories":123,"weight_grams":250,"category":"..."}`
              },
              {
                type: "image_url",
                image_url: {
                  url: base64 // —ç—Ç–æ data URL
                }
              }
            ]
          }
        ],
        max_tokens: 300
      };

      const response = await fetch("https://api.openai.com/v1/chat/completions", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${apiKey}`
        },
        body: JSON.stringify(payload)
      });

      if (!response.ok) {
        const text = await response.text();
        console.error('OpenAI error:', text);
        aiError.textContent = '–û—à–∏–±–∫–∞ API: ' + response.status;
        return;
      }

      const data = await response.json();
      const content = data.choices?.[0]?.message?.content?.trim();
      if (!content) {
        aiError.textContent = '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç –æ—Ç –º–æ–¥–µ–ª–∏.';
        return;
      }

      let parsed;
      try {
        parsed = JSON.parse(content);
      } catch(e) {
        console.warn('Cannot parse JSON, raw content:', content);
        aiError.textContent = '–ú–æ–¥–µ–ª—å –≤–µ—Ä–Ω—É–ª–∞ –æ—Ç–≤–µ—Ç –Ω–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON. –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑.';
        return;
      }

      if (parsed.name) foodName.value = parsed.name;
      if (parsed.weight_grams != null) weightGramsInput.value = Math.round(parsed.weight_grams);
      if (parsed.calories != null) {
        const w = parsed.weight_grams || 100;
        const per100 = parsed.calories / (w / 100);
        kcalPer100Input.value = Math.round(per100);
        caloriesInput.value = Math.round(parsed.calories);
      }
      if (parsed.category) {
        if (!mealTypeInput.value) mealTypeInput.value = parsed.category;
      }

    } catch(e) {
      console.error(e);
      aiError.textContent = '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è.';
    } finally {
      btnAnalyzeImage.disabled = false;
      btnAnalyzeImage.textContent = 'ü§ñ –†–∞—Å–ø–æ–∑–Ω–∞—Ç—å —Å AI';
    }
  });

  function fileToBase64(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result);
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }

  // –†–∞—Å—á—ë—Ç –∫–∫–∞–ª –ø–æ 100 –≥
  btnCalcFrom100.addEventListener('click', () => {
    const per100 = parseFloat(kcalPer100Input.value);
    const grams = parseFloat(weightGramsInput.value);
    if (isNaN(per100) || per100 <= 0 || isNaN(grams) || grams <= 0) {
      entryError.textContent = '–£–∫–∞–∂–∏ –∫–∫–∞–ª –Ω–∞ 100 –≥ –∏ –º–∞—Å—Å—É –±–ª—é–¥–∞.';
      return;
    }
    entryError.textContent = '';
    const total = per100 * grams / 100;
    caloriesInput.value = Math.round(total);
  });

  // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞–∫ –ø—Ä–æ–¥—É–∫—Ç
  btnCopyToProducts.addEventListener('click', () => {
    const name = foodName.value.trim();
    const per100 = parseFloat(kcalPer100Input.value);
    if (!name || isNaN(per100) || per100 <= 0) {
      entryError.textContent = '–ß—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç, —É–∫–∞–∂–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ –∫–∫–∞–ª –Ω–∞ 100 –≥.';
      return;
    }
    entryError.textContent = '';
    state.customProducts.push({ name, kcalPer100: per100, source: 'custom' });
    saveState();
    renderProductLists();
    alert('–ü—Ä–æ–¥—É–∫—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤ –±–∞–∑—É.');
  });

  // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –≤ –¥–Ω–µ–≤–Ω–∏–∫
  btnAddEntry.addEventListener('click', () => {
    entryError.textContent = '';

    const date = entryDate.value;
    let time = (entryTime.value || '').trim();
    const name = foodName.value.trim();
    const per100 = parseFloat(kcalPer100Input.value);
    const grams = parseFloat(weightGramsInput.value);
    const kcal = parseFloat(caloriesInput.value);
    const mealType = mealTypeInput.value.trim();
    const note = noteInput.value.trim();

    if (!date) {
      entryError.textContent = '–£–∫–∞–∂–∏ –¥–∞—Ç—É.';
      return;
    }
    if (!name) {
      entryError.textContent = '–ù–∞–∑–≤–∞–Ω–∏–µ –±–ª—é–¥–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º.';
      return;
    }

    let finalKcal = kcal;
    if ((isNaN(finalKcal) || finalKcal <= 0) && !isNaN(per100) && !isNaN(grams) && per100>0 && grams>0) {
      finalKcal = per100 * grams / 100;
    }
    if (isNaN(finalKcal) || finalKcal <= 0) {
      entryError.textContent = '–£–∫–∞–∂–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∫–∫–∞–ª (–∏–ª–∏ –ø–µ—Ä100+–≥—Ä–∞–º–º—ã).';
      return;
    }

    if (!time) {
      const d = new Date();
      const hh = String(d.getHours()).padStart(2,'0');
      const mm = String(d.getMinutes()).padStart(2,'0');
      time = `${hh}:${mm}`;
    }

    state.entries.push({
      id: Date.now() + '_' + Math.random().toString(16).slice(2),
      date,
      time,
      name,
      calories: Math.round(finalKcal),
      weightGrams: isNaN(grams) ? null : grams,
      kcalPer100: isNaN(per100) ? null : per100,
      mealType,
      note
    });
    saveState();

    renderRecent();
    renderTodayAndMonthStats();
    renderJournalTable();
    renderCharts();
    renderAnalytics();
  });

  // –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–ø–∏—Å–∏
  function renderRecent() {
    const monthKey = getActiveMonthKey();
    const entries = state.entries
      .filter(e => e.date && e.date.startsWith(monthKey))
      .sort((a,b) => (b.date + (b.time||'')) .localeCompare(a.date + (a.time||'')));

    if (!entries.length) {
      recentList.innerHTML = '<div class="small">–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π –∑–∞ —ç—Ç–æ—Ç –º–µ—Å—è—Ü.</div>';
      return;
    }

    recentList.innerHTML = '';
    entries.slice(0,20).forEach(e => {
      const div = document.createElement('div');
      div.className = 'recent-item';
      div.innerHTML = `
        <div class="recent-main">
          <div class="recent-name">${escapeHtml(e.name)}</div>
          <div class="recent-meta">
            ${escapeHtml(e.date)} ¬∑ ${escapeHtml(e.time || '')}
            ¬∑ ${formatNumber(e.calories)} –∫–∫–∞–ª
            ${e.mealType ? (' ¬∑ ' + escapeHtml(e.mealType)) : ''}
          </div>
        </div>
        <button class="btn-danger btn-xs" data-id="${e.id}">‚úï</button>
      `;
      recentList.appendChild(div);
    });

    recentList.querySelectorAll('button[data-id]').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = btn.getAttribute('data-id');
        if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–ø–∏—Å—å?')) return;
        state.entries = state.entries.filter(e => String(e.id) !== String(id));
        saveState();
        renderRecent();
        renderTodayAndMonthStats();
        renderJournalTable();
        renderCharts();
        renderAnalytics();
      });
    });
  }

  function renderTodayAndMonthStats() {
    const today = entryDate.value;
    const monthKey = getActiveMonthKey();
    const target = parseFloat(targetKcalInput.value) || null;

    const todayEntries = state.entries.filter(e => e.date === today);
    const monthEntries = state.entries.filter(e => e.date && e.date.startsWith(monthKey));

    const todayKcal = todayEntries.reduce((s,e)=>s+(e.calories||0),0);
    const monthKcal = monthEntries.reduce((s,e)=>s+(e.calories||0),0);

    statToday.textContent = todayEntries.length ? (formatNumber(todayKcal) + ' –∫–∫–∞–ª') : '‚Äî';
    statMonthShort.textContent = monthEntries.length ? (formatNumber(monthKcal) + ' –∫–∫–∞–ª') : '‚Äî';

    statTargetDay.textContent = target ? (formatNumber(target) + ' –∫–∫–∞–ª') : '‚Äî';
  }

  // –ñ–£–†–ù–ê–õ (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–∞–±–ª–∏—Ü—É –≤ analytics —Ç–∞–±–µ? –º—ã —Å–¥–µ–ª–∞–µ–º –æ—Ç–¥–µ–ª—å–Ω—É—é —Ç–∞–±–ª–∏—Ü—É –∑–¥–µ—Å—å? ‚Äî —É –Ω–∞—Å –∂—É—Ä–Ω–∞–ª –≤ —Ç–∞–±–µ products? –Ω–µ—Ç; –≤ —ç—Ç–æ–π –≤–µ—Ä—Å–∏–∏ –∂—É—Ä–Ω–∞–ª –≤ analytics –Ω–µ –Ω—É–∂–µ–Ω, –ø–æ—ç—Ç–æ–º—É —Å–¥–µ–ª–∞–ª–∏ —Ç–æ–ª—å–∫–æ recent + analytics. –û—Å—Ç–∞–≤–∏–º —Ç–æ–ª—å–∫–æ analytics —Ç–∞–±–ª–∏—Ü—ã? –ß—Ç–æ–±—ã –Ω–µ —É—Å–ª–æ–∂–Ω—è—Ç—å, –æ—Ç–¥–µ–ª—å–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã –Ω–µ –¥–µ–ª–∞–µ–º. –ù–æ —Ñ—É–Ω–∫—Ü–∏—è journal —É–ø–æ–º—è–Ω—É—Ç–∞ ‚Äî —É –Ω–∞—Å –µ—ë –Ω–µ—Ç. –î–æ–±–∞–≤–∏–º –ø—Ä–æ—Å—Ç—É—é —Ç–∞–±–ª–∏—Ü—É –≤–æ –≤–∫–ª–∞–¥–∫—É analytics? –£–∂–µ –∫—Ä—É–ø–Ω–∞—è. –õ—É—á—à–µ –ø—Ä–æ—Å—Ç—É—é —Ç–∞–±–ª–∏—Ü—É –≤ journaling? –û–ö, —Å–¥–µ–ª–∞–µ–º —Ç—É—Ç: -->
  // –í —ç—Ç–æ–π –≤–µ—Ä—Å–∏–∏ –∂—É—Ä–Ω–∞–ª = –≤–∫–ª–∞–¥–∫–∞ "–ñ—É—Ä–Ω–∞–ª" ‚Äî –Ω–æ –º—ã –µ—ë –Ω–µ –¥–æ–±–∞–≤–ª—è–ª–∏ –æ—Ç–¥–µ–ª—å–Ω–æ.
  // –î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã: –±—É–¥–µ–º —Å—á–∏—Ç–∞—Ç—å, —á—Ç–æ "–ñ—É—Ä–Ω–∞–ª" = —Ç–∞–± analytics? –ß—Ç–æ–±—ã –Ω–µ –ª–æ–º–∞—Ç—å, —Å–æ–∑–¥–∞–¥–∏–º –ø—Ä–æ—Å—Ç—É—é —Ñ—É–Ω–∫—Ü–∏—é-–∑–∞–≥–ª—É—à–∫—É:
  function renderJournalTable() {
    // –ú–æ–∂–Ω–æ –≤ –±—É–¥—É—â–µ–º –¥–æ–±–∞–≤–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É; —Å–µ–π—á–∞—Å –ø—Ä–æ—Å—Ç–æ –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º.
  }

  // –ë–∞–∑–∞ –ø—Ä–æ–¥—É–∫—Ç–æ–≤: —Ä–µ–Ω–¥–µ—Ä
  function getAllProducts() {
    return [...BASE_PRODUCTS, ...state.customProducts];
  }

  function renderProductLists() {
    renderFullProductList();
    renderQuickProductList();
  }

  function renderFullProductList() {
    const search = (productSearchInput.value || '').toLowerCase();
    const sourceFilter = productSourceFilter.value;
    const products = getAllProducts().filter(p => {
      if (sourceFilter && p.source !== sourceFilter) return false;
      if (!search) return true;
      return p.name.toLowerCase().includes(search);
    }).sort((a,b)=>a.name.localeCompare(b.name,'ru'));

    if (!products.length) {
      productList.innerHTML = '<div class="small">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.</div>';
      return;
    }

    productList.innerHTML = '';
    products.forEach(p => {
      const div = document.createElement('div');
      div.className = 'product-item';
      div.innerHTML = `
        <div>
          <div class="product-name">${escapeHtml(p.name)}</div>
          <div class="product-kcal">${p.source === 'custom' ? '–ú–æ–π –ø—Ä–æ–¥—É–∫—Ç ¬∑ ' : ''}${p.kcalPer100} –∫–∫–∞–ª / 100 –≥</div>
        </div>
        <button class="btn-soft btn-xs">–í —Ñ–æ—Ä–º—É ‚Üë</button>
      `;
      div.addEventListener('click', (ev) => {
        if (ev.target.tagName.toLowerCase() === 'button' || ev.currentTarget === div) {
          foodName.value = p.name;
          kcalPer100Input.value = p.kcalPer100;
        }
      });
      productList.appendChild(div);
    });
  }

  function renderQuickProductList() {
    const search = (quickProductSearch.value || '').toLowerCase();
    const products = getAllProducts().filter(p => {
      if (!search) return true;
      return p.name.toLowerCase().includes(search);
    }).slice(0, 30);

    if (!products.length) {
      quickProductList.innerHTML = '<div class="small">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.</div>';
      return;
    }

    quickProductList.innerHTML = '';
    products.forEach(p => {
      const div = document.createElement('div');
      div.className = 'product-item';
      div.innerHTML = `
        <div>
          <div class="product-name">${escapeHtml(p.name)}</div>
          <div class="product-kcal">${p.kcalPer100} –∫–∫–∞–ª / 100 –≥</div>
        </div>
      `;
      div.addEventListener('click', () => {
        foodName.value = p.name;
        kcalPer100Input.value = p.kcalPer100;
      });
      quickProductList.appendChild(div);
    });
  }

  productSearchInput.addEventListener('input', renderFullProductList);
  productSourceFilter.addEventListener('change', renderFullProductList);
  quickProductSearch.addEventListener('input', renderQuickProductList);
  btnClearQuickSearch.addEventListener('click', () => {
    quickProductSearch.value = '';
    renderQuickProductList();
  });

  btnAddCustomProduct.addEventListener('click', () => {
    const name = customProdName.value.trim();
    const kcal = parseFloat(customProdKcal.value);
    if (!name) {
      productError.textContent = '–£–∫–∞–∂–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞.';
      return;
    }
    if (isNaN(kcal) || kcal <= 0) {
      productError.textContent = '–£–∫–∞–∂–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∫–∫–∞–ª –Ω–∞ 100 –≥.';
      return;
    }
    productError.textContent = '';
    state.customProducts.push({ name, kcalPer100: kcal, source: 'custom' });
    saveState();
    customProdName.value = '';
    customProdKcal.value = '';
    renderProductLists();
  });

  // –ß–∞—Ä—Ç—ã
  function renderCharts() {
    const monthKey = getActiveMonthKey();
    const entries = state.entries.filter(e => e.date && e.date.startsWith(monthKey));

    if (chartDaily) chartDaily.destroy();
    if (chartCategory) chartCategory.destroy();

    const daysCount = daysInMonth(monthKey);
    if (!daysCount) return;

    const dailyMap = new Array(daysCount).fill(0);
    entries.forEach(e => {
      const d = parseInt(e.date.slice(8,10),10);
      if (!isNaN(d) && d>=1 && d<=daysCount) {
        dailyMap[d-1] += e.calories || 0;
      }
    });
    const labels = Array.from({length:daysCount}, (_,i)=>String(i+1));

    chartDaily = new Chart(chartDailyEl, {
      type: 'bar',
      data: {
        labels,
        datasets: [{
          label: '–ö–∫–∞–ª',
          data: dailyMap,
          borderColor: '#38bdf8',
          backgroundColor: 'rgba(56,189,248,0.6)'
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { labels: { font: { size: 10 } } }
        },
        scales: {
          x: { ticks: { font: { size: 9 } } },
          y: { ticks: { font: { size: 9 } } }
        }
      }
    });

    const categoryMap = {};
    entries.forEach(e => {
      const cat = (e.note || e.mealType || '–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏').split(',')[0].trim() || '–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏';
      if (!categoryMap[cat]) categoryMap[cat] = 0;
      categoryMap[cat] += e.calories || 0;
    });
    const catLabels = Object.keys(categoryMap);
    const catValues = catLabels.map(k => categoryMap[k]);
    const colors = [
      'rgba(56,189,248,0.8)',
      'rgba(251,146,60,0.85)',
      'rgba(52,211,153,0.85)',
      'rgba(248,113,113,0.85)',
      'rgba(129,140,248,0.85)',
      'rgba(253,224,71,0.85)',
      'rgba(248,250,252,0.85)'
    ];

    chartCategory = new Chart(chartCategoryEl, {
      type: 'doughnut',
      data: {
        labels: catLabels,
        datasets: [{
          data: catValues,
          backgroundColor: catLabels.map((_,i)=>colors[i % colors.length]),
          borderColor: '#020617',
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { labels: { font: { size: 10 } } }
        }
      }
    });
  }

  // –ê–Ω–∞–ª–∏—Ç–∏–∫–∞
  function renderAnalytics() {
    const monthKey = getActiveMonthKey();
    const entries = state.entries.filter(e => e.date && e.date.startsWith(monthKey));
    if (!entries.length) {
      statTotalMonth.textContent = '‚Äî';
      statAvgPerDay.textContent = '‚Äî';
      statMaxDay.textContent = '‚Äî';
      aiSummaryText.textContent = '–ü–æ–∫–∞ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ —ç—Ç–æ—Ç –º–µ—Å—è—Ü. –ö–∞–∫ —Ç–æ–ª—å–∫–æ –≤–Ω–µ—Å—ë—à—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –¥–Ω–µ–π –ø–∏—Ç–∞–Ω–∏—è, –ø–æ—è–≤–∏—Ç—Å—è –º–∏–Ω–∏-—Ä–∞–∑–±–æ—Ä.';
      return;
    }

    const total = entries.reduce((s,e)=>s+(e.calories||0),0);

    const dailyMap = {};
    entries.forEach(e => {
      if (!dailyMap[e.date]) dailyMap[e.date] = 0;
      dailyMap[e.date] += e.calories || 0;
    });
    const days = Object.keys(dailyMap);
    const avgPerDay = total / days.length;
    let maxDay = null;
    let maxVal = -Infinity;
    days.forEach(d => {
      if (dailyMap[d] > maxVal) {
        maxVal = dailyMap[d];
        maxDay = d;
      }
    });

    statTotalMonth.textContent = formatNumber(total) + ' –∫–∫–∞–ª';
    statAvgPerDay.textContent = formatNumber(avgPerDay) + ' –∫–∫–∞–ª';
    statMaxDay.textContent = maxDay ? (maxDay + ' ¬∑ ' + formatNumber(maxVal) + ' –∫–∫–∞–ª') : '‚Äî';

    const target = parseFloat(targetKcalInput.value) || null;

    let text = '';
    text += `–ó–∞ –º–µ—Å—è—Ü ${monthKey} —Å—É–º–º–∞—Ä–Ω–æ —Å—ä–µ–¥–µ–Ω–æ –æ–∫–æ–ª–æ ${formatNumber(total)} –∫–∫–∞–ª.\n\n`;
    text += `–î–Ω–µ–π —Å –∑–∞–ø–∏—Å—è–º–∏: ${days.length}. –°—Ä–µ–¥–Ω—è—è –∫–∞–ª–æ—Ä–∏–π–Ω–æ—Å—Ç—å –¥–Ω—è: ~${formatNumber(avgPerDay)} –∫–∫–∞–ª.`;
    if (maxDay) {
      text += `\n–°–∞–º—ã–π ¬´—Ç—è–∂—ë–ª—ã–π¬ª –¥–µ–Ω—å: ${maxDay} ‚Äî –ø—Ä–∏–º–µ—Ä–Ω–æ ${formatNumber(maxVal)} –∫–∫–∞–ª.`;
    }

    if (target) {
      const diff = avgPerDay - target;
      if (diff > 150) {
        text += `\n\n–ü–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—é —Å —Ü–µ–ª—å—é –≤ ${formatNumber(target)} –∫–∫–∞–ª —Ç–≤–æ–π —Å—Ä–µ–¥–Ω–∏–π –¥–µ–Ω—å –≤—ã—à–µ –Ω–∞ ~${formatNumber(diff)} –∫–∫–∞–ª. –≠—Ç–æ –ø–æ–≤–æ–¥ —á—É—Ç—å –ø–æ–¥–∂–∞—Ç—å –∫–∞–ª–æ—Ä–∏–π–Ω–æ—Å—Ç—å –∏–ª–∏ –¥–æ–±–∞–≤–∏—Ç—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏.`;
      } else if (diff < -150) {
        text += `\n\n–°—Ä–µ–¥–Ω–∏–π –¥–µ–Ω—å –Ω–∏–∂–µ —Ü–µ–ª–∏ –Ω–∞ ~${formatNumber(-diff)} –∫–∫–∞–ª. –ï—Å–ª–∏ —Ü–µ–ª—å ‚Äî –Ω–µ —Ö—É–¥–µ—Ç—å —Å–ª–∏—à–∫–æ–º –±—ã—Å—Ç—Ä–æ, –º–æ–∂–Ω–æ –Ω–µ–º–Ω–æ–≥–æ –ø–æ–¥–Ω—è—Ç—å –∫–∞–ª–æ—Ä–∏–π–Ω–æ—Å—Ç—å.`;
      } else {
        text += `\n\n–°—Ä–µ–¥–Ω—è—è –∫–∞–ª–æ—Ä–∏–π–Ω–æ—Å—Ç—å –±–ª–∏–∑–∫–∞ –∫ —Ü–µ–ª–∏ ${formatNumber(target)} –∫–∫–∞–ª ‚Äî —ç—Ç–æ –¥–æ–≤–æ–ª—å–Ω–æ —Å—Ç–∞–±–∏–ª—å–Ω—ã–π —Ä–µ–∂–∏–º.`;
      }
    }

    const categoryMap = {};
    entries.forEach(e => {
      const cat = (e.note || e.mealType || '–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏').split(',')[0].trim() || '–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏';
      if (!categoryMap[cat]) categoryMap[cat] = 0;
      categoryMap[cat] += e.calories || 0;
    });
    const sortedCats = Object.entries(categoryMap).sort((a,b)=>b[1]-a[1]);
    if (sortedCats.length) {
      const top = sortedCats.slice(0,3).map(([c,v])=>`${c} (${formatNumber(v)} –∫–∫–∞–ª)`).join(', ');
      text += `\n\n–ü–æ ¬´–∫–∞—Ç–µ–≥–æ—Ä–∏—è–º¬ª –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ –∫–∞–ª–æ—Ä–∏–π –¥–∞—é—Ç: ${top}.`;
    }

    aiSummaryText.textContent = text;
  }

  function escapeHtml(str) {
    return String(str)
      .replace(/&/g,'&amp;')
      .replace(/</g,'&lt;')
      .replace(/>/g,'&gt;')
      .replace(/"/g,'&quot;')
      .replace(/'/g,'&#39;');
  }

  function onMonthChange() {
    const monthKey = getActiveMonthKey();
    if (!entryDate.value || !entryDate.value.startsWith(monthKey)) {
      const [y,m] = monthKey.split('-');
      const d = new Date();
      const day = String(Math.min(d.getDate(), daysInMonth(monthKey))).padStart(2,'0');
      entryDate.value = `${y}-${m}-${day}`;
    }
    renderRecent();
    renderTodayAndMonthStats();
    renderProductLists();
    renderCharts();
    renderAnalytics();
  }

  function renderAll() {
    renderProductLists();
    onMonthChange();
  }

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
  loadState();
  setCurrentMonthValue();
  setTodayDateTime();
  renderAll();
</script>
</body>
</html>