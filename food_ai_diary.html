<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Food AI –¥–Ω–µ–≤–Ω–∏–∫</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root {
      --bg: #020617;
      --bg-card: #020617;
      --text: #f9fafb;
      --muted: #9ca3af;
      --blue: #38bdf8;
      --blue-soft: rgba(56,189,248,0.15);
      --orange: #fb923c;
      --orange-soft: rgba(251,146,60,0.18);
      --border: #1f2937;
      --danger: #f97373;
      --radius-lg: 20px;
      --radius-md: 14px;
      --shadow: 0 18px 40px rgba(15,23,42,0.9);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      min-height: 100vh;
      display: flex;
      justify-content: center;
      padding: 16px;
      background:
        radial-gradient(circle at top, #0b1120 0, #020617 45%, #020617 100%);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
      color: var(--text);
    }

    .app {
      width: 100%;
      max-width: 960px;
      background:
        radial-gradient(circle at top left, rgba(56,189,248,0.16), transparent 55%),
        radial-gradient(circle at top right, rgba(251,146,60,0.16), transparent 60%),
        var(--bg-card);
      border-radius: 26px;
      border: 1px solid rgba(148,163,184,0.6);
      box-shadow: var(--shadow);
      padding: 18px 18px 22px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .header {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
    }
    .title {
      font-size: 22px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .title span.icon {
      font-size: 26px;
    }
    .subtitle {
      font-size: 13px;
      color: var(--muted);
      margin-top: 4px;
      line-height: 1.4;
    }

    .pill-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 6px;
    }
    .pill {
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.7);
      padding: 3px 8px;
      font-size: 11px;
      color: var(--muted);
      background: rgba(15,23,42,0.92);
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .pill b { color: var(--blue); }

    .btn {
      border-radius: 999px;
      border: none;
      padding: 7px 12px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 5px;
      white-space: nowrap;
    }
    .btn-primary {
      background: linear-gradient(90deg,var(--blue),var(--orange));
      color: #f9fafb;
      box-shadow: 0 14px 30px rgba(37,99,235,0.7);
      border: none;
    }
    .btn-secondary {
      background: rgba(15,23,42,0.9);
      color: var(--muted);
      border: 1px solid rgba(148,163,184,0.7);
    }
    .btn-soft {
      background: rgba(15,23,42,0.7);
      color: var(--muted);
      border: 1px solid rgba(55,65,81,0.9);
    }
    .btn-danger {
      background: rgba(127,29,29,0.9);
      color: #fecaca;
      border: 1px solid rgba(248,113,113,0.8);
    }
    .btn-xs {
      padding: 3px 6px;
      font-size: 11px;
    }
    .btn:active {
      transform: translateY(1px);
      box-shadow: none;
    }

    .tabs {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 8px;
      border-bottom: 1px solid rgba(31,41,55,0.95);
      padding-bottom: 4px;
    }
    .tab-btn {
      border: none;
      background: transparent;
      color: var(--muted);
      padding: 7px 12px;
      font-size: 13px;
      border-radius: 999px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .tab-btn.active {
      background: var(--blue-soft);
      color: var(--blue);
      border: 1px solid rgba(56,189,248,0.7);
    }
    .tab-icon {
      font-size: 15px;
    }

    .tab-content {
      display: none;
      margin-top: 10px;
    }
    .tab-content.active {
      display: block;
    }

    .section {
      border-radius: var(--radius-lg);
      border: 1px solid rgba(31,41,55,0.95);
      padding: 12px 12px 14px;
      background: radial-gradient(circle at top, rgba(15,23,42,0.97), #020617);
      margin-bottom: 10px;
    }
    .section-title {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .section-title .icon {
      font-size: 16px;
    }
    .section-sub {
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 6px;
      line-height: 1.4;
    }

    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      margin-bottom: 6px;
    }
    label {
      font-size: 11px;
      color: var(--muted);
      display: flex;
      flex-direction: column;
      gap: 3px;
    }
    input[type="text"],
    input[type="number"],
    input[type="date"],
    input[type="password"],
    textarea {
      padding: 6px 8px;
      border-radius: 10px;
      border: 1px solid rgba(31,41,55,0.95);
      font-size: 13px;
      background: rgba(15,23,42,0.95);
      color: var(--text);
      min-width: 70px;
    }
    input[type="number"] {
      width: 110px;
    }
    textarea {
      min-height: 60px;
      resize: vertical;
    }

    .small {
      font-size: 11px;
      color: var(--muted);
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 8px;
      margin-top: 6px;
    }
    .stat-card {
      border-radius: var(--radius-md);
      border: 1px solid rgba(31,41,55,0.95);
      padding: 7px 9px;
      background: rgba(15,23,42,0.96);
    }
    .stat-label {
      font-size: 11px;
      color: var(--muted);
      margin-bottom: 2px;
    }
    .stat-value {
      font-size: 15px;
      font-weight: 600;
    }
    .stat-note {
      font-size: 10px;
      color: var(--muted);
      margin-top: 2px;
    }

    /* –§–æ—Ç–æ + –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä */
    .capture-layout {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.1fr);
      gap: 10px;
    }
    @media (max-width: 768px) {
      .app {
        padding: 14px 10px 16px;
        border-radius: 20px;
      }
      .capture-layout {
        grid-template-columns: 1fr;
      }
    }

    .image-box {
      border-radius: var(--radius-lg);
      border: 1px solid rgba(31,41,55,0.95);
      padding: 10px;
      background:
        radial-gradient(circle at top, rgba(56,189,248,0.18), transparent 60%),
        rgba(15,23,42,0.98);
    }
    .image-preview {
      width: 100%;
      max-height: 260px;
      object-fit: cover;
      border-radius: 14px;
      border: 1px solid rgba(148,163,184,0.6);
      margin-top: 8px;
    }

    .recent-list {
      border-radius: var(--radius-lg);
      border: 1px solid rgba(31,41,55,0.95);
      padding: 8px 9px;
      background: rgba(15,23,42,0.98);
      max-height: 260px;
      overflow: auto;
      font-size: 12px;
    }
    .recent-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 5px 0;
      border-bottom: 1px solid rgba(31,41,55,0.9);
    }
    .recent-item:last-child {
      border-bottom: none;
    }
    .recent-main {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .recent-name {
      font-weight: 600;
      font-size: 13px;
    }
    .recent-meta {
      font-size: 11px;
      color: var(--muted);
    }

    .error {
      font-size: 11px;
      color: var(--danger);
      min-height: 14px;
      margin-top: 4px;
    }

    .table-wrap {
      margin-top: 6px;
      border-radius: var(--radius-lg);
      border: 1px solid rgba(31,41,55,0.95);
      overflow: auto;
      max-height: 360px;
      background: rgba(15,23,42,0.96);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11.5px;
    }
    thead {
      background: rgba(15,23,42,0.98);
      position: sticky;
      top: 0;
      z-index: 1;
    }
    th, td {
      padding: 5px 6px;
      border-bottom: 1px solid rgba(31,41,55,0.95);
      text-align: left;
      white-space: nowrap;
    }
    th {
      font-weight: 600;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--muted);
    }
    tbody tr:nth-child(even) td { background: rgba(15,23,42,0.9); }
    tbody tr:nth-child(odd) td { background: rgba(15,23,42,0.86); }

    .charts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 10px;
      margin-top: 6px;
    }
    .chart-box {
      border-radius: var(--radius-lg);
      border: 1px solid rgba(31,41,55,0.95);
      padding: 8px 10px 10px;
      background: rgba(15,23,42,0.98);
    }
    .chart-title {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 4px;
    }
    canvas {
      width: 100%;
      height: 220px;
    }

    .ai-box {
      margin-top: 6px;
      border-radius: var(--radius-md);
      border: 1px solid rgba(251,146,60,0.8);
      padding: 6px 8px;
      background: rgba(30,64,175,0.75);
      font-size: 12px;
    }
    .ai-title {
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 3px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .ai-title .icon {
      font-size: 14px;
    }
    .ai-text {
      font-size: 11.5px;
      color: #fefce8;
      line-height: 1.5;
    }

  </style>
</head>
<body>
<div class="app">
  <div class="header">
    <div>
      <div class="title">
        <span class="icon">üç±</span>
        Food AI –¥–Ω–µ–≤–Ω–∏–∫
      </div>
      <div class="subtitle">
        –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—Ä—É–µ—à—å –µ–¥—É ‚Üí AI —Ä–∞—Å–ø–æ–∑–Ω–∞—ë—Ç –±–ª—é–¥–æ –∏ –∫–∞–ª–æ—Ä–∏–π–Ω–æ—Å—Ç—å ‚Üí –∑–∞–ø–∏—Å—å –≤ –¥–Ω–µ–≤–Ω–∏–∫ ‚Üí –≥—Ä–∞—Ñ–∏–∫–∏ –ø–æ –¥–Ω—è–º.
      </div>
      <div class="pill-row">
        <div class="pill">AI: <b>Vision —á–µ—Ä–µ–∑ OpenAI</b></div>
        <div class="pill">–•—Ä–∞–Ω–µ–Ω–∏–µ: <b>localStorage</b></div>
        <div class="pill">–§–æ—Ä–º–∞—Ç: <b>1 HTML-—Ñ–∞–π–ª</b></div>
      </div>
    </div>
    <div style="display:flex;flex-direction:column;align-items:flex-end;gap:4px;">
      <span class="small">–ê–∫—Ç–∏–≤–Ω—ã–π –º–µ—Å—è—Ü</span>
      <div style="display:flex;gap:6px;align-items:center;">
        <input type="month" id="monthSelector">
        <button class="btn-soft btn-xs" type="button" id="btnSetCurrentMonth">–°–µ–π—á–∞—Å</button>
      </div>
    </div>
  </div>

  <div class="tabs">
    <button class="tab-btn active" data-tab="tab-capture">
      <span class="tab-icon">üì∏</span>–§–æ—Ç–æ & –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ
    </button>
    <button class="tab-btn" data-tab="tab-journal">
      <span class="tab-icon">üìã</span>–ñ—É—Ä–Ω–∞–ª
    </button>
    <button class="tab-btn" data-tab="tab-analytics">
      <span class="tab-icon">üìä</span>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞
    </button>
    <button class="tab-btn" data-tab="tab-settings">
      <span class="tab-icon">‚öôÔ∏è</span>API / –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
    </button>
  </div>

  <!-- –§–æ—Ç–æ + –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ -->
  <div class="tab-content active" id="tab-capture">
    <div class="section">
      <div class="section-title">
        <span class="icon">üì∏</span>
        –°—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—Ä—É–π –µ–¥—É –∏ —Ä–∞—Å–ø–æ–∑–Ω–∞–π –∫–∫–∞–ª–æ—Ä–∏–∏
      </div>
      <div class="section-sub">
        –§–æ—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–æ–ª—å–∫–æ –¥–ª—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è ‚Äî –≤ –∂—É—Ä–Ω–∞–ª —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è —Ç–µ–∫—Å—Ç: –Ω–∞–∑–≤–∞–Ω–∏–µ –±–ª—é–¥–∞, –∫–∫–∞–ª, –¥–∞—Ç–∞, –∑–∞–º–µ—Ç–∫–∞.
      </div>

      <div class="capture-layout">
        <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: —Ñ–æ—Ç–æ -->
        <div class="image-box">
          <div class="row">
            <label style="flex:1;">
              –§–æ—Ç–æ –±–ª—é–¥–∞
              <input type="file" id="fileInput" accept="image/*" capture="environment">
            </label>
          </div>
          <img id="imagePreview" class="image-preview" alt="–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä" style="display:none;">

          <div class="row" style="margin-top:8px;">
            <label>
              –î–∞—Ç–∞
              <input type="date" id="entryDate">
            </label>
            <label>
              –í—Ä–µ–º—è
              <input type="text" id="entryTime" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, 08:30">
            </label>
          </div>

          <button class="btn-primary" type="button" id="btnAnalyzeImage">
            ü§ñ –†–∞—Å–ø–æ–∑–Ω–∞—Ç—å —Å AI
          </button>

          <div class="error" id="aiError"></div>

          <div class="small" style="margin-top:4px;">
            –î–ª—è —Ä–∞–±–æ—Ç—ã —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è –Ω—É–∂–µ–Ω API key OpenAI (–≤–∫–ª–∞–¥–∫–∞ ¬´API / –Ω–∞—Å—Ç—Ä–æ–π–∫–∏¬ª).
          </div>
        </div>

        <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: —Ä–µ–∑—É–ª—å—Ç–∞—Ç + –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ -->
        <div class="section" style="margin-bottom:0;">
          <div class="section-title">
            <span class="icon">üìù</span>
            –†–µ–∑—É–ª—å—Ç–∞—Ç –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –¥–Ω–µ–≤–Ω–∏–∫
          </div>
          <div class="row">
            <label style="flex:1;">
              –ù–∞–∑–≤–∞–Ω–∏–µ –±–ª—é–¥–∞
              <input type="text" id="foodName" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –∫–∞–ø—É—á–∏–Ω–æ, –ø–æ–∫–µ —Å –ª–æ—Å–æ—Å–µ–º">
            </label>
          </div>

          <div class="row">
            <label>
              –ö–∫–∞–ª (–ø—Ä–∏–º–µ—Ä–Ω–æ)
              <input type="number" id="calories" min="0" step="1">
            </label>
            <label>
              –ú–∞—Å—Å–∞, –≥ (–æ—Ü–µ–Ω–∫–∞)
              <input type="number" id="weightGrams" min="0" step="10">
            </label>
          </div>

          <div class="row">
            <label style="flex:1;">
              –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π / –∫–∞—Ç–µ–≥–æ—Ä–∏—è
              <input type="text" id="note" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –∑–∞–≤—Ç—Ä–∞–∫, —Ñ–∞—Å—Ç—Ñ—É–¥, –∫–æ—Ñ–µ-–ø–∞—É–∑–∞">
            </label>
          </div>

          <button class="btn-primary" type="button" id="btnAddEntry" style="width:100%;justify-content:center;margin-top:4px;">
            ‚úÖ –î–æ–±–∞–≤–∏—Ç—å –≤ –¥–Ω–µ–≤–Ω–∏–∫
          </button>

          <div class="error" id="entryError"></div>

          <div class="stats-grid" style="margin-top:8px;">
            <div class="stat-card">
              <div class="stat-label">–°—ä–µ–¥–µ–Ω–æ —Å–µ–≥–æ–¥–Ω—è</div>
              <div class="stat-value" id="statToday">‚Äî</div>
              <div class="stat-note">–°—É–º–º–∞ –∫–∫–∞–ª –ø–æ —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–π –¥–∞—Ç–µ.</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">–°—ä–µ–¥–µ–Ω–æ –∑–∞ –º–µ—Å—è—Ü</div>
              <div class="stat-value" id="statMonthShort">‚Äî</div>
              <div class="stat-note">–í—Å–µ –∑–∞–ø–∏—Å–∏ —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—è—Ü–∞.</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–ø–∏—Å–∏ -->
    <div class="section">
      <div class="section-title">
        <span class="icon">üçΩÔ∏è</span>
        –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–ø–∏—Å–∏
      </div>
      <div class="recent-list" id="recentList"></div>
    </div>
  </div>

  <!-- –ñ—É—Ä–Ω–∞–ª -->
  <div class="tab-content" id="tab-journal">
    <div class="section">
      <div class="section-title">
        <span class="icon">üìã</span>
        –ñ—É—Ä–Ω–∞–ª —Å—ä–µ–¥–µ–Ω–Ω–æ–≥–æ
      </div>
      <div class="section-sub">
        –§–∏–ª—å—Ç—Ä—É–µ—Ç—Å—è –ø–æ –∞–∫—Ç–∏–≤–Ω–æ–º—É –º–µ—Å—è—Ü—É. –ú–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–µ –∑–∞–ø–∏—Å–∏.
      </div>

      <div class="row">
        <label>–§–∏–ª—å—Ç—Ä –ø–æ –¥–∞—Ç–µ
          <input type="date" id="filterDate">
        </label>
        <button class="btn-soft btn-xs" type="button" id="btnClearFilter">–°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä</button>
      </div>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>–î–∞—Ç–∞</th>
              <th>–í—Ä–µ–º—è</th>
              <th>–ë–ª—é–¥–æ</th>
              <th>–ö–∫–∞–ª</th>
              <th>–í–µ—Å, –≥</th>
              <th>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="journalTableBody">
            <tr><td colspan="7">–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π.</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ -->
  <div class="tab-content" id="tab-analytics">
    <div class="section">
      <div class="section-title">
        <span class="icon">üìä</span>
        –ì—Ä–∞—Ñ–∏–∫–∏ –ø–æ –º–µ—Å—è—Ü—É
      </div>
      <div class="section-sub">
        –°–ª–µ–≤–∞ ‚Äî —Å—É–º–º–∞—Ä–Ω—ã–µ –∫–∫–∞–ª –ø–æ –¥–Ω—è–º –º–µ—Å—è—Ü–∞, —Å–ø—Ä–∞–≤–∞ ‚Äî —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —É—Å–ª–æ–≤–Ω—ã–º –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º (–ø–æ –ø–æ–ª—é ¬´–∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π¬ª).
      </div>

      <div class="charts-grid">
        <div class="chart-box">
          <div class="chart-title">–ö–∫–∞–ª –ø–æ –¥–Ω—è–º –º–µ—Å—è—Ü–∞</div>
          <canvas id="chartDaily"></canvas>
        </div>
        <div class="chart-box">
          <div class="chart-title">–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</div>
          <canvas id="chartCategory"></canvas>
        </div>
      </div>
    </div>

    <div class="section">
      <div class="section-title">
        <span class="icon">üìà</span>
        –û–±–∑–æ—Ä –º–µ—Å—è—Ü–∞
      </div>
      <div class="section-sub">
        –°–≤–æ–¥–∫–∞ –ø–æ –∫–∞–ª–æ—Ä–∏—è–º: —Å–∫–æ–ª—å–∫–æ –≤ —Å—Ä–µ–¥–Ω–µ–º –≤ –¥–µ–Ω—å, –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –¥–µ–Ω—å, –∏ –ø—Ä–∏–º–µ—Ä–Ω—ã–π –ø—Ä–æ–≥–Ω–æ–∑, –µ—Å–ª–∏ —Ç–µ–º–ø —Å–æ—Ö—Ä–∞–Ω–∏—Ç—Å—è.
      </div>

      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-label">–í—Å–µ–≥–æ –∑–∞ –º–µ—Å—è—Ü</div>
          <div class="stat-value" id="statTotalMonth">‚Äî</div>
          <div class="stat-note">–°—É–º–º–∞ –≤—Å–µ—Ö –∫–∫–∞–ª –≤ –≤—ã–±—Ä–∞–Ω–Ω–æ–º –º–µ—Å—è—Ü–µ.</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">–°—Ä–µ–¥–Ω–∏–π –¥–µ–Ω—å</div>
          <div class="stat-value" id="statAvgPerDay">‚Äî</div>
          <div class="stat-note">–°—É–º–º–∞ / –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π —Å –∑–∞–ø–∏—Å—è–º–∏.</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –¥–µ–Ω—å</div>
          <div class="stat-value" id="statMaxDay">‚Äî</div>
          <div class="stat-note">–î–µ–Ω—å, –∫–æ–≥–¥–∞ –±—ã–ª–æ —Å—ä–µ–¥–µ–Ω–æ –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ.</div>
        </div>
      </div>

      <div class="ai-box">
        <div class="ai-title">
          <span class="icon">üß†</span>
          –ú–∏–Ω–∏-–∞–Ω–∞–ª–∏–∑ –ø–æ –∫–∞–ª–æ—Ä–∏—è–º
        </div>
        <div class="ai-text" id="aiSummaryText">
          –ö–∞–∫ —Ç–æ–ª—å–∫–æ –ø–æ—è–≤—è—Ç—Å—è –∑–∞–ø–∏—Å–∏ –∑–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ –¥–Ω–µ–π, –∑–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è —Ä–∞–∑–±–æ—Ä: –ø—Ä–∏–º–µ—Ä–Ω–æ –Ω–∞—Å–∫–æ–ª—å–∫–æ —Å—Ç–∞–±–∏–ª—å–Ω—ã –∫–∞–ª–æ—Ä–∏–∏, –µ—Å—Ç—å –ª–∏ ¬´–∂–∏—Ä–Ω—ã–µ¬ª –¥–Ω–∏ –∏ –∫–∞–∫–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –¥–∞—é—Ç –æ—Å–Ω–æ–≤–Ω–æ–π –≤–∫–ª–∞–¥.
        </div>
      </div>
    </div>
  </div>

  <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ / API -->
  <div class="tab-content" id="tab-settings">
    <div class="section">
      <div class="section-title">
        <span class="icon">‚öôÔ∏è</span>
        API / –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
      </div>
      <div class="section-sub">
        –í–≤–µ–¥–∏ —Å–≤–æ–π OpenAI API key –∏ –º–æ–¥–µ–ª—å, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â—É—é vision (–Ω–∞–ø—Ä–∏–º–µ—Ä, <code>gpt-4.1-mini</code> –∏–ª–∏ –¥—Ä—É–≥—É—é –º—É–ª—å—Ç–∏–º–æ–¥–∞–ª—å–Ω—É—é –º–æ–¥–µ–ª—å).
        <br>–ö–ª—é—á —Ö—Ä–∞–Ω–∏—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ (localStorage), –Ω–æ –¥–ª—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞ –ª—É—á—à–µ –¥–µ–ª–∞—Ç—å —á–µ—Ä–µ–∑ backend.
      </div>

      <div class="row">
        <label style="flex:1;">
          OpenAI API key
          <input type="password" id="apiKeyInput" placeholder="sk-...">
        </label>
      </div>
      <div class="row">
        <label style="flex:1;">
          –ú–æ–¥–µ–ª—å
          <input type="text" id="modelInput" value="gpt-4.1-mini">
        </label>
      </div>

      <div class="row">
        <button class="btn-primary" type="button" id="btnSaveApi">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å API –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
        <button class="btn-soft btn-xs" type="button" id="btnClearApi">–û—á–∏—Å—Ç–∏—Ç—å</button>
      </div>

      <div class="small">
        –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Ñ–æ—Ç–æ –≤ –≤–∏–¥–µ base64-—Å—Ç—Ä–æ–∫–∏ –≤ Chat Completions API:<br>
        —Ç–µ–∫—Å—Ç–æ–≤—ã–π –ø—Ä–æ–º–ø—Ç + <code>image_url: data:image/jpeg;base64,...</code> ‚Äî –∏ –ø—Ä–æ—Å–∏—Ç—å –º–æ–¥–µ–ª—å –≤–µ—Ä–Ω—É—Ç—å JSON —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º –±–ª—é–¥–∞ –∏ –∫–∫–∞–ª.  [oai_citation:0‚Ä°OpenAI Platform](https://platform.openai.com/docs/guides/images-vision?utm_source=chatgpt.com)
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const STORAGE_KEY = 'food_ai_diary_v1';
  const API_KEY_STORAGE = 'food_ai_api_key';
  const MODEL_STORAGE = 'food_ai_model';

  let state = {
    entries: [
      // {id, date:'YYYY-MM-DD', time:'HH:MM', name, calories, weightGrams, note}
    ]
  };

  let chartDaily = null;
  let chartCategory = null;

  // –≠–õ–ï–ú–ï–ù–¢–´
  const tabButtons = document.querySelectorAll('.tab-btn');
  const tabContents = document.querySelectorAll('.tab-content');

  const monthSelector = document.getElementById('monthSelector');
  const btnSetCurrentMonth = document.getElementById('btnSetCurrentMonth');

  // –§–æ—Ç–æ + –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ
  const fileInput = document.getElementById('fileInput');
  const imagePreview = document.getElementById('imagePreview');
  const entryDate = document.getElementById('entryDate');
  const entryTime = document.getElementById('entryTime');
  const foodName = document.getElementById('foodName');
  const calories = document.getElementById('calories');
  const weightGrams = document.getElementById('weightGrams');
  const note = document.getElementById('note');
  const btnAnalyzeImage = document.getElementById('btnAnalyzeImage');
  const btnAddEntry = document.getElementById('btnAddEntry');
  const aiError = document.getElementById('aiError');
  const entryError = document.getElementById('entryError');
  const recentList = document.getElementById('recentList');
  const statToday = document.getElementById('statToday');
  const statMonthShort = document.getElementById('statMonthShort');

  // –ñ—É—Ä–Ω–∞–ª
  const filterDate = document.getElementById('filterDate');
  const btnClearFilter = document.getElementById('btnClearFilter');
  const journalTableBody = document.getElementById('journalTableBody');

  // –ê–Ω–∞–ª–∏—Ç–∏–∫–∞
  const chartDailyEl = document.getElementById('chartDaily');
  const chartCategoryEl = document.getElementById('chartCategory');
  const statTotalMonth = document.getElementById('statTotalMonth');
  const statAvgPerDay = document.getElementById('statAvgPerDay');
  const statMaxDay = document.getElementById('statMaxDay');
  const aiSummaryText = document.getElementById('aiSummaryText');

  // –ù–∞—Å—Ç—Ä–æ–π–∫–∏
  const apiKeyInput = document.getElementById('apiKeyInput');
  const modelInput = document.getElementById('modelInput');
  const btnSaveApi = document.getElementById('btnSaveApi');
  const btnClearApi = document.getElementById('btnClearApi');

  // –¢–ê–ë–´
  tabButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      tabButtons.forEach(b => b.classList.remove('active'));
      tabContents.forEach(c => c.classList.remove('active'));
      btn.classList.add('active');
      const id = btn.getAttribute('data-tab');
      document.getElementById(id).classList.add('active');
      if (id === 'tab-analytics') {
        renderCharts();
        renderAnalytics();
      }
    });
  });

  // –ú–ï–°–Ø–¶
  function setCurrentMonthValue() {
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, '0');
    monthSelector.value = `${y}-${m}`;
  }
  btnSetCurrentMonth.addEventListener('click', () => {
    setCurrentMonthValue();
    onMonthChange();
  });
  monthSelector.addEventListener('change', onMonthChange);

  function getActiveMonthKey() {
    if (!monthSelector.value) {
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, '0');
      return `${y}-${m}`;
    }
    return monthSelector.value;
  }

  function daysInMonth(monthKey) {
    const [yearStr, monthStr] = monthKey.split('-');
    const year = parseInt(yearStr, 10);
    const month = parseInt(monthStr, 10);
    return new Date(year, month, 0).getDate();
  }

  // LOCAL STORAGE
  function loadState() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (raw) {
        const data = JSON.parse(raw);
        if (Array.isArray(data.entries)) state.entries = data.entries;
      }
      const apiKey = localStorage.getItem(API_KEY_STORAGE) || '';
      if (apiKey) apiKeyInput.value = apiKey;
      const model = localStorage.getItem(MODEL_STORAGE) || '';
      if (model) modelInput.value = model;
    } catch(e) {
      console.error('loadState error', e);
    }
  }

  function saveState() {
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    } catch(e) {
      console.error('saveState error', e);
    }
  }

  // –î–ê–¢–ê / –í–†–ï–ú–Ø
  function setTodayDateTime() {
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, '0');
    const day = String(d.getDate()).padStart(2, '0');
    entryDate.value = `${y}-${m}-${day}`;
    const hh = String(d.getHours()).padStart(2, '0');
    const mm = String(d.getMinutes()).padStart(2, '0');
    entryTime.value = `${hh}:${mm}`;
  }

  // –ü–†–ï–î–ü–†–û–°–ú–û–¢–† –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–Ø
  fileInput.addEventListener('change', () => {
    const file = fileInput.files && fileInput.files[0];
    if (!file) {
      imagePreview.style.display = 'none';
      imagePreview.src = '';
      return;
    }
    const reader = new FileReader();
    reader.onload = (e) => {
      imagePreview.src = e.target.result;
      imagePreview.style.display = 'block';
    };
    reader.readAsDataURL(file);
  });

  // –§–û–†–ú–ê–¢ –î–ï–ù–ï–ì/–ö–ö–ê–õ
  function formatNumber(v) {
    if (v == null || isNaN(v)) return '‚Äî';
    return v.toLocaleString('ru-RU', { maximumFractionDigits: 0 });
  }

  // API –ù–ê–°–¢–†–û–ô–ö–ò
  btnSaveApi.addEventListener('click', () => {
    const key = apiKeyInput.value.trim();
    const model = modelInput.value.trim();
    localStorage.setItem(API_KEY_STORAGE, key);
    localStorage.setItem(MODEL_STORAGE, model || 'gpt-4.1-mini');
    alert('API –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã.');
  });

  btnClearApi.addEventListener('click', () => {
    apiKeyInput.value = '';
    modelInput.value = 'gpt-4.1-mini';
    localStorage.removeItem(API_KEY_STORAGE);
    localStorage.removeItem(MODEL_STORAGE);
  });

  function getApiKey() {
    return apiKeyInput.value.trim();
  }
  function getModelName() {
    return (modelInput.value || 'gpt-4.1-mini').trim();
  }

  // AI –†–ê–°–ü–û–ó–ù–ê–í–ê–ù–ò–ï –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–Ø
  btnAnalyzeImage.addEventListener('click', async () => {
    aiError.textContent = '';
    const apiKey = getApiKey();
    const model = getModelName();

    if (!apiKey) {
      aiError.textContent = '–°–Ω–∞—á–∞–ª–∞ –≤–≤–µ–¥–∏ API key –≤–æ –≤–∫–ª–∞–¥–∫–µ ¬´API / –Ω–∞—Å—Ç—Ä–æ–π–∫–∏¬ª.';
      return;
    }
    const file = fileInput.files && fileInput.files[0];
    if (!file) {
      aiError.textContent = '–í—ã–±–µ—Ä–∏ –∏–ª–∏ —Å–¥–µ–ª–∞–π —Ñ–æ—Ç–æ –±–ª—é–¥–∞.';
      return;
    }

    // —á–∏—Ç–∞–µ–º —Ñ–∞–π–ª –≤ base64
    try {
      btnAnalyzeImage.disabled = true;
      btnAnalyzeImage.textContent = '–†–∞—Å–ø–æ–∑–Ω–∞—é...';
      const base64 = await fileToBase64(file);

      const payload = {
        model,
        messages: [
          {
            role: "user",
            content: [
              {
                type: "text",
                text:
`–¢—ã ‚Äì –Ω—É—Ç—Ä–∏—Ü–∏–æ–Ω–∏—Å—Ç. –ü–æ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –±–ª—é–¥–∞ –æ—Ü–µ–Ω–∏:
- —á—Ç–æ –∑–∞ –±–ª—é–¥–æ (–∫—Ä–∞—Ç–∫–æ, –Ω–∞ —Ä—É—Å—Å–∫–æ–º),
- –ø—Ä–∏–º–µ—Ä–Ω—É—é –∫–∞–ª–æ—Ä–∏–π–Ω–æ—Å—Ç—å, –∫–∫–∞–ª,
- –ø—Ä–∏–º–µ—Ä–Ω—É—é –º–∞—Å—Å—É –±–ª—é–¥–∞, –≥—Ä–∞–º–º—ã,
- –∫—Ä–∞—Ç–∫—É—é —Ç–µ–∫—Å—Ç–æ–≤—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é (–Ω–∞–ø—Ä–∏–º–µ—Ä: –∫–æ—Ñ–µ, –¥–µ—Å–µ—Ä—Ç, –æ—Å–Ω–æ–≤–Ω–æ–µ, —Ñ–∞—Å—Ç—Ñ—É–¥, —Å–∞–ª–∞—Ç, –Ω–∞–ø–∏—Ç–æ–∫).

–û—Ç–≤–µ—Ç—å —Å—Ç—Ä–æ–≥–æ –≤ JSON —Ñ–æ—Ä–º–∞—Ç–µ –±–µ–∑ –ª–∏—à–Ω–µ–≥–æ —Ç–µ–∫—Å—Ç–∞:
{"name":"...","calories":123,"weight_grams":250,"category":"...","confidence":0.85}`
              },
              {
                type: "image_url",
                image_url: {
                  url: base64.startsWith('data:') ? base64 : `data:image/jpeg;base64,${base64}`
                }
              }
            ]
          }
        ],
        max_tokens: 300
      };

      const response = await fetch("https://api.openai.com/v1/chat/completions", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${apiKey}`
        },
        body: JSON.stringify(payload)
      });

      if (!response.ok) {
        const text = await response.text();
        console.error('OpenAI error:', text);
        aiError.textContent = '–û—à–∏–±–∫–∞ API: ' + response.status;
        return;
      }

      const data = await response.json();
      const content = data.choices?.[0]?.message?.content?.trim();
      if (!content) {
        aiError.textContent = '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç –æ—Ç –º–æ–¥–µ–ª–∏.';
        return;
      }

      let parsed;
      try {
        parsed = JSON.parse(content);
      } catch(e) {
        console.warn('Cannot parse JSON, raw content:', content);
        aiError.textContent = '–ú–æ–¥–µ–ª—å –≤–µ—Ä–Ω—É–ª–∞ –æ—Ç–≤–µ—Ç –≤ –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ. –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑.';
        return;
      }

      if (parsed.name) foodName.value = parsed.name;
      if (parsed.calories != null) calories.value = Math.round(parsed.calories);
      if (parsed.weight_grams != null) weightGrams.value = Math.round(parsed.weight_grams);
      if (parsed.category && !note.value) note.value = parsed.category;

    } catch(e) {
      console.error(e);
      aiError.textContent = '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è.';
    } finally {
      btnAnalyzeImage.disabled = false;
      btnAnalyzeImage.textContent = 'ü§ñ –†–∞—Å–ø–æ–∑–Ω–∞—Ç—å —Å AI';
    }
  });

  function fileToBase64(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result);
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }

  // –î–û–ë–ê–í–õ–ï–ù–ò–ï –ó–ê–ü–ò–°–ò
  btnAddEntry.addEventListener('click', () => {
    entryError.textContent = '';

    const date = entryDate.value;
    let time = (entryTime.value || '').trim();
    const name = foodName.value.trim();
    const kcal = parseFloat(calories.value);
    const weight = parseFloat(weightGrams.value);
    const n = note.value.trim();

    if (!date) {
      entryError.textContent = '–£–∫–∞–∂–∏ –¥–∞—Ç—É.';
      return;
    }
    if (!name) {
      entryError.textContent = '–ù–∞–∑–≤–∞–Ω–∏–µ –±–ª—é–¥–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º.';
      return;
    }
    if (isNaN(kcal) || kcal <= 0) {
      entryError.textContent = '–£–∫–∞–∂–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∫–∫–∞–ª.';
      return;
    }
    if (!time) {
      const d = new Date();
      const hh = String(d.getHours()).padStart(2,'0');
      const mm = String(d.getMinutes()).padStart(2,'0');
      time = `${hh}:${mm}`;
    }

    state.entries.push({
      id: Date.now() + '_' + Math.random().toString(16).slice(2),
      date,
      time,
      name,
      calories: kcal,
      weightGrams: isNaN(weight) ? null : weight,
      note: n
    });
    saveState();

    // –æ—á–∏—Å—Ç–∏—Ç—å –∏–º—è / –∫–∫–∞–ª? –æ—Å—Ç–∞–≤–∏–º, —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –ø–æ–≤—Ç–æ—Ä—è—Ç—å –æ–¥–Ω–æ –∏ —Ç–æ –∂–µ
    // –Ω–æ –æ—á–∏—Å—Ç–∏–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
    note.value = '';

    renderRecent();
    renderTodayAndMonthStats();
    renderJournalTable();
    renderCharts();
    renderAnalytics();
  });

  // –ü–û–°–õ–ï–î–ù–ò–ï –ó–ê–ü–ò–°–ò
  function renderRecent() {
    const monthKey = getActiveMonthKey();
    const entries = state.entries
      .filter(e => e.date && e.date.startsWith(monthKey))
      .sort((a,b) => (b.date + (b.time||'')) .localeCompare(a.date + (a.time||'')));

    if (!entries.length) {
      recentList.innerHTML = '<div class="small">–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π –∑–∞ —ç—Ç–æ—Ç –º–µ—Å—è—Ü.</div>';
      return;
    }

    recentList.innerHTML = '';
    entries.slice(0,20).forEach(e => {
      const div = document.createElement('div');
      div.className = 'recent-item';
      div.innerHTML = `
        <div class="recent-main">
          <div class="recent-name">${escapeHtml(e.name)}</div>
          <div class="recent-meta">
            ${escapeHtml(e.date)} ¬∑ ${escapeHtml(e.time || '')} ¬∑ ${formatNumber(e.calories)} –∫–∫–∞–ª
          </div>
        </div>
        <button class="btn-danger btn-xs" data-id="${e.id}">‚úï</button>
      `;
      recentList.appendChild(div);
    });

    recentList.querySelectorAll('button[data-id]').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = btn.getAttribute('data-id');
        if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–ø–∏—Å—å?')) return;
        state.entries = state.entries.filter(e => String(e.id) !== String(id));
        saveState();
        renderRecent();
        renderTodayAndMonthStats();
        renderJournalTable();
        renderCharts();
        renderAnalytics();
      });
    });
  }

  function renderTodayAndMonthStats() {
    const today = entryDate.value;
    const monthKey = getActiveMonthKey();

    const todayEntries = state.entries.filter(e => e.date === today);
    const monthEntries = state.entries.filter(e => e.date && e.date.startsWith(monthKey));

    const todayKcal = todayEntries.reduce((s,e)=>s+(e.calories||0),0);
    const monthKcal = monthEntries.reduce((s,e)=>s+(e.calories||0),0);

    statToday.textContent = todayEntries.length ? (formatNumber(todayKcal) + ' –∫–∫–∞–ª') : '‚Äî';
    statMonthShort.textContent = monthEntries.length ? (formatNumber(monthKcal) + ' –∫–∫–∞–ª') : '‚Äî';
  }

  // –ñ–£–†–ù–ê–õ
  filterDate.addEventListener('change', renderJournalTable);
  btnClearFilter.addEventListener('click', () => {
    filterDate.value = '';
    renderJournalTable();
  });

  function renderJournalTable() {
    const monthKey = getActiveMonthKey();
    const dateFilter = filterDate.value || '';

    let entries = state.entries.filter(e => e.date && e.date.startsWith(monthKey));
    if (dateFilter) {
      entries = entries.filter(e => e.date === dateFilter);
    }

    if (!entries.length) {
      journalTableBody.innerHTML = '<tr><td colspan="7">–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π.</td></tr>';
      return;
    }

    journalTableBody.innerHTML = '';
    entries.sort((a,b) => (a.date + (a.time||'')) .localeCompare(b.date + (b.time||'')));

    entries.forEach(e => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${escapeHtml(e.date)}</td>
        <td>${escapeHtml(e.time || '')}</td>
        <td>${escapeHtml(e.name)}</td>
        <td>${formatNumber(e.calories)}</td>
        <td>${e.weightGrams != null ? formatNumber(e.weightGrams) : ''}</td>
        <td>${escapeHtml(e.note || '')}</td>
        <td><button class="btn-danger btn-xs" data-id="${e.id}">‚úï</button></td>
      `;
      journalTableBody.appendChild(tr);
    });

    journalTableBody.querySelectorAll('button[data-id]').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = btn.getAttribute('data-id');
        if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–ø–∏—Å—å?')) return;
        state.entries = state.entries.filter(e => String(e.id) !== String(id));
        saveState();
        renderRecent();
        renderTodayAndMonthStats();
        renderJournalTable();
        renderCharts();
        renderAnalytics();
      });
    });
  }

  // –ß–ê–†–¢–´
  function renderCharts() {
    const monthKey = getActiveMonthKey();
    const entries = state.entries.filter(e => e.date && e.date.startsWith(monthKey));

    if (chartDaily) chartDaily.destroy();
    if (chartCategory) chartCategory.destroy();

    const daysCount = daysInMonth(monthKey);
    if (!daysCount) return;

    const dailyMap = new Array(daysCount).fill(0);
    entries.forEach(e => {
      const d = parseInt(e.date.slice(8,10),10);
      if (!isNaN(d) && d>=1 && d<=daysCount) {
        dailyMap[d-1] += e.calories || 0;
      }
    });
    const labels = Array.from({length:daysCount}, (_,i)=>String(i+1));

    chartDaily = new Chart(chartDailyEl, {
      type: 'bar',
      data: {
        labels,
        datasets: [{
          label: '–ö–∫–∞–ª',
          data: dailyMap,
          borderColor: '#38bdf8',
          backgroundColor: 'rgba(56,189,248,0.6)'
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { labels: { font: { size: 10 } } }
        },
        scales: {
          x: { ticks: { font: { size: 9 } } },
          y: { ticks: { font: { size: 9 } } }
        }
      }
    });

    const categoryMap = {};
    entries.forEach(e => {
      const cat = (e.note || '–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏').split(',')[0].trim() || '–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏';
      if (!categoryMap[cat]) categoryMap[cat] = 0;
      categoryMap[cat] += e.calories || 0;
    });
    const catLabels = Object.keys(categoryMap);
    const catValues = catLabels.map(k => categoryMap[k]);
    const colors = [
      'rgba(56,189,248,0.8)',
      'rgba(251,146,60,0.85)',
      'rgba(52,211,153,0.85)',
      'rgba(248,113,113,0.85)',
      'rgba(129,140,248,0.85)',
      'rgba(253,224,71,0.85)',
      'rgba(248,250,252,0.85)'
    ];

    chartCategory = new Chart(chartCategoryEl, {
      type: 'doughnut',
      data: {
        labels: catLabels,
        datasets: [{
          data: catValues,
          backgroundColor: catLabels.map((_,i)=>colors[i % colors.length]),
          borderColor: '#020617',
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { labels: { font: { size: 10 } } }
        }
      }
    });
  }

  // –ê–ù–ê–õ–ò–¢–ò–ö–ê
  function renderAnalytics() {
    const monthKey = getActiveMonthKey();
    const entries = state.entries.filter(e => e.date && e.date.startsWith(monthKey));
    if (!entries.length) {
      statTotalMonth.textContent = '‚Äî';
      statAvgPerDay.textContent = '‚Äî';
      statMaxDay.textContent = '‚Äî';
      aiSummaryText.textContent = '–ü–æ–∫–∞ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ —ç—Ç–æ—Ç –º–µ—Å—è—Ü. –ö–∞–∫ —Ç–æ–ª—å–∫–æ –≤–Ω–µ—Å—ë—à—å –ø–∞—Ä—É –¥–Ω–µ–π –ø–∏—Ç–∞–Ω–∏—è, –ø–æ—è–≤–∏—Ç—Å—è —Å–≤–æ–¥–∫–∞ –ø–æ –∫–∞–ª–æ—Ä–∏—è–º.';
      return;
    }

    const total = entries.reduce((s,e)=>s+(e.calories||0),0);

    const dailyMap = {};
    entries.forEach(e => {
      if (!dailyMap[e.date]) dailyMap[e.date] = 0;
      dailyMap[e.date] += e.calories || 0;
    });
    const days = Object.keys(dailyMap);
    const avgPerDay = total / days.length;
    let maxDay = null;
    let maxVal = -Infinity;
    days.forEach(d => {
      if (dailyMap[d] > maxVal) {
        maxVal = dailyMap[d];
        maxDay = d;
      }
    });

    statTotalMonth.textContent = formatNumber(total) + ' –∫–∫–∞–ª';
    statAvgPerDay.textContent = formatNumber(avgPerDay) + ' –∫–∫–∞–ª';
    statMaxDay.textContent = maxDay ? (maxDay + ' ¬∑ ' + formatNumber(maxVal) + ' –∫–∫–∞–ª') : '‚Äî';

    let text = '';
    text += `–ó–∞ –º–µ—Å—è—Ü ${monthKey} —Å—É–º–º–∞—Ä–Ω–æ —Å—ä–µ–¥–µ–Ω–æ –æ–∫–æ–ª–æ ${formatNumber(total)} –∫–∫–∞–ª.\n\n`;
    text += `–î–Ω–µ–π —Å –∑–∞–ø–∏—Å—è–º–∏: ${days.length}. –°—Ä–µ–¥–Ω—è—è –∫–∞–ª–æ—Ä–∏–π–Ω–æ—Å—Ç—å –¥–Ω—è: –æ–∫–æ–ª–æ ${formatNumber(avgPerDay)} –∫–∫–∞–ª.\n`;

    if (maxDay) {
      text += `\n–°–∞–º—ã–π ¬´—Ç—è–∂—ë–ª—ã–π¬ª –¥–µ–Ω—å: ${maxDay} ‚Äî –æ–∫–æ–ª–æ ${formatNumber(maxVal)} –∫–∫–∞–ª.`;
    }

    const categoryMap = {};
    entries.forEach(e => {
      const cat = (e.note || '–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏').split(',')[0].trim() || '–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏';
      if (!categoryMap[cat]) categoryMap[cat] = 0;
      categoryMap[cat] += e.calories || 0;
    });
    const sortedCats = Object.entries(categoryMap).sort((a,b)=>b[1]-a[1]);
    if (sortedCats.length) {
      const top = sortedCats.slice(0,3).map(([c,v])=>`${c} (${formatNumber(v)} –∫–∫–∞–ª)`).join(', ');
      text += `\n\n–ü–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º –±–æ–ª—å—à—É—é —á–∞—Å—Ç—å –∫–∞–ª–æ—Ä–∏–π –¥–∞—é—Ç: ${top}.`;
    }

    aiSummaryText.textContent = text;
  }

  // –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–û–ï
  function escapeHtml(str) {
    return String(str)
      .replace(/&/g,'&amp;')
      .replace(/</g,'&lt;')
      .replace(/>/g,'&gt;')
      .replace(/"/g,'&quot;')
      .replace(/'/g,'&#39;');
  }

  function onMonthChange() {
    const monthKey = getActiveMonthKey();
    // –µ—Å–ª–∏ –¥–∞—Ç–∞ –∑–∞–ø–∏—Å–∏ –Ω–µ –∏–∑ —ç—Ç–æ–≥–æ –º–µ—Å—è—Ü–∞ ‚Äî –æ–±–Ω–æ–≤–∏–º
    if (!entryDate.value || !entryDate.value.startsWith(monthKey)) {
      const [y,m] = monthKey.split('-');
      const d = new Date();
      const day = String(Math.min(d.getDate(), daysInMonth(monthKey))).padStart(2,'0');
      entryDate.value = `${y}-${m}-${day}`;
    }
    renderRecent();
    renderTodayAndMonthStats();
    renderJournalTable();
    renderCharts();
    renderAnalytics();
  }

  function renderAll() {
    onMonthChange();
  }

  // –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
  loadState();
  setCurrentMonthValue();
  setTodayDateTime();
  renderAll();
</script>
</body>
</html>