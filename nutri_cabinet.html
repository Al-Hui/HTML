<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–õ–∏—á–Ω—ã–π –Ω—É—Ç—Ä–∏-–∫–∞–±–∏–Ω–µ—Ç</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg: #020617;
      --bg-elevated: #020617;
      --card: #020617;
      --card-soft: #020617;
      --text: #f9fafb;
      --muted: #9ca3af;
      --accent: #38bdf8;
      --accent-soft: rgba(56,189,248,0.16);
      --border: #1f2937;
      --danger: #f97373;
      --radius-lg: 18px;
      --radius-md: 12px;
      --shadow-soft: 0 18px 40px rgba(15, 23, 42, 0.65);
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      min-height: 100vh;
      display: flex;
      justify-content: center;
      padding: 16px;
      background: radial-gradient(circle at top, #0b1120 0, #020617 45%, #020617 100%);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
      color: var(--text);
    }
    .app {
      width: 100%;
      max-width: 1140px;
      background: radial-gradient(circle at top left, rgba(56,189,248,0.06), transparent 55%),
                  radial-gradient(circle at top right, rgba(37,99,235,0.12), transparent 60%),
                  var(--bg-elevated);
      border-radius: 24px;
      border: 1px solid rgba(148,163,184,0.4);
      box-shadow: var(--shadow-soft);
      padding: 18px 18px 20px;
      display: flex;
      flex-direction: column;
      gap: 14px;
    }
    .header {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
    }
    .title {
      font-size: 20px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .title span.icon {
      font-size: 20px;
    }
    .subtitle {
      font-size: 13px;
      color: var(--muted);
      margin-top: 4px;
      line-height: 1.4;
    }
    .chip-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 6px;
    }
    .chip {
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.5);
      background: rgba(15,23,42,0.8);
      padding: 3px 9px;
      font-size: 11px;
      color: var(--muted);
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .pill-value {
      color: var(--accent);
      font-weight: 600;
      font-size: 12px;
    }
    .btn {
      border-radius: 999px;
      border: none;
      padding: 7px 12px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 5px;
      white-space: nowrap;
    }
    .btn-primary {
      background: linear-gradient(90deg,#38bdf8,#6366f1);
      color: #f9fafb;
      box-shadow: 0 14px 30px rgba(37,99,235,0.7);
    }
    .btn-secondary {
      background: rgba(15,23,42,0.9);
      color: var(--muted);
      border: 1px solid rgba(148,163,184,0.6);
    }
    .btn-soft {
      background: rgba(15,23,42,0.65);
      color: var(--muted);
      border: 1px solid rgba(55,65,81,0.9);
    }
    .btn:active {
      transform: translateY(1px);
      box-shadow: none;
    }
    .toggle-dark {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: var(--muted);
      cursor: pointer;
    }
    .toggle-pill {
      width: 34px;
      height: 18px;
      border-radius: 999px;
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(148,163,184,0.6);
      position: relative;
    }
    .toggle-pill div {
      position: absolute;
      top: 1px;
      left: 1px;
      width: 14px;
      height: 14px;
      border-radius: 999px;
      background: #fbbf24;
      transition: transform 0.18s ease;
    }
    .toggle-pill.on {
      background: #38bdf8;
      border-color: #38bdf8;
    }
    .toggle-pill.on div {
      transform: translateX(14px);
      background: #0f172a;
    }
    .tabs {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 4px;
      border-bottom: 1px solid rgba(31,41,55,0.9);
      padding-bottom: 4px;
    }
    .tab-btn {
      border: none;
      background: transparent;
      color: var(--muted);
      padding: 6px 10px;
      font-size: 12px;
      border-radius: 999px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .tab-btn.active {
      background: var(--accent-soft);
      color: var(--accent);
      border: 1px solid rgba(56,189,248,0.5);
    }
    .tab-icon {
      font-size: 13px;
    }
    .tab-content {
      margin-top: 8px;
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    .section {
      border-radius: var(--radius-lg);
      border: 1px solid rgba(31,41,55,0.95);
      padding: 10px 12px 12px;
      background: radial-gradient(circle at top, rgba(15,23,42,0.9), #020617);
      margin-bottom: 10px;
    }
    .section-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .section-title span.icon {
      font-size: 14px;
    }
    .section-sub {
      font-size: 11px;
      color: var(--muted);
      margin-bottom: 6px;
      line-height: 1.35;
    }
    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      margin-bottom: 6px;
    }
    label {
      font-size: 11px;
      color: var(--muted);
      display: flex;
      flex-direction: column;
      gap: 3px;
    }
    input[type="number"],
    input[type="text"],
    input[type="date"],
    select,
    textarea {
      padding: 5px 7px;
      border-radius: 8px;
      border: 1px solid rgba(31,41,55,0.9);
      font-size: 12px;
      background: rgba(15,23,42,0.95);
      color: var(--text);
      min-width: 70px;
    }
    input[type="number"] { width: 80px; }
    input[type="date"] { width: 130px; }
    textarea { min-height: 60px; resize: vertical; }
    .pill {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 9px;
      border-radius: 999px;
      border: 1px solid rgba(30,64,175,0.7);
      background: rgba(15,23,42,0.9);
      font-size: 11px;
      color: var(--muted);
    }
    .pill b {
      color: var(--accent);
      font-size: 12px;
    }
    .error {
      font-size: 11px;
      color: var(--danger);
      min-height: 14px;
    }
    .table-wrap {
      margin-top: 6px;
      border-radius: var(--radius-lg);
      border: 1px solid rgba(31,41,55,0.9);
      overflow: auto;
      max-height: 280px;
      background: rgba(15,23,42,0.96);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11.5px;
    }
    thead {
      background: rgba(15,23,42,0.95);
      position: sticky;
      top: 0;
      z-index: 1;
    }
    th, td {
      padding: 5px 6px;
      border-bottom: 1px solid rgba(31,41,55,0.9);
      text-align: left;
      white-space: nowrap;
    }
    th {
      font-weight: 600;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--muted);
    }
    tbody tr:nth-child(even) td {
      background: rgba(15,23,42,0.9);
    }
    tbody tr:nth-child(odd) td {
      background: rgba(15,23,42,0.85);
    }
    .badge {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.7);
      color: var(--muted);
    }
    .badge-positive { border-color: #22c55e; color: #4ade80; }
    .badge-negative { border-color: #f97373; color: #fecaca; }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 8px;
      margin-top: 4px;
    }
    .stat-card {
      border-radius: var(--radius-md);
      border: 1px solid rgba(31,41,55,0.9);
      padding: 6px 8px;
      background: rgba(15,23,42,0.95);
    }
    .stat-label {
      font-size: 11px;
      color: var(--muted);
      margin-bottom: 2px;
    }
    .stat-value {
      font-size: 14px;
      font-weight: 600;
    }
    .stat-note {
      font-size: 10px;
      color: var(--muted);
      margin-top: 2px;
    }
    .charts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 10px;
      margin-top: 6px;
    }
    .chart-box {
      border-radius: var(--radius-lg);
      border: 1px solid rgba(31,41,55,0.9);
      padding: 8px 10px 10px;
      background: rgba(15,23,42,0.95);
    }
    .chart-title {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 4px;
    }
    canvas {
      width: 100%;
      height: 210px;
    }
    .small {
      font-size: 11px;
      color: var(--muted);
    }
    .ai-box {
      margin-top: 6px;
      border-radius: var(--radius-md);
      border: 1px solid rgba(56,189,248,0.6);
      padding: 6px 8px;
      background: rgba(8,47,73,0.8);
      font-size: 12px;
    }
    .ai-title {
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 3px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .ai-title span.icon {
      font-size: 13px;
    }
    .ai-text {
      font-size: 11.5px;
      color: #e5e7eb;
      line-height: 1.5;
    }
    @media (max-width: 640px) {
      .app { padding: 14px 10px 14px; border-radius: 18px; }
      .header { flex-direction: column; }
    }
  </style>
</head>
<body>
<div class="app">
  <div class="header">
    <div>
      <div class="title">
        <span class="icon">ü•ó</span>
        –õ–∏—á–Ω—ã–π –Ω—É—Ç—Ä–∏-–∫–∞–±–∏–Ω–µ—Ç
      </div>
      <div class="subtitle">
        –õ–æ–∫–∞–ª—å–Ω—ã–π —Ç—Ä–µ–∫–µ—Ä –µ–¥—ã, –≤–µ—Å–∞ –∏ –∫–∞–ª–æ—Ä–∏–π: —Ä–∞—Å—á—ë—Ç TDEE, —Ü–µ–ª—å ‚àí0.5 –∫–≥/–Ω–µ–¥–µ–ª—é, —É—á—ë—Ç –≤–æ–¥—ã, –ø—Ä–æ—Å—Ç–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏ –≥—Ä–∞—Ñ–∏–∫–∏.
      </div>
      <div class="chip-row">
        <div class="chip">–§–æ—Ä–º—É–ª–∞: <span class="pill-value">Mifflin‚ÄìSt Jeor (–º—É–∂—á–∏–Ω–∞)</span></div>
        <div class="chip">–¶–µ–ª—å: <span class="pill-value">‚àí0.5 –∫–≥ / –Ω–µ–¥–µ–ª—é</span></div>
        <div class="chip">–•—Ä–∞–Ω–µ–Ω–∏–µ: <span class="pill-value">—Ç–æ–ª—å–∫–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ</span></div>
      </div>
    </div>
    <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px;">
      <button class="btn btn-soft" id="btnExportHtml" type="button">üìÑ –≠–∫—Å–ø–æ—Ä—Ç –æ—Ç—á—ë—Ç–∞ (HTML)</button>
      <label class="toggle-dark">
        <span>–¢—ë–º–Ω–∞—è —Ç–µ–º–∞</span>
        <div class="toggle-pill on" id="darkToggle"><div></div></div>
      </label>
    </div>
  </div>

  <div class="tabs">
    <button class="tab-btn active" data-tab="tab-profile"><span class="tab-icon">üë§</span>–ü—Ä–æ—Ñ–∏–ª—å</button>
    <button class="tab-btn" data-tab="tab-day"><span class="tab-icon">üìÖ</span>–î–µ–Ω—å</button>
    <button class="tab-btn" data-tab="tab-analytics"><span class="tab-icon">üìä</span>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</button>
    <button class="tab-btn" data-tab="tab-import"><span class="tab-icon">üì•</span>–®–∞–≥–∏ & –ó–¥–æ—Ä–æ–≤—å–µ</button>
    <button class="tab-btn" data-tab="tab-settings"><span class="tab-icon">‚öôÔ∏è</span>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ / –≠–∫—Å–ø–æ—Ä—Ç</button>
  </div>

  <!-- –ü—Ä–æ—Ñ–∏–ª—å -->
  <div class="tab-content active" id="tab-profile">
    <div class="section">
      <div class="section-title"><span class="icon">üë§</span>–ü—Ä–æ—Ñ–∏–ª—å –∏ —Ü–µ–ª—å</div>
      <div class="section-sub">
        –§–æ—Ä–º—É–ª–∞ Mifflin‚ÄìSt Jeor –¥–ª—è –º—É–∂—á–∏–Ω—ã. –¶–µ–ª—å: ‚àí0.5 –∫–≥/–Ω–µ–¥–µ–ª—é (‚âà ‚àí500 –∫–∫–∞–ª/–¥–µ–Ω—å –æ—Ç TDEE). –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.
      </div>
      <div class="row">
        <label>–í–æ–∑—Ä–∞—Å—Ç, –ª–µ—Ç
          <input type="number" id="ageInput" min="10" max="100" value="35">
        </label>
        <label>–†–æ—Å—Ç, —Å–º
          <input type="number" id="heightInput" min="130" max="230" value="180">
        </label>
        <label>–í–µ—Å, –∫–≥
          <input type="number" id="weightInput" step="0.1" min="30" max="250" value="75">
        </label>
        <label>–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
          <select id="activityInput">
            <option value="1.2">–ù–∏–∑–∫–∞—è (–º–∞–ª–æ –¥–≤–∏–∂.)</option>
            <option value="1.375">–õ—ë–≥–∫–∞—è (1‚Äì3 —Ç—Ä–µ–Ω./–Ω–µ–¥.)</option>
            <option value="1.55" selected>–°—Ä–µ–¥–Ω—è—è (3‚Äì5 —Ç—Ä–µ–Ω./–Ω–µ–¥.)</option>
            <option value="1.725">–í—ã—Å–æ–∫–∞—è (6‚Äì7 —Ç—Ä–µ–Ω./–Ω–µ–¥.)</option>
          </select>
        </label>
        <button class="btn btn-primary" id="btnSaveProfile" type="button">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</button>
      </div>
      <div class="row">
        <div class="pill">BMR: <b id="bmrValue">‚Äî</b> –∫–∫–∞–ª/–¥–µ–Ω—å</div>
        <div class="pill">TDEE (–ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏–µ): <b id="tdeeValue">‚Äî</b> –∫–∫–∞–ª/–¥–µ–Ω—å</div>
        <div class="pill">–¶–µ–ª—å (‚àí0.5 –∫–≥/–Ω–µ–¥): <b id="targetCalValue">‚Äî</b> –∫–∫–∞–ª/–¥–µ–Ω—å</div>
      </div>
      <div class="stats-grid" style="margin-top:8px;">
        <div class="stat-card">
          <div class="stat-label">–†–µ–∫–æ–º. –±–µ–ª–æ–∫</div>
          <div class="stat-value" id="statProteinTarget">‚Äî</div>
          <div class="stat-note">1.6‚Äì2.2 –≥/–∫–≥ –≤–µ—Å–∞</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">–†–µ–∫–æ–º. –∂–∏—Ä—ã</div>
          <div class="stat-value" id="statFatTarget">‚Äî</div>
          <div class="stat-note">0.8‚Äì1 –≥/–∫–≥ –≤–µ—Å–∞</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">–†–µ–∫–æ–º. —É–≥–ª–µ–≤–æ–¥—ã</div>
          <div class="stat-value" id="statCarbTarget">‚Äî</div>
          <div class="stat-note">–æ—Å—Ç–∞—Ç–æ–∫ –∫–∞–ª–æ—Ä–∏–π –ø–æ—Å–ª–µ –ë/–ñ</div>
        </div>
      </div>
      <div class="error" id="profileError"></div>
    </div>

    <div class="section">
      <div class="section-title"><span class="icon">üß†</span>–ù—É—Ç—Ä–∏-–∞–Ω–∞–ª–∏–∑ —Ü–µ–ª–∏</div>
      <div class="section-sub">–ü—Ä–æ—Å—Ç–æ–π ‚Äú—É–º–Ω—ã–π‚Äù –∞–Ω–∞–ª–∏–∑ –æ—Å–Ω–æ–≤—ã–≤–∞–µ—Ç—Å—è –Ω–∞ –∫–∞–ª–æ—Ä–∏–π–Ω–æ–º –±–∞–ª–∞–Ω—Å–µ, –ë–ñ–£ –∏ –¥–∏–Ω–∞–º–∏–∫–µ –≤–µ—Å–∞.</div>
      <div class="ai-box" id="aiProfileBox">
        <div class="ai-title"><span class="icon">‚ú®</span>–†–µ–∑—é–º–µ –ø–æ –ø—Ä–æ—Ñ–∏–ª—é</div>
        <div class="ai-text" id="aiProfileText">
          –ó–∞–ø–æ–ª–Ω–∏ –ø—Ä–æ—Ñ–∏–ª—å –∏ —Ü–µ–ª—å, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –∫–∞–ª–æ—Ä–∏–π–Ω–æ—Å—Ç–∏ –∏ –ë–ñ–£.
        </div>
      </div>
    </div>
  </div>

  <!-- –î–µ–Ω—å -->
  <div class="tab-content" id="tab-day">
    <div class="section">
      <div class="section-title"><span class="icon">üìÖ</span>–î–µ–Ω—å: –µ–¥–∞, –≤–µ—Å, –≤–æ–¥–∞</div>
      <div class="section-sub">–í—ã–±–µ—Ä–∏ –¥–∞—Ç—É, –≤–Ω–µ—Å–∏ –µ–¥—É, –≤–µ—Å –∏ –≤–æ–¥—É. –≠—Ç–∏ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç —É—á—Ç–µ–Ω—ã –≤ –≥—Ä–∞—Ñ–∏–∫–∞—Ö –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–µ.</div>
      <div class="row">
        <label>–î–∞—Ç–∞
          <input type="date" id="dayDateInput">
        </label>
        <button class="btn btn-soft" id="btnToday" type="button">–°–µ–≥–æ–¥–Ω—è</button>
        <span class="small">–°–æ–≤–µ—Ç: –∑–∞–ø–∏—Å—ã–≤–∞–π –µ–¥—É —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –ø—Ä–∏—ë–º–∞ ‚Äî —Ç–∞–∫ –ª–µ–≥—á–µ –Ω–µ –∑–∞–±—ã—Ç—å.</span>
      </div>
      <div class="row">
        <label>–í–µ—Å –≤ —ç—Ç–æ—Ç –¥–µ–Ω—å, –∫–≥
          <input type="number" id="dayWeightInput" step="0.1" min="30" max="250">
        </label>
        <button class="btn btn-secondary" id="btnSaveDayWeight" type="button">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤–µ—Å</button>
        <label>–í–æ–¥–∞, –ª
          <input type="number" id="waterInput" step="0.1" min="0" value="0">
        </label>
        <button class="btn btn-secondary" id="btnSaveWater" type="button">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤–æ–¥—É</button>
      </div>
      <div class="row">
        <span class="small">–¶–µ–ª—å –ø–æ –≤–æ–¥–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 2.5 –ª/–¥–µ–Ω—å (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –≤–æ –≤–∫–ª–∞–¥–∫–µ –ù–∞—Å—Ç—Ä–æ–π–∫–∏).</span>
      </div>
      <div class="error" id="dayError"></div>
    </div>

    <div class="section">
      <div class="section-title"><span class="icon">üçΩ</span>–ï–¥–∞ –∑–∞ –¥–µ–Ω—å</div>
      <div class="section-sub">–í—ã–±–µ—Ä–∏ –ø—Ä–æ–¥—É–∫—Ç –∏–∑ –±–∞–∑—ã –∏–ª–∏ –¥–æ–±–∞–≤—å —Å–≤–æ–π. –ë–ñ–£ –∏ –∫–∞–ª–æ—Ä–∏–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å—É–º–º–∏—Ä—É—é—Ç—Å—è –ø–æ –¥–Ω—é.</div>
      <div class="row">
        <label>–ü—Ä–æ–¥—É–∫—Ç –∏–∑ –±–∞–∑—ã
          <select id="foodSelect">
            <option value="">‚Äî –≤—ã–±—Ä–∞—Ç—å ‚Äî</option>
          </select>
        </label>
        <button class="btn btn-soft" id="btnToggleFoodDb" type="button">üìö –ü–æ–∫–∞–∑–∞—Ç—å –±–∞–∑—É –ø—Ä–æ–¥—É–∫—Ç–æ–≤</button>
      </div>
      <div class="row">
        <label>–ò–ª–∏ —Å–≤–æ—ë –Ω–∞–∑–≤–∞–Ω–∏–µ
          <input type="text" id="foodNameInput" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, –≥—Ä–µ—á–∫–∞ –æ—Ç–≤–∞—Ä–Ω–∞—è">
        </label>
        <label>–ì—Ä–∞–º–º—ã
          <input type="number" id="foodGramInput" min="1" value="100">
        </label>
        <label>–ö–∫–∞–ª / 100 –≥
          <input type="number" id="foodKcal100Input" min="0" value="0">
        </label>
        <label>–ë / –ñ / –£ (–Ω–∞ 100 –≥)
          <div style="display:flex;gap:4px;">
            <input type="number" id="foodProt100Input" min="0" value="0" style="width:60px;" placeholder="–ë">
            <input type="number" id="foodFat100Input" min="0" value="0" style="width:60px;" placeholder="–ñ">
            <input type="number" id="foodCarb100Input" min="0" value="0" style="width:60px;" placeholder="–£">
          </div>
        </label>
      </div>
      <div class="row">
        <label>–ö–∞–ª–æ—Ä–∏–π –∏—Ç–æ–≥–æ (—Ä–∞—Å—á—ë—Ç/—Ä—É—á–Ω–æ–π)
          <input type="number" id="foodKcalTotalInput" min="0" value="0">
        </label>
        <button class="btn btn-secondary" id="btnRecalcFoodKcal" type="button">‚Üª –ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å –ø–æ 100 –≥</button>
        <button class="btn btn-primary" id="btnAddFood" type="button">–î–æ–±–∞–≤–∏—Ç—å –≤ –¥–Ω–µ–≤–Ω–∏–∫</button>
      </div>
      <div class="row">
        <span class="small" id="foodHint">–ü–æ–¥—Å–∫–∞–∑–∫–∞: –≤—ã–±–µ—Ä–∏ –ø—Ä–æ–¥—É–∫—Ç –∏–∑ –±–∞–∑—ã ‚Äî –ë–ñ–£ –∏ –∫–∫–∞–ª –ø–æ–¥—Å—Ç–∞–≤—è—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.</span>
      </div>
      <div class="table-wrap" style="margin-top:6px;">
        <table>
          <thead>
          <tr>
            <th>–ü—Ä–æ–¥—É–∫—Ç</th>
            <th>–≥</th>
            <th>–ö–∫–∞–ª</th>
            <th>–ë</th>
            <th>–ñ</th>
            <th>–£</th>
            <th></th>
          </tr>
          </thead>
          <tbody id="foodTableBody">
          <tr><td colspan="7">–ü–æ–∫–∞ –Ω–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –¥–µ–Ω—å.</td></tr>
          </tbody>
        </table>
      </div>
      <div class="stats-grid" style="margin-top:8px;">
        <div class="stat-card">
          <div class="stat-label">–ö–∞–ª–æ—Ä–∏–π –∑–∞ –¥–µ–Ω—å</div>
          <div class="stat-value" id="dayCalStat">‚Äî</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">–ë–µ–ª–æ–∫ (–≥)</div>
          <div class="stat-value" id="dayProtStat">‚Äî</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">–ñ–∏—Ä—ã (–≥)</div>
          <div class="stat-value" id="dayFatStat">‚Äî</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">–£–≥–ª–µ–≤–æ–¥—ã (–≥)</div>
          <div class="stat-value" id="dayCarbStat">‚Äî</div>
        </div>
      </div>
    </div>

    <div class="section" id="foodDbSection" style="display:none;">
      <div class="section-title"><span class="icon">üìö</span>–ú–∏–Ω–∏-–±–∞–∑–∞ –ø—Ä–æ–¥—É–∫—Ç–æ–≤</div>
      <div class="section-sub">–ü—Ä–∏–º–µ—Ä —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –±–æ–ª—å—à–æ–π –±–∞–∑—ã. –°–µ–π—á–∞—Å –≤—Å—Ç—Ä–æ–µ–Ω—ã —Ç–æ–ª—å–∫–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤ (–∫–∞–ø—É—á–∏–Ω–æ, —Ç–æ–º —è–º –∏ —Ç.–¥.), –Ω–æ —Å–ø–∏—Å–æ–∫ –º–æ–∂–Ω–æ —Ä–∞—Å—à–∏—Ä–∏—Ç—å –≤ –∫–æ–¥–µ.</div>
      <div class="table-wrap">
        <table>
          <thead>
          <tr>
            <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
            <th>–ö–∫–∞–ª / 100–≥</th>
            <th>–ë</th>
            <th>–ñ</th>
            <th>–£</th>
            <th>–¢–∏–ø</th>
          </tr>
          </thead>
          <tbody id="foodDbBody"></tbody>
        </table>
      </div>
      <div class="small" style="margin-top:4px;">–≠—Ç—É –±–∞–∑—É –º–æ–∂–Ω–æ —Ä–∞—Å—à–∏—Ä–∏—Ç—å, –¥–æ–±–∞–≤–∏–≤ —Å–≤–æ–∏ –ø—Ä–æ–¥—É–∫—Ç—ã –≤ –±–ª–æ–∫–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∏–ª–∏ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–≤ JSON –≤ –∫–æ–¥–µ —Ñ–∞–π–ª–∞.</div>
    </div>

    <div class="section">
      <div class="section-title"><span class="icon">üîî</span>–õ–æ–∫–∞–ª—å–Ω—ã–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è</div>
      <div class="section-sub">–ú–æ–∂–Ω–æ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Å—Ç—ã–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –≤–Ω—É—Ç—Ä–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã (–æ–±–µ–¥, –≤–æ–¥–∞, –≤–∑–≤–µ—à–∏–≤–∞–Ω–∏–µ). –†–∞–±–æ—Ç–∞—é—Ç, –ø–æ–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –æ—Ç–∫—Ä—ã—Ç–∞.</div>
      <div class="row">
        <label>–°–æ–æ–±—â–µ–Ω–∏–µ
          <input type="text" id="reminderMsgInput" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, –∑–∞–ø–∏—Å–∞—Ç—å —É–∂–∏–Ω">
        </label>
        <label>–ß–µ—Ä–µ–∑ (–º–∏–Ω—É—Ç)
          <input type="number" id="reminderMinutesInput" min="1" value="30">
        </label>
        <button class="btn btn-secondary" id="btnSetReminder" type="button">–°–æ–∑–¥–∞—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ</button>
      </div>
      <div class="small" id="reminderStatus">–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –ø–æ—è–≤—è—Ç—Å—è —Å–≤–µ—Ä—Ö—É –∫–∞–∫ –≤—Å–ø–ª—ã–≤–∞—é—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ.</div>
    </div>
  </div>

  <!-- –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ -->
  <div class="tab-content" id="tab-analytics">
    <div class="section">
      <div class="section-title"><span class="icon">üìä</span>–ì—Ä–∞—Ñ–∏–∫–∏</div>
      <div class="section-sub">–ö–∞–ª–æ—Ä–∏–∏ vs —Ü–µ–ª—å, –¥–∏–Ω–∞–º–∏–∫–∞ –≤–µ—Å–∞, –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω—ã–π –¥–µ—Ñ–∏—Ü–∏—Ç/–ø—Ä–æ—Ñ–∏—Ü–∏—Ç –∏ –≤–æ–¥–∞.</div>
      <div class="charts-grid">
        <div class="chart-box">
          <div class="chart-title">–ö–∞–ª–æ—Ä–∏–∏ vs —Ü–µ–ª—å</div>
          <canvas id="chartCalories"></canvas>
        </div>
        <div class="chart-box">
          <div class="chart-title">–í–µ—Å –ø–æ –¥–Ω—è–º</div>
          <canvas id="chartWeight"></canvas>
        </div>
        <div class="chart-box">
          <div class="chart-title">–ù–∞–∫–æ–ø–ª–µ–Ω–Ω—ã–π –¥–µ—Ñ–∏—Ü–∏—Ç / –∂–∏—Ä (–∫–≥)</div>
          <canvas id="chartFat"></canvas>
        </div>
        <div class="chart-box">
          <div class="chart-title">–í–æ–¥–∞ –ø–æ –¥–Ω—è–º</div>
          <canvas id="chartWater"></canvas>
        </div>
      </div>
    </div>

    <div class="section">
      <div class="section-title"><span class="icon">üß¨</span>–ö–æ—Ä—Ä–µ–ª—è—Ü–∏–∏</div>
      <div class="section-sub">–ü—Ä–æ—Å—Ç–∞—è –æ—Ü–µ–Ω–∫–∞ —Å–≤—è–∑–∏ –º–µ–∂–¥—É –¥–µ—Ñ–∏—Ü–∏—Ç–æ–º/–ø—Ä–æ—Ñ–∏—Ü–∏—Ç–æ–º –∏ –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º –≤–µ—Å–∞.</div>
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-label">–ö–æ—Ä—Ä–µ–ª—è—Ü–∏—è: –¥–µ—Ñ–∏—Ü–∏—Ç ‚Üî Œî–≤–µ—Å–∞</div>
          <div class="stat-value" id="corrDeficitWeight">‚Äî</div>
          <div class="stat-note">–ß–µ–º –±–ª–∏–∂–µ –∫ ‚àí1, —Ç–µ–º —Å–∏–ª—å–Ω–µ–µ: –±–æ–ª—å—à–µ –¥–µ—Ñ–∏—Ü–∏—Ç ‚Üí —Å–∏–ª—å–Ω–µ–µ –ø–∞–¥–∞–µ—Ç –≤–µ—Å.</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">–°—Ä–µ–¥–Ω–∏–π –¥–µ—Ñ–∏—Ü–∏—Ç</div>
          <div class="stat-value" id="avgDeficit">‚Äî</div>
          <div class="stat-note">–û–∂–∏–¥–∞–µ–º–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤–µ—Å–∞.</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">–§–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –≤–µ—Å–∞</div>
          <div class="stat-value" id="weightDelta">‚Äî</div>
          <div class="stat-note">–û—Ç –ø–µ—Ä–≤–æ–π –∑–∞–ø–∏—Å–∏ –¥–æ –ø–æ—Å–ª–µ–¥–Ω–µ–π.</div>
        </div>
      </div>

      <div class="section-sub" style="margin-top:6px;">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ ‚Äú–ò–ò-—Å–æ–≤–µ—Ç–Ω–∏–∫–∞‚Äù –ø–æ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–º –¥–∞–Ω–Ω—ã–º:</div>
      <div class="ai-box" id="aiAnalyticsBox">
        <div class="ai-title"><span class="icon">ü§ñ</span>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ –ø—Ä–æ–≥—Ä–µ—Å—Å—É</div>
        <div class="ai-text" id="aiAnalyticsText">
          –ö–æ–≥–¥–∞ –±—É–¥–µ—Ç –Ω–∞–∫–æ–ø–ª–µ–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ –¥–Ω–µ–π —Å –≤–µ—Å–æ–º –∏ –∫–∞–ª–æ—Ä–∏—è–º–∏, –∑–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è: –Ω–∞—Å–∫–æ–ª—å–∫–æ —Ä–µ–∞–ª—å–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å —Ü–µ–ª–µ–≤—ã–º (‚àí0.5 –∫–≥/–Ω–µ–¥).
        </div>
      </div>
    </div>
  </div>

  <!-- –ò–º–ø–æ—Ä—Ç —à–∞–≥–æ–≤ / –∑–¥–æ—Ä–æ–≤—å—è -->
  <div class="tab-content" id="tab-import">
    <div class="section">
      <div class="section-title"><span class="icon">üì•</span>–ò–º–ø–æ—Ä—Ç –∏–∑ Apple –ó–¥–æ—Ä–æ–≤—å–µ (—ç–∫—Å–ø–æ—Ä—Ç XML)</div>
      <div class="section-sub">
        –ú–æ–∂–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å <code>export.xml</code> –∏–∑ Apple –ó–¥–æ—Ä–æ–≤—å–µ. –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–æ–ø—Ä–æ–±—É–µ—Ç –∏–∑–≤–ª–µ—á—å —à–∞–≥–∏ –∏ –∞–∫—Ç–∏–≤–Ω—É—é —ç–Ω–µ—Ä–≥–∏—é –ø–æ –¥–Ω—è–º, —á—Ç–æ–±—ã —Å–æ–ø–æ—Å—Ç–∞–≤–∏—Ç—å —Å –∫–∞–ª–æ—Ä–∏—è–º–∏.
      </div>
      <div class="row">
        <label>–§–∞–π–ª export.xml
          <input type="file" id="healthFileInput" accept=".xml">
        </label>
        <button class="btn btn-secondary" id="btnParseHealth" type="button">–†–∞–∑–æ–±—Ä–∞—Ç—å —Ñ–∞–π–ª</button>
      </div>
      <div class="table-wrap" style="margin-top:6px;max-height:220px;">
        <table>
          <thead>
          <tr>
            <th>–î–∞—Ç–∞</th>
            <th>–®–∞–≥–∏</th>
            <th>–ê–∫—Ç–∏–≤–Ω–∞—è —ç–Ω–µ—Ä–≥–∏—è, –∫–∫–∞–ª</th>
          </tr>
          </thead>
          <tbody id="healthTableBody">
          <tr><td colspan="3">–ü–æ–∫–∞ –Ω–µ—Ç –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.</td></tr>
          </tbody>
        </table>
      </div>
      <div class="small" style="margin-top:4px;">–≠—Ç–æ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏. –î–ª—è –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–≥–æ –≤–µ–¥–µ–Ω–∏—è –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –≤–∫–ª–∞–¥–æ–∫ –ü—Ä–æ—Ñ–∏–ª—å, –î–µ–Ω—å –∏ –ê–Ω–∞–ª–∏—Ç–∏–∫–∞.</div>
    </div>
  </div>

  <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ / —ç–∫—Å–ø–æ—Ä—Ç -->
  <div class="tab-content" id="tab-settings">
    <div class="section">
      <div class="section-title"><span class="icon">‚öôÔ∏è</span>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
      <div class="section-sub">–ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏ –±–∞–∑–∞ –ø—Ä–æ–¥—É–∫—Ç–æ–≤.</div>
      <div class="row">
        <label>–¶–µ–ª—å –ø–æ –≤–æ–¥–µ, –ª/–¥–µ–Ω—å
          <input type="number" id="waterGoalInput" step="0.1" min="0.5" value="2.5">
        </label>
        <button class="btn btn-secondary" id="btnSaveWaterGoal" type="button">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>

      <div class="section-sub" style="margin-top:6px;">–î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–≤–æ–∏—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –≤ –±–∞–∑—É:</div>
      <div class="row">
        <label>–ù–∞–∑–≤–∞–Ω–∏–µ
          <input type="text" id="customProdNameInput" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, —Å—ã—Ä –ì–∞—É–¥–∞">
        </label>
        <label>–ö–∫–∞–ª / 100 –≥
          <input type="number" id="customProdKcalInput" min="0">
        </label>
        <label>–ë / –ñ / –£ / 100 –≥
          <div style="display:flex;gap:4px;">
            <input type="number" id="customProdProtInput" min="0" style="width:60px;">
            <input type="number" id="customProdFatInput" min="0" style="width:60px;">
            <input type="number" id="customProdCarbInput" min="0" style="width:60px;">
          </div>
        </label>
        <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è
          <input type="text" id="customProdCatInput" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å—ã—Ä">
        </label>
      </div>
      <div class="row">
        <button class="btn btn-secondary" id="btnAddCustomProduct" type="button">–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç –≤ –±–∞–∑—É</button>
      </div>
    </div>

    <div class="section">
      <div class="section-title"><span class="icon">üì§</span>–≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</div>
      <div class="section-sub">–ú–æ–∂–Ω–æ –≤—ã–≥—Ä—É–∑–∏—Ç—å —Å—ã—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –≤ Excel / Python / Power BI.</div>
      <div class="row">
        <button class="btn btn-secondary" id="btnExportCsvAll" type="button">‚¨á –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∂—É—Ä–Ω–∞–ª (CSV)</button>
        <span class="small">–í–∫–ª—é—á–∞–µ—Ç: –¥–∞—Ç—É, –∫–∞–ª–æ—Ä–∏–∏, –ë–ñ–£, –≤–µ—Å, –≤–æ–¥—É, –¥–µ—Ñ–∏—Ü–∏—Ç, –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω—ã–π –∂–∏—Ä.</span>
      </div>
    </div>

    <div class="section">
      <div class="section-title"><span class="icon">üì∑</span>–§–æ—Ç–æ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ (–∑–∞–º–µ—Ç–∫–∞)</div>
      <div class="section-sub">–î–ª—è —É–¥–æ–±—Å—Ç–≤–∞ –º–æ–∂–Ω–æ –ø—Ä–∏–∫—Ä–µ–ø–ª—è—Ç—å —Ñ–æ—Ç–æ –ø—Ä–æ–¥—É–∫—Ç–∞ –∏–ª–∏ —ç—Ç–∏–∫–µ—Ç–∫–∏. –≠—Ç–æ –ø—Ä–æ—Å—Ç–æ –∑–∞–º–µ—Ç–∫–∞, —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –Ω–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è.</div>
      <div class="row">
        <label>–§–æ—Ç–æ –ø—Ä–æ–¥—É–∫—Ç–∞
          <input type="file" id="photoInput" accept="image/*" capture="environment">
        </label>
        <span class="small">–§–∞–π–ª –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç, –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è —Å–æ—Å—Ç–∞–≤–∞/—ç—Ç–∏–∫–µ—Ç–∫–∏.</span>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const STORAGE_KEY = 'nutri_cabinet_v1';

  // –ë–∞–∑–∞ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ (–º–æ–∂–Ω–æ —Ä–∞—Å—à–∏—Ä–∏—Ç—å)
  let foodDb = [
    { id: 'cappuccino', name: '–ö–∞–ø—É—á–∏–Ω–æ', kcal100: 60, protein100: 3.0, fat100: 2.5, carb100: 6.5, category: '–Ω–∞–ø–∏—Ç–æ–∫' },
    { id: 'poke_chicken', name: '–ü–æ–∫–µ —Å –∫—É—Ä–∏—Ü–µ–π', kcal100: 140, protein100: 10, fat100: 4, carb100: 15, category: '–æ—Å–Ω–æ–≤–Ω–æ–µ' },
    { id: 'roll_phila', name: '–†–æ–ª–ª –§–∏–ª–∞–¥–µ–ª—å—Ñ–∏—è', kcal100: 180, protein100: 8, fat100: 7, carb100: 22, category: '—Ä–æ–ª–ª' },
    { id: 'tom_yum', name: '–°—É–ø –¢–æ–º –Ø–º', kcal100: 75, protein100: 6, fat100: 4, carb100: 4, category: '—Å—É–ø' },
    { id: 'cheese_pie', name: '–ü–∏—Ä–æ–≥ —Å—ã—Ä–Ω—ã–π', kcal100: 320, protein100: 8, fat100: 20, carb100: 24, category: '–¥–µ—Å–µ—Ä—Ç' }
  ];

  let state = {
    profile: {
      age: 35,
      height: 180,
      weight: 75,
      activity: 1.55,
      bmr: null,
      tdee: null,
      targetCal: null,
      proteinTarget: null,
      fatTarget: null,
      carbTarget: null
    },
    waterGoal: 2.5,
    days: {}, // date -> {weight, water, foods:[{...}]}
    health: [], // [{date, steps, activeEnergy}]
  };

  let chartCalories = null;
  let chartWeight = null;
  let chartFat = null;
  let chartWater = null;

  const tabButtons = document.querySelectorAll('.tab-btn');
  const tabContents = document.querySelectorAll('.tab-content');
  tabButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      tabButtons.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      const id = btn.getAttribute('data-tab');
      tabContents.forEach(c => c.classList.remove('active'));
      document.getElementById(id).classList.add('active');
    });
  });

  const darkToggle = document.getElementById('darkToggle');
  darkToggle.addEventListener('click', () => {
    darkToggle.classList.toggle('on');
  });

  const ageInput = document.getElementById('ageInput');
  const heightInput = document.getElementById('heightInput');
  const weightInput = document.getElementById('weightInput');
  const activityInput = document.getElementById('activityInput');
  const bmrValueEl = document.getElementById('bmrValue');
  const tdeeValueEl = document.getElementById('tdeeValue');
  const targetCalValueEl = document.getElementById('targetCalValue');
  const profileErrorEl = document.getElementById('profileError');
  const statProteinTargetEl = document.getElementById('statProteinTarget');
  const statFatTargetEl = document.getElementById('statFatTarget');
  const statCarbTargetEl = document.getElementById('statCarbTarget');
  const aiProfileText = document.getElementById('aiProfileText');

  const dayDateInput = document.getElementById('dayDateInput');
  const btnToday = document.getElementById('btnToday');
  const dayWeightInput = document.getElementById('dayWeightInput');
  const waterInput = document.getElementById('waterInput');
  const dayErrorEl = document.getElementById('dayError');
  const foodSelectEl = document.getElementById('foodSelect');
  const foodDbSection = document.getElementById('foodDbSection');
  const btnToggleFoodDb = document.getElementById('btnToggleFoodDb');
  const foodDbBody = document.getElementById('foodDbBody');

  const foodNameInput = document.getElementById('foodNameInput');
  const foodGramInput = document.getElementById('foodGramInput');
  const foodKcal100Input = document.getElementById('foodKcal100Input');
  const foodProt100Input = document.getElementById('foodProt100Input');
  const foodFat100Input = document.getElementById('foodFat100Input');
  const foodCarb100Input = document.getElementById('foodCarb100Input');
  const foodKcalTotalInput = document.getElementById('foodKcalTotalInput');
  const foodHint = document.getElementById('foodHint');
  const foodTableBody = document.getElementById('foodTableBody');

  const dayCalStat = document.getElementById('dayCalStat');
  const dayProtStat = document.getElementById('dayProtStat');
  const dayFatStat = document.getElementById('dayFatStat');
  const dayCarbStat = document.getElementById('dayCarbStat');

  const btnSaveProfile = document.getElementById('btnSaveProfile');
  const btnSaveDayWeight = document.getElementById('btnSaveDayWeight');
  const btnSaveWater = document.getElementById('btnSaveWater');
  const btnAddFood = document.getElementById('btnAddFood');
  const btnRecalcFoodKcal = document.getElementById('btnRecalcFoodKcal');

  const reminderMsgInput = document.getElementById('reminderMsgInput');
  const reminderMinutesInput = document.getElementById('reminderMinutesInput');
  const btnSetReminder = document.getElementById('btnSetReminder');
  const reminderStatus = document.getElementById('reminderStatus');

  const chartCaloriesEl = document.getElementById('chartCalories');
  const chartWeightEl = document.getElementById('chartWeight');
  const chartFatEl = document.getElementById('chartFat');
  const chartWaterEl = document.getElementById('chartWater');

  const corrDeficitWeightEl = document.getElementById('corrDeficitWeight');
  const avgDeficitEl = document.getElementById('avgDeficit');
  const weightDeltaEl = document.getElementById('weightDelta');
  const aiAnalyticsText = document.getElementById('aiAnalyticsText');

  const healthFileInput = document.getElementById('healthFileInput');
  const btnParseHealth = document.getElementById('btnParseHealth');
  const healthTableBody = document.getElementById('healthTableBody');

  const waterGoalInput = document.getElementById('waterGoalInput');
  const btnSaveWaterGoal = document.getElementById('btnSaveWaterGoal');
  const customProdNameInput = document.getElementById('customProdNameInput');
  const customProdKcalInput = document.getElementById('customProdKcalInput');
  const customProdProtInput = document.getElementById('customProdProtInput');
  const customProdFatInput = document.getElementById('customProdFatInput');
  const customProdCarbInput = document.getElementById('customProdCarbInput');
  const customProdCatInput = document.getElementById('customProdCatInput');
  const btnAddCustomProduct = document.getElementById('btnAddCustomProduct');

  const btnExportCsvAll = document.getElementById('btnExportCsvAll');
  const btnExportHtml = document.getElementById('btnExportHtml');

  const photoInput = document.getElementById('photoInput');

  function loadState() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return;
      const data = JSON.parse(raw);
      if (!data) return;
      if (data.profile) state.profile = data.profile;
      if (typeof data.waterGoal === 'number') state.waterGoal = data.waterGoal;
      if (data.days) state.days = data.days;
      if (data.health) state.health = data.health;
      if (Array.isArray(data.foodDb)) foodDb = data.foodDb;
    } catch (e) {
      console.error('loadState error', e);
    }
  }

  function saveState() {
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify({
        profile: state.profile,
        waterGoal: state.waterGoal,
        days: state.days,
        health: state.health,
        foodDb
      }));
    } catch (e) {
      console.error('saveState error', e);
    }
  }

  function setToday() {
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2,'0');
    const day = String(d.getDate()).padStart(2,'0');
    dayDateInput.value = `${y}-${m}-${day}`;
  }

  function calcBmrMifflinMale(weight, height, age) {
    return 10 * weight + 6.25 * height - 5 * age + 5;
  }

  function recalcProfile() {
    const age = parseInt(ageInput.value, 10);
    const height = parseFloat(heightInput.value);
    const weight = parseFloat(weightInput.value);
    const activity = parseFloat(activityInput.value);
    if (isNaN(age) || isNaN(height) || isNaN(weight) || isNaN(activity)) {
      profileErrorEl.textContent = '–ó–∞–ø–æ–ª–Ω–∏ –≤–æ–∑—Ä–∞—Å—Ç, —Ä–æ—Å—Ç, –≤–µ—Å –∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å.';
      return;
    }
    profileErrorEl.textContent = '';
    const bmr = calcBmrMifflinMale(weight, height, age);
    const tdee = bmr * activity;
    const targetCal = tdee - 500; // ‚àí0.5 –∫–≥/–Ω–µ–¥

    const proteinMin = 1.6 * weight;
    const proteinMax = 2.2 * weight;
    const fatMin = 0.8 * weight;
    const fatMax = 1.0 * weight;
    const avgProtein = (proteinMin + proteinMax) / 2;
    const avgFat = (fatMin + fatMax) / 2;
    const kcalFromProtein = avgProtein * 4;
    const kcalFromFat = avgFat * 9;
    const carbsKcal = Math.max(targetCal - kcalFromProtein - kcalFromFat, 0);
    const carbsGram = carbsKcal / 4;

    state.profile = {
      age, height, weight, activity,
      bmr, tdee, targetCal,
      proteinTarget: avgProtein,
      fatTarget: avgFat,
      carbTarget: carbsGram
    };
    bmrValueEl.textContent = bmr.toFixed(0);
    tdeeValueEl.textContent = tdee.toFixed(0);
    targetCalValueEl.textContent = targetCal.toFixed(0);
    statProteinTargetEl.textContent = `${proteinMin.toFixed(0)}‚Äì${proteinMax.toFixed(0)} –≥`;
    statFatTargetEl.textContent = `${fatMin.toFixed(0)}‚Äì${fatMax.toFixed(0)} –≥`;
    statCarbTargetEl.textContent = `${carbsGram.toFixed(0)} –≥`;
    updateAiProfile();
    saveState();
    renderAll();
  }

  function fillProfileInputs() {
    const p = state.profile;
    ageInput.value = p.age ?? 35;
    heightInput.value = p.height ?? 180;
    weightInput.value = p.weight ?? 75;
    activityInput.value = p.activity ?? 1.55;
    if (p.bmr) bmrValueEl.textContent = p.bmr.toFixed(0);
    if (p.tdee) tdeeValueEl.textContent = p.tdee.toFixed(0);
    if (p.targetCal) targetCalValueEl.textContent = p.targetCal.toFixed(0);
    if (p.proteinTarget) {
      const proteinMin = 1.6 * p.weight;
      const proteinMax = 2.2 * p.weight;
      statProteinTargetEl.textContent = `${proteinMin.toFixed(0)}‚Äì${proteinMax.toFixed(0)} –≥`;
    }
    if (p.fatTarget) {
      const fatMin = 0.8 * p.weight;
      const fatMax = 1.0 * p.weight;
      statFatTargetEl.textContent = `${fatMin.toFixed(0)}‚Äì${fatMax.toFixed(0)} –≥`;
    }
    if (p.carbTarget) {
      statCarbTargetEl.textContent = `${p.carbTarget.toFixed(0)} –≥`;
    }
  }

  function updateAiProfile() {
    const p = state.profile;
    if (!p.bmr || !p.tdee || !p.targetCal) {
      aiProfileText.textContent = '–ó–∞–ø–æ–ª–Ω–∏ –ø—Ä–æ—Ñ–∏–ª—å –∏ —Ü–µ–ª—å, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –∫–∞–ª–æ—Ä–∏–π–Ω–æ—Å—Ç–∏ –∏ –ë–ñ–£.';
      return;
    }
    let text = `–¢–µ–∫—É—â–∏–π –≤–µ—Å: ~${p.weight.toFixed(1)} –∫–≥. –î–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –≤–µ—Å–∞ —Ç–µ–±–µ –Ω—É–∂–Ω–æ –æ–∫–æ–ª–æ ${p.tdee.toFixed(0)} –∫–∫–∞–ª –≤ –¥–µ–Ω—å. `;
    text += `–î–ª—è —Ü–µ–ª–∏ ‚àí0.5 –∫–≥ –≤ –Ω–µ–¥–µ–ª—é –¥–Ω–µ–≤–Ω–∞—è —Ü–µ–ª—å ‚Äî –ø—Ä–∏–º–µ—Ä–Ω–æ ${p.targetCal.toFixed(0)} –∫–∫–∞–ª.\n\n`;
    text += `–ü–æ –ë–ñ–£: —Å—Ç–æ–∏—Ç —Ü–µ–ª–∏—Ç—å—Å—è –ø—Ä–∏–º–µ—Ä–Ω–æ –≤ ${(p.proteinTarget ?? (1.9*p.weight)).toFixed(0)} –≥ –±–µ–ª–∫–∞, ${(p.fatTarget ?? (0.9*p.weight)).toFixed(0)} –≥ –∂–∏—Ä–æ–≤ –∏ ~${(p.carbTarget ?? 0).toFixed(0)} –≥ —É–≥–ª–µ–≤–æ–¥–æ–≤. `;
    text += `–ï—Å–ª–∏ —Ç—ã –±—É–¥–µ—à—å –¥–µ—Ä–∂–∞—Ç—å —Ç–∞–∫–æ–π –¥–µ—Ñ–∏—Ü–∏—Ç –∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å–ø–∞—Ç—å/–¥–≤–∏–≥–∞—Ç—å—Å—è, –æ–∂–∏–¥–∞–µ–º–æ–µ —Å–Ω–∏–∂–µ–Ω–∏–µ –≤–µ—Å–∞ ‚Äî –æ–∫–æ–ª–æ 0.5 –∫–≥ –≤ –Ω–µ–¥–µ–ª—é.`;
    aiProfileText.textContent = text;
  }

  function ensureDay(date) {
    if (!state.days[date]) {
      state.days[date] = { weight: null, water: 0, foods: [] };
    }
    return state.days[date];
  }

  function onDateChange() {
    const date = dayDateInput.value;
    if (!date) return;
    const day = ensureDay(date);
    dayWeightInput.value = day.weight != null ? day.weight : '';
    waterInput.value = (day.water ?? 0);
    renderDayFoods();
    renderDayStats();
  }

  function saveDayWeight() {
    const date = dayDateInput.value;
    if (!date) {
      dayErrorEl.textContent = '–í—ã–±–µ—Ä–∏ –¥–∞—Ç—É.';
      return;
    }
    const weight = parseFloat(dayWeightInput.value);
    if (isNaN(weight) || weight <= 0) {
      dayErrorEl.textContent = '–í–≤–µ–¥–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –≤–µ—Å.';
      return;
    }
    const day = ensureDay(date);
    day.weight = weight;
    state.profile.weight = weight;
    recalcProfile();
    dayErrorEl.textContent = '';
    saveState();
    renderAll();
  }

  function saveWater() {
    const date = dayDateInput.value;
    if (!date) {
      dayErrorEl.textContent = '–í—ã–±–µ—Ä–∏ –¥–∞—Ç—É.';
      return;
    }
    const water = parseFloat(waterInput.value);
    if (isNaN(water) || water < 0) {
      dayErrorEl.textContent = '–í–≤–µ–¥–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–æ–¥—ã.';
      return;
    }
    const day = ensureDay(date);
    day.water = water;
    dayErrorEl.textContent = '';
    saveState();
    renderAll();
  }

  function fillFoodSelect() {
    foodSelectEl.innerHTML = '<option value="">‚Äî –≤—ã–±—Ä–∞—Ç—å ‚Äî</option>';
    foodDb.forEach(prod => {
      const opt = document.createElement('option');
      opt.value = prod.id;
      opt.textContent = `${prod.name} (${prod.kcal100} –∫–∫–∞–ª/100–≥)`;
      foodSelectEl.appendChild(opt);
    });
  }

  function renderFoodDbTable() {
    foodDbBody.innerHTML = '';
    foodDb.forEach(prod => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${prod.name}</td>
        <td>${prod.kcal100}</td>
        <td>${prod.protein100}</td>
        <td>${prod.fat100}</td>
        <td>${prod.carb100}</td>
        <td>${prod.category || ''}</td>`;
      foodDbBody.appendChild(tr);
    });
  }

  foodSelectEl.addEventListener('change', () => {
    const id = foodSelectEl.value;
    if (!id) {
      foodNameInput.value = '';
      foodKcal100Input.value = 0;
      foodProt100Input.value = 0;
      foodFat100Input.value = 0;
      foodCarb100Input.value = 0;
      foodHint.textContent = '–í—ã–±–µ—Ä–∏ –ø—Ä–æ–¥—É–∫—Ç –∏–∑ –±–∞–∑—ã –∏–ª–∏ –∑–∞–ø–æ–ª–Ω–∏ —Å–≤–æ–∏ –∑–Ω–∞—á–µ–Ω–∏—è.';
      return;
    }
    const prod = foodDb.find(p => p.id === id);
    if (!prod) return;
    foodNameInput.value = prod.name;
    foodKcal100Input.value = prod.kcal100;
    foodProt100Input.value = prod.protein100;
    foodFat100Input.value = prod.fat100;
    foodCarb100Input.value = prod.carb100;
    recalcFoodKcal();
    foodHint.textContent = `–í—ã–±—Ä–∞–Ω: ${prod.name}. –ú–æ–∂–µ—à—å –∏–∑–º–µ–Ω–∏—Ç—å –≥—Ä–∞–º–º—ã ‚Äî –∫–∞–ª–æ—Ä–∏–π–Ω–æ—Å—Ç—å –ø–µ—Ä–µ—Å—á–∏—Ç–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.`;
  });

  btnToggleFoodDb.addEventListener('click', () => {
    const visible = foodDbSection.style.display !== 'none';
    foodDbSection.style.display = visible ? 'none' : 'block';
  });

  function recalcFoodKcal() {
    const grams = parseFloat(foodGramInput.value) || 0;
    const kcal100 = parseFloat(foodKcal100Input.value) || 0;
    const kcal = grams * kcal100 / 100;
    foodKcalTotalInput.value = kcal.toFixed(0);
  }

  btnRecalcFoodKcal.addEventListener('click', recalcFoodKcal);
  foodGramInput.addEventListener('input', recalcFoodKcal);
  foodKcal100Input.addEventListener('input', recalcFoodKcal);

  function addFood() {
    const date = dayDateInput.value;
    if (!date) {
      dayErrorEl.textContent = '–í—ã–±–µ—Ä–∏ –¥–∞—Ç—É.';
      return;
    }
    let name = foodNameInput.value.trim();
    const grams = parseFloat(foodGramInput.value);
    let kcal100 = parseFloat(foodKcal100Input.value);
    let prot100 = parseFloat(foodProt100Input.value);
    let fat100 = parseFloat(foodFat100Input.value);
    let carb100 = parseFloat(foodCarb100Input.value);
    let kcalTotal = parseFloat(foodKcalTotalInput.value);

    if (!name) {
      dayErrorEl.textContent = '–£–∫–∞–∂–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞.';
      return;
    }
    if (isNaN(grams) || grams <= 0) {
      dayErrorEl.textContent = '–£–∫–∞–∂–∏ –≥—Ä–∞–º–º—ã.';
      return;
    }
    if (isNaN(kcalTotal) || kcalTotal < 0) {
      dayErrorEl.textContent = '–ö–∞–ª–æ—Ä–∏–∏ —É–∫–∞–∑–∞–Ω—ã –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.';
      return;
    }
    if (isNaN(kcal100) || kcal100 <= 0) {
      kcal100 = kcalTotal * 100 / grams;
    }
    if (isNaN(prot100)) prot100 = 0;
    if (isNaN(fat100)) fat100 = 0;
    if (isNaN(carb100)) carb100 = 0;

    const day = ensureDay(date);
    day.foods.push({
      id: Date.now() + Math.random(),
      name,
      grams,
      kcal: kcalTotal,
      prot: prot100 * grams / 100,
      fat: fat100 * grams / 100,
      carb: carb100 * grams / 100
    });
    dayErrorEl.textContent = '';
    saveState();
    renderAll();
  }

  function renderDayFoods() {
    const date = dayDateInput.value;
    if (!date) {
      foodTableBody.innerHTML = '<tr><td colspan="7">–í—ã–±–µ—Ä–∏ –¥–∞—Ç—É.</td></tr>';
      return;
    }
    const day = ensureDay(date);
    if (!day.foods.length) {
      foodTableBody.innerHTML = '<tr><td colspan="7">–ü–æ–∫–∞ –Ω–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –¥–µ–Ω—å.</td></tr>';
      return;
    }
    foodTableBody.innerHTML = '';
    day.foods.forEach(f => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${f.name}</td>
        <td>${f.grams.toFixed(0)}</td>
        <td>${f.kcal.toFixed(0)}</td>
        <td>${f.prot.toFixed(1)}</td>
        <td>${f.fat.toFixed(1)}</td>
        <td>${f.carb.toFixed(1)}</td>
        <td><button class="btn btn-soft" data-id="${f.id}" data-action="delFood">‚úï</button></td>`;
      foodTableBody.appendChild(tr);
    });
    foodTableBody.querySelectorAll('button[data-action="delFood"]').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = btn.getAttribute('data-id');
        const d = ensureDay(date);
        d.foods = d.foods.filter(x => String(x.id) !== String(id));
        saveState();
        renderAll();
      });
    });
  }

  function renderDayStats() {
    const date = dayDateInput.value;
    if (!date) {
      dayCalStat.textContent = '‚Äî';
      dayProtStat.textContent = '‚Äî';
      dayFatStat.textContent = '‚Äî';
      dayCarbStat.textContent = '‚Äî';
      return;
    }
    const day = ensureDay(date);
    const sum = day.foods.reduce((acc, f) => {
      acc.kcal += f.kcal;
      acc.prot += f.prot;
      acc.fat += f.fat;
      acc.carb += f.carb;
      return acc;
    }, {kcal:0,prot:0,fat:0,carb:0});
    dayCalStat.textContent = sum.kcal.toFixed(0);
    dayProtStat.textContent = sum.prot.toFixed(0);
    dayFatStat.textContent = sum.fat.toFixed(0);
    dayCarbStat.textContent = sum.carb.toFixed(0);
  }

  function setReminder() {
    const msg = reminderMsgInput.value.trim() || '–ü–æ—Ä–∞ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–Ω–µ–≤–Ω–∏–∫ –ø–∏—Ç–∞–Ω–∏—è';
    const mins = parseInt(reminderMinutesInput.value, 10);
    if (isNaN(mins) || mins <= 0) {
      reminderStatus.textContent = '–£–∫–∞–∂–∏, —á–µ—Ä–µ–∑ —Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç –Ω–∞–ø–æ–º–Ω–∏—Ç—å.';
      return;
    }
    const ms = mins * 60000;
    reminderStatus.textContent = `–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ —á–µ—Ä–µ–∑ ${mins} –º–∏–Ω‚Ä¶`;
    setTimeout(() => {
      alert('–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ: ' + msg);
      reminderStatus.textContent = '–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ —Å—Ä–∞–±–æ—Ç–∞–ª–æ. –ú–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–µ.';
    }, ms);
  }

  function getDailySeries() {
    const dates = Object.keys(state.days).sort();
    const p = state.profile;
    const tdee = p.tdee || calcBmrMifflinMale(p.weight, p.height, p.age) * (p.activity || 1.55);
    const targetCal = p.targetCal || (tdee - 500);
    const arr = [];
    let cumDef = 0;
    let prevWeight = null;
    dates.forEach(d => {
      const day = state.days[d];
      const totalKcal = (day.foods || []).reduce((s,f)=>s+f.kcal,0);
      const deficit = totalKcal - targetCal;
      cumDef += deficit;
      const fatDeltaKg = deficit / 7700;
      const weight = day.weight != null ? day.weight : prevWeight;
      if (day.weight != null) prevWeight = day.weight;
      arr.push({
        date: d,
        kcal: totalKcal,
        deficit,
        cumDeficit: cumDef,
        fatDeltaKg,
        weight,
        water: day.water ?? 0,
        tdee,
        targetCal
      });
    });
    return arr;
  }

  function renderCharts() {
    if (chartCalories) chartCalories.destroy();
    if (chartWeight) chartWeight.destroy();
    if (chartFat) chartFat.destroy();
    if (chartWater) chartWater.destroy();

    const series = getDailySeries();
    if (!series.length) return;
    const labels = series.map(s => s.date);
    const kcalData = series.map(s => s.kcal);
    const targetData = series.map(s => s.targetCal);
    const tdeeData = series.map(s => s.tdee);

    chartCalories = new Chart(chartCaloriesEl, {
      type: 'line',
      data: {
        labels,
        datasets: [
          {
            label: '–°—ä–µ–¥–µ–Ω–æ, –∫–∫–∞–ª',
            data: kcalData,
            borderColor: '#38bdf8',
            backgroundColor: 'rgba(56,189,248,0.2)',
            borderWidth: 2,
            tension: 0.2,
            pointRadius: 2
          },
          {
            label: '–¶–µ–ª—å (‚àí0.5 –∫–≥/–Ω–µ–¥)',
            data: targetData,
            borderColor: '#f97316',
            borderDash: [6,4],
            borderWidth: 1.5,
            tension: 0,
            pointRadius: 0
          },
          {
            label: 'TDEE',
            data: tdeeData,
            borderColor: '#4b5563',
            borderDash: [4,4],
            borderWidth: 1,
            tension: 0,
            pointRadius: 0
          }
        ]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: true } },
        scales: {
          x: { ticks: { font: { size: 10 } } },
          y: { ticks: { font: { size: 10 } } }
        }
      }
    });

    const weightLabels = series.filter(s => s.weight != null).map(s => s.date);
    const weightData = series.filter(s => s.weight != null).map(s => s.weight);
    if (weightLabels.length) {
      chartWeight = new Chart(chartWeightEl, {
        type: 'line',
        data: {
          labels: weightLabels,
          datasets: [{
            label: '–í–µ—Å, –∫–≥',
            data: weightData,
            borderColor: '#22c55e',
            backgroundColor: 'rgba(34,197,94,0.25)',
            borderWidth: 2,
            tension: 0.2,
            pointRadius: 3
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: true } },
          scales: {
            x: { ticks: { font: { size: 10 } } },
            y: { ticks: { font: { size: 10 } } }
          }
        }
      });
    }

    const cumFatData = series.map(s => s.cumDeficit / 7700);
    chartFat = new Chart(chartFatEl, {
      type: 'line',
      data: {
        labels,
        datasets: [{
          label: '–ù–∞–∫–æ–ø–ª. –∏–∑–º–µ–Ω–µ–Ω–∏–µ –∂–∏—Ä–∞ (–∫–≥, —Ä–∞—Å—á—ë—Ç)',
          data: cumFatData,
          borderColor: '#e11d48',
          backgroundColor: 'rgba(225,29,72,0.25)',
          borderWidth: 2,
          tension: 0.2,
          pointRadius: 2
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: true } },
        scales: {
          x: { ticks: { font: { size: 10 } } },
          y: { ticks: { font: { size: 10 } } }
        }
      }
    });

    const waterData = series.map(s => s.water);
    const waterGoalData = series.map(() => state.waterGoal || 2.5);
    chartWater = new Chart(chartWaterEl, {
      type: 'bar',
      data: {
        labels,
        datasets: [
          {
            type: 'bar',
            label: '–í–æ–¥–∞, –ª',
            data: waterData,
            backgroundColor: 'rgba(56,189,248,0.5)'
          },
          {
            type: 'line',
            label: '–¶–µ–ª—å –ø–æ –≤–æ–¥–µ',
            data: waterGoalData,
            borderColor: '#1d4ed8',
            borderWidth: 1.5,
            borderDash: [5,3],
            pointRadius: 0,
            tension: 0
          }
        ]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: true } },
        scales: {
          x: { ticks: { font: { size: 10 } } },
          y: { ticks: { font: { size: 10 } } }
        }
      }
    });
  }

  function pearson(xs, ys) {
    const n = xs.length;
    if (n < 2) return NaN;
    const meanX = xs.reduce((s,v)=>s+v,0)/n;
    const meanY = ys.reduce((s,v)=>s+v,0)/n;
    let num = 0, denX = 0, denY = 0;
    for (let i=0;i<n;i++) {
      const dx = xs[i] - meanX;
      const dy = ys[i] - meanY;
      num += dx * dy;
      denX += dx*dx;
      denY += dy*dy;
    }
    const den = Math.sqrt(denX * denY);
    if (!den) return NaN;
    return num / den;
  }

  function renderAnalytics() {
    const series = getDailySeries();
    const def = [];
    const deltaWeight = [];
    let prevWeight = null;
    series.forEach(s => {
      if (s.weight != null && prevWeight != null) {
        def.push(s.deficit);
        deltaWeight.push(s.weight - prevWeight);
      }
      if (s.weight != null) prevWeight = s.weight;
    });
    if (def.length >= 2) {
      const corr = pearson(def, deltaWeight);
      corrDeficitWeightEl.textContent = corr.toFixed(3);
    } else {
      corrDeficitWeightEl.textContent = '‚Äî';
    }

    if (!series.length) {
      avgDeficitEl.textContent = '‚Äî';
      weightDeltaEl.textContent = '‚Äî';
      aiAnalyticsText.textContent = '–ü–æ–∫–∞ –º–∞–ª–æ –¥–∞–Ω–Ω—ã—Ö. –ó–∞–ø–∏—Å—ã–≤–∞–π –∫–∞–ª–æ—Ä–∏–∏ –∏ –≤–µ—Å —Ö–æ—Ç—è –±—ã –Ω–µ–¥–µ–ª—é, –∏ –∑–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è —Ä–∞–∑–±–æ—Ä –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Ü–µ–ª–∏ ‚àí0.5 –∫–≥/–Ω–µ–¥.';
      return;
    }

    const avgDef = series.reduce((s,v)=>s+v.deficit,0)/series.length;
    avgDeficitEl.textContent = avgDef.toFixed(0) + ' –∫–∫–∞–ª/–¥–µ–Ω—å';
    const firstWeight = series.find(s => s.weight != null)?.weight;
    const lastWeight = [...series].reverse().find(s => s.weight != null)?.weight;
    if (firstWeight != null && lastWeight != null) {
      const delta = lastWeight - firstWeight;
      weightDeltaEl.textContent = delta.toFixed(2) + ' –∫–≥';
    } else {
      weightDeltaEl.textContent = '‚Äî';
    }

    let text = '';
    if (firstWeight != null && lastWeight != null) {
      const days = series.length;
      const weeks = days / 7;
      const expectedDeltaKg = (avgDef * days) / 7700;
      text += `–ó–∞ –ø–µ—Ä–∏–æ–¥ —Å ${series[0].date} –ø–æ ${series[series.length-1].date} –ø—Ä–æ—à–ª–æ –æ–∫–æ–ª–æ ${weeks.toFixed(1)} –Ω–µ–¥–µ–ª—å.\n`;
      text += `–°—Ä–µ–¥–Ω–∏–π –¥–Ω–µ–≤–Ω–æ–π –¥–µ—Ñ–∏—Ü–∏—Ç/–ø—Ä–æ—Ñ–∏—Ü–∏—Ç: ${avgDef.toFixed(0)} –∫–∫–∞–ª.\n`;
      text += `–ü–æ —Ä–∞—Å—á—ë—Ç–∞–º, –æ–∂–∏–¥–∞–µ–º–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –∂–∏—Ä–∞: ${expectedDeltaKg.toFixed(2)} –∫–≥.\n`;
      text += `–§–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –≤–µ—Å–∞: ${(lastWeight-firstWeight).toFixed(2)} –∫–≥.\n\n`;
      if (!isNaN(expectedDeltaKg)) {
        const diff = (lastWeight-firstWeight) - expectedDeltaKg;
        if (Math.abs(diff) < 0.5) {
          text += '–§–∞–∫—Ç–∏—á–µ—Å–∫–∞—è –¥–∏–Ω–∞–º–∏–∫–∞ –≤–µ—Å–∞ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–ª–∏–∑–∫–∞ –∫ —Ç–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏ –æ–∂–∏–¥–∞–µ–º–æ–π. –°–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ, —Ü–µ–ª—å –ø–æ –¥–µ—Ñ–∏—Ü–∏—Ç—É –≤—ã–±—Ä–∞–Ω–∞ –∞–¥–µ–∫–≤–∞—Ç–Ω–æ.';
        } else if ((lastWeight-firstWeight) < expectedDeltaKg) {
          text += '–í–µ—Å –ø–∞–¥–∞–µ—Ç —á—É—Ç—å –º–µ–¥–ª–µ–Ω–Ω–µ–µ, —á–µ–º –ø—Ä–æ–≥–Ω–æ–∑ –ø–æ –∫–∞–ª–æ—Ä–∏—è–º. –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã: –ø–æ–≥—Ä–µ—à–Ω–æ—Å—Ç–∏ –≤ —É—á—ë—Ç–µ –µ–¥—ã, –∑–∞–¥–µ—Ä–∂–∫–∞ –∂–∏–¥–∫–æ—Å—Ç–∏, –Ω–µ–¥–æ—Å—ã–ø –∏–ª–∏ –≥–æ—Ä–º–æ–Ω–∞–ª—å–Ω—ã–µ —Ñ–∞–∫—Ç–æ—Ä—ã.';
        } else {
          text += '–í–µ—Å —Å–Ω–∏–∂–∞–µ—Ç—Å—è –±—ã—Å—Ç—Ä–µ–µ –∏–ª–∏ –¥–∞–∂–µ —Ä–∞—Å—Ç—ë—Ç –ø—Ä–∏ –¥–µ—Ñ–∏—Ü–∏—Ç–µ. –°—Ç–æ–∏—Ç –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–æ—á–Ω–æ—Å—Ç—å —É—á—ë—Ç–∞ –µ–¥—ã, –≤–µ—Å–æ–≤ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –∏ –≤–æ–∑–º–æ–∂–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏.';
        }
      }
    } else {
      text = '–ü–æ–∫–∞ –º–∞–ª–æ —Ç–æ—á–µ–∫ —Å –≤–µ—Å–æ–º. –ó–∞–ø–∏—Å—ã–≤–∞–π –≤–µ—Å —Ö–æ—Ç—è –±—ã –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ –≤ –Ω–µ–¥–µ–ª—é, —á—Ç–æ–±—ã —Å—Ä–∞–≤–Ω–∏—Ç—å –¥–∏–Ω–∞–º–∏–∫—É —Å –∫–∞–ª–æ—Ä–∏–π–Ω–æ—Å—Ç—å—é.';
    }
    aiAnalyticsText.textContent = text;
  }

  function parseHealthXml(text) {
    const parser = new DOMParser();
    const xmlDoc = parser.parseFromString(text, 'text/xml');
    const recordNodes = Array.from(xmlDoc.getElementsByTagName('Record'));
    const daily = {};
    recordNodes.forEach(node => {
      const type = node.getAttribute('type') || '';
      const startDate = node.getAttribute('startDate') || '';
      const value = parseFloat(node.getAttribute('value') || '0');
      if (!startDate || isNaN(value)) return;
      const date = startDate.split(' ')[0];
      if (!daily[date]) daily[date] = { steps:0, activeEnergy:0 };
      if (type.includes('StepCount')) daily[date].steps += value;
      if (type.includes('ActiveEnergyBurned')) daily[date].activeEnergy += value;
    });
    state.health = Object.keys(daily).sort().map(d => ({
      date: d,
      steps: daily[d].steps,
      activeEnergy: daily[d].activeEnergy
    }));
    saveState();
    renderHealthTable();
  }

  function renderHealthTable() {
    if (!state.health.length) {
      healthTableBody.innerHTML = '<tr><td colspan="3">–ü–æ–∫–∞ –Ω–µ—Ç –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.</td></tr>';
      return;
    }
    healthTableBody.innerHTML = '';
    state.health.forEach(h => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${h.date}</td><td>${h.steps.toFixed(0)}</td><td>${h.activeEnergy.toFixed(0)}</td>`;
      healthTableBody.appendChild(tr);
    });
  }

  function saveWaterGoal() {
    const g = parseFloat(waterGoalInput.value);
    if (isNaN(g) || g <= 0) return;
    state.waterGoal = g;
    saveState();
    renderAll();
  }

  function addCustomProduct() {
    const name = customProdNameInput.value.trim();
    const kcal = parseFloat(customProdKcalInput.value);
    const prot = parseFloat(customProdProtInput.value);
    const fat = parseFloat(customProdFatInput.value);
    const carb = parseFloat(customProdCarbInput.value);
    const cat = customProdCatInput.value.trim() || '–¥—Ä—É–≥–æ–µ';
    if (!name || isNaN(kcal)) return;
    const id = 'custom_' + Date.now();
    foodDb.push({
      id,
      name,
      kcal100: isNaN(kcal)?0:kcal,
      protein100: isNaN(prot)?0:prot,
      fat100: isNaN(fat)?0:fat,
      carb100: isNaN(carb)?0:carb,
      category: cat
    });
    saveState();
    fillFoodSelect();
    renderFoodDbTable();
    customProdNameInput.value = '';
    customProdKcalInput.value = '';
    customProdProtInput.value = '';
    customProdFatInput.value = '';
    customProdCarbInput.value = '';
    customProdCatInput.value = '';
  }

  function exportCsvAll() {
    const series = getDailySeries();
    if (!series.length) {
      alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞.');
      return;
    }
    const header = ['date','weight','kcal','deficit','cumDeficit','cumFatKg','water'];
    const lines = [header.join(',')];
    series.forEach(s => {
      const row = [
        s.date,
        s.weight != null ? s.weight.toFixed(2) : '',
        s.kcal.toFixed(0),
        s.deficit.toFixed(0),
        s.cumDeficit.toFixed(0),
        (s.cumDeficit/7700).toFixed(3),
        s.water.toFixed(2)
      ];
      lines.push(row.join(','));
    });
    const csv = lines.join('\n');
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'nutri_journal.csv';
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  function exportHtmlReport() {
    const series = getDailySeries();
    const p = state.profile;
    let html = '<!DOCTYPE html><html><head><meta charset="UTF-8"><title>–ù—É—Ç—Ä–∏-–æ—Ç—á—ë—Ç</title>';
    html += '<style>body{font-family:system-ui,sans-serif;background:#0f172a;color:#e5e7eb;padding:16px;max-width:900px;margin:0 auto}h1,h2{color:#f9fafb}table{border-collapse:collapse;width:100%;margin-top:8px;font-size:13px}th,td{border:1px solid #1f2937;padding:4px 6px}th{background:#111827}</style>';
    html += '</head><body>';
    html += '<h1>–ù—É—Ç—Ä–∏-–æ—Ç—á—ë—Ç</h1>';
    html += `<p><b>–í–æ–∑—Ä–∞—Å—Ç:</b> ${p.age ?? ''}, <b>–†–æ—Å—Ç:</b> ${p.height ?? ''} —Å–º, <b>–í–µ—Å:</b> ${p.weight ?? ''} –∫–≥</p>`;
    if (p.bmr) html += `<p><b>BMR:</b> ${p.bmr.toFixed(0)} –∫–∫–∞–ª, <b>TDEE:</b> ${p.tdee.toFixed(0)} –∫–∫–∞–ª, <b>–¶–µ–ª—å:</b> ${p.targetCal.toFixed(0)} –∫–∫–∞–ª.</p>`;

    html += '<h2>–î–Ω–µ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</h2>';
    if (!series.length) {
      html += '<p>–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π.</p>';
    } else {
      html += '<table><thead><tr><th>–î–∞—Ç–∞</th><th>–í–µ—Å</th><th>–ö–∫–∞–ª</th><th>–î–µ—Ñ–∏—Ü–∏—Ç</th><th>–ù–∞–∫–æ–ø–ª. –¥–µ—Ñ–∏—Ü–∏—Ç</th><th>–ù–∞–∫–æ–ø–ª. –∂–∏—Ä (–∫–≥)</th><th>–í–æ–¥–∞, –ª</th></tr></thead><tbody>';
      series.forEach(s => {
        html += `<tr><td>${s.date}</td><td>${s.weight!=null?s.weight.toFixed(1):''}</td><td>${s.kcal.toFixed(0)}</td><td>${s.deficit.toFixed(0)}</td><td>${s.cumDeficit.toFixed(0)}</td><td>${(s.cumDeficit/7700).toFixed(3)}</td><td>${s.water.toFixed(2)}</td></tr>`;
      });
      html += '</tbody></table>';
    }

    html += '<h2>–ö—Ä–∞—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ</h2>';
    html += `<p>${aiProfileText.textContent.replace(/\n/g,'<br>')}</p>`;
    html += `<p>${aiAnalyticsText.textContent.replace(/\n/g,'<br>')}</p>`;
    html += '</body></html>';

    const blob = new Blob([html], { type: 'text/html;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'nutri_report.html';
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  btnSaveProfile.addEventListener('click', recalcProfile);
  btnToday.addEventListener('click', () => { setToday(); onDateChange(); });
  dayDateInput.addEventListener('change', onDateChange);
  btnSaveDayWeight.addEventListener('click', saveDayWeight);
  btnSaveWater.addEventListener('click', saveWater);
  btnAddFood.addEventListener('click', addFood);
  btnSetReminder.addEventListener('click', setReminder);
  btnSaveWaterGoal.addEventListener('click', saveWaterGoal);
  btnAddCustomProduct.addEventListener('click', addCustomProduct);
  btnExportCsvAll.addEventListener('click', exportCsvAll);
  btnExportHtml.addEventListener('click', exportHtmlReport);

  btnParseHealth.addEventListener('click', () => {
    const file = healthFileInput.files && healthFileInput.files[0];
    if (!file) { alert('–í—ã–±–µ—Ä–∏ —Ñ–∞–π–ª export.xml'); return; }
    const reader = new FileReader();
    reader.onload = () => {
      try {
        parseHealthXml(reader.result);
      } catch (e) {
        console.error(e);
        alert('–û—à–∏–±–∫–∞ —Ä–∞–∑–±–æ—Ä–∞ XML.');
      }
    };
    reader.readAsText(file);
  });

  photoInput.addEventListener('change', () => {
    if (photoInput.files && photoInput.files[0]) {
      alert('–§–æ—Ç–æ –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–æ –∫–∞–∫ –∑–∞–º–µ—Ç–∫–∞. –û–Ω–æ –Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –Ω–∏–∫—É–¥–∞ –∏ –Ω–µ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è.');
    }
  });

  function renderAll() {
    renderDayFoods();
    renderDayStats();
    renderCharts();
    renderAnalytics();
    renderHealthTable();
  }

  loadState();
  fillProfileInputs();
  waterGoalInput.value = state.waterGoal ?? 2.5;
  setToday();
  fillFoodSelect();
  renderFoodDbTable();
  updateAiProfile();
  onDateChange();
  renderAll();
</script>
</body>
</html>